
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.27.0" theme-name="Stellar" theme-version="1.27.0">
  
  <meta name="generator" content="Hexo 7.1.1">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  
  <title>MiddlewareDocsï¼šäºŒ. Nginx é…ç½®æ–‡ä»¶è¯¦è§£ - SafeKiller Zone</title>

  
    <meta name="description" content="æ€»å­—ç¬¦æ•°: 33.74K                ä»£ç : 21.74K, æ–‡æœ¬: 8.64K               é¢„è®¡é˜…è¯»æ—¶é—´: 2.20 å°æ—¶            Nginx é…ç½® Nginx çš„é»˜è®¤é…ç½®æ–‡ä»¶ä¸º nginx.conf.  nginx -c xxx.conf - ä»¥æŒ‡å®šçš„æ–‡ä»¶ä½œä¸ºé…ç½®æ–‡ä»¶,å¯åŠ¨ Nginx.   é…ç½®æ–‡ä»¶å®ä¾‹ä»¥ä¸‹ä¸ºä¸€ä¸ª nginx.conf">
<meta property="og:type" content="website">
<meta property="og:title" content="äºŒ. Nginx é…ç½®æ–‡ä»¶è¯¦è§£">
<meta property="og:url" content="https://jiangjiyue.github.io/wiki/MiddlewareDocs/%E4%BA%8C.%20Nginx%20%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3.html">
<meta property="og:site_name" content="SafeKiller Zone">
<meta property="og:description" content="æ€»å­—ç¬¦æ•°: 33.74K                ä»£ç : 21.74K, æ–‡æœ¬: 8.64K               é¢„è®¡é˜…è¯»æ—¶é—´: 2.20 å°æ—¶            Nginx é…ç½® Nginx çš„é»˜è®¤é…ç½®æ–‡ä»¶ä¸º nginx.conf.  nginx -c xxx.conf - ä»¥æŒ‡å®šçš„æ–‡ä»¶ä½œä¸ºé…ç½®æ–‡ä»¶,å¯åŠ¨ Nginx.   é…ç½®æ–‡ä»¶å®ä¾‹ä»¥ä¸‹ä¸ºä¸€ä¸ª nginx.conf">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-01-26T02:43:45.000Z">
<meta property="article:modified_time" content="2024-02-09T08:13:36.000Z">
<meta property="article:author" content="Kill3r">
<meta property="article:tag" content="å®‰å…¨è¿ç»´">
<meta property="article:tag" content="ä¸­é—´ä»¶">
<meta property="article:tag" content="NetOps">
<meta property="article:tag" content="Nginx">
<meta name="twitter:card" content="summary">
  
  
  
  <meta name="keywords" content=",,,">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="SafeKiller Zone" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.27.0">

  
    <link rel="shortcut icon" href="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202401260729165.jpg">
  

  

  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" /><link rel="stylesheet" href="/css/darkmode.css">
</head>
<body>



<div class="l_body s:aa content tech" id="start" layout="wiki" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><div class="icon"><img no-lazy class="icon" src="https://wordpress-1258894728.cos.ap-beijing.myqcloud.com/202401260737265.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.9/image/2659360.svg';"></div><a class="title" href="/wiki/MiddlewareDocs/%E4%B8%80.%20Nginx%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A(%E4%B8%8A).html"><div class="main" ff="title">MiddlewareDocs</div><div class="sub normal cap">ä¸“ä¸šç¯‡</div><div class="sub hover cap" style="opacity:0"> æ¶µç›–å®‰è£…ã€é…ç½®ã€ä¼˜åŒ–å’Œç®¡ç†</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" data-filter="/wiki/MiddlewareDocs" placeholder="æœç´¢ä¸­é—´ä»¶æ–‡æ¡£..."></form><div id="search-result"></div><div class="search-no-result">æ²¡æœ‰æ‰¾åˆ°å†…å®¹ï¼</div></div>


<nav class="menu dis-select"><a class="nav-item" title="åšå®¢" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item active" title="æ–‡æ¡£" href="/wiki/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="å¯¼èˆª" href="/sites/" style="color:#FA6400"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M20 12a8 8 0 1 1-16 0a8 8 0 0 1 16 0" opacity=".5"/><path fill="currentColor" d="M17.712 5.453c1.047-.193 2.006-.259 2.797-.152c.77.103 1.536.393 1.956 1.064c.446.714.312 1.542-.012 2.258c-.33.728-.918 1.499-1.672 2.268c-1.516 1.547-3.836 3.226-6.597 4.697c-2.763 1.472-5.495 2.484-7.694 2.92c-1.095.217-2.098.299-2.923.201c-.8-.095-1.6-.383-2.032-1.075c-.47-.752-.296-1.63.07-2.379c.375-.768 1.032-1.586 1.872-2.403L4 12.416c0 .219.083.71.168 1.146c.045.23.09.444.123.596c-.652.666-1.098 1.263-1.339 1.756c-.277.567-.208.825-.145.925c.072.116.305.305.937.38c.609.073 1.44.018 2.455-.183c2.02-.4 4.613-1.351 7.28-2.772c2.667-1.42 4.85-3.015 6.23-4.423c.694-.707 1.15-1.334 1.377-1.836c.233-.515.167-.75.107-.844c-.07-.112-.289-.294-.883-.374c-.542-.072-1.272-.041-2.163.112L16.87 5.656c.338-.101.658-.17.842-.203"/></svg></a><a class="nav-item" title="ç¤¾äº¤" href="/friends/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a><a class="nav-item" title="æ›´å¤š" href="/tools/" style="color:#d55afa"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2s10 4.477 10 10" opacity=".5"/><path fill="currentColor" d="M12.75 9a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V15a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25z"/></svg></a></nav>
</div>
<div class="widgets">

<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">Nginx</span></div><div class="widget-body fs14"><a class="link" href="/wiki/MiddlewareDocs/%E4%B8%80.%20Nginx%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A(%E4%B8%8A).html#start"><span class="toc-text">ä¸€. Nginxä»å…¥é—¨åˆ°ç²¾é€š(ä¸Š)</span></a><a class="link" href="/wiki/MiddlewareDocs/%E4%B8%80.%20Nginx%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A(%E4%B8%8B).html"><span class="toc-text">ä¸€. Nginxä»å…¥é—¨åˆ°ç²¾é€š(ä¸‹)</span></a><a class="link active" href="/wiki/MiddlewareDocs/%E4%BA%8C.%20Nginx%20%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3.html"><span class="toc-text">äºŒ. Nginx é…ç½®æ–‡ä»¶è¯¦è§£</span><svg class="active-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M21 11.098v4.993c0 3.096 0 4.645-.734 5.321c-.35.323-.792.526-1.263.58c-.987.113-2.14-.907-4.445-2.946c-1.02-.901-1.529-1.352-2.118-1.47a2.225 2.225 0 0 0-.88 0c-.59.118-1.099.569-2.118 1.47c-2.305 2.039-3.458 3.059-4.445 2.945a2.238 2.238 0 0 1-1.263-.579C3 20.736 3 19.188 3 16.091v-4.994C3 6.81 3 4.666 4.318 3.333C5.636 2 7.758 2 12 2c4.243 0 6.364 0 7.682 1.332C21 4.665 21 6.81 21 11.098" opacity=".5"/><path fill="currentColor" d="M9 5.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5z"/></svg></a><a class="link" href="/wiki/MiddlewareDocs/%E4%B8%89.%20Nginx-Examples%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E.html"><span class="toc-text">ä¸‰. Nginx-Examplesä½¿ç”¨è¯´æ˜</span></a></div><div class="widget-header dis-select"><span class="name">Apache</span></div><div class="widget-body fs14"><a class="link" href="/wiki/MiddlewareDocs/%E5%9B%9B.%20Apache%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A.html"><span class="toc-text">å››. Apacheä»å…¥é—¨åˆ°ç²¾é€š</span></a></div><div class="widget-header dis-select"><span class="name">Tomcat</span></div><div class="widget-body fs14"><a class="link" href="/wiki/MiddlewareDocs/%E4%BA%94.%20Tomcat%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A.html"><span class="toc-text">äº”. Tomcatä»å…¥é—¨åˆ°ç²¾é€š</span></a></div></widget>

<widget class="widget-wrapper post-card"><div class="widget-header dis-select"><span class="name">æ›´å¤šï¼šDevOps</span></div><div class="widget-body"><a class="item wiki" href="/wiki/API-Gateway/%E4%B8%80.%20%E6%BC%AB%E8%B0%88Nginx%E7%BD%91%E5%85%B3.html"><span class="title">å¾®æœåŠ¡APIç½‘å…³æ¡†æ¶</span><span class="excerpt">æ¢ç´¢å¾®æœåŠ¡APIç½‘å…³çš„ä¸–ç•Œ - æˆ‘çš„å­¦ä¹ å’Œå®è·µç¬”è®°ã€‚ä¸€èµ·å­¦ä¹ å¦‚ä½•è®¾è®¡ã€æ­å»ºå¹¶ä¼˜åŒ–APIç½‘å…³ã€‚</span></a><a class="item wiki" href="/wiki/MonitoringTechDocs/%E4%B8%80.%20Zabbix%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8.html"><span class="title">ç›‘æ§ç³»ç»ŸæŠ€æœ¯æ¡†æ¶</span><span class="excerpt">æ¢ç´¢ç›‘æ§ç³»ç»ŸæŠ€æœ¯çš„ä¸–ç•Œ - å­¦ä¹ å’Œå®è·µç¬”è®°ã€‚ä¸€èµ·å­¦ä¹ å¦‚ä½•è®¾è®¡ã€éƒ¨ç½²å¹¶ä¼˜åŒ–ç›‘æ§ç¯å¢ƒã€‚</span></a><a class="item wiki" href="/wiki/VirtDocs/%E4%B8%80.%20Esxi%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B.html"><span class="title">è™šæ‹ŸåŒ–æŠ€æœ¯æ¡†æ¶</span><span class="excerpt">æ¢ç´¢è™šæ‹ŸåŒ–æŠ€æœ¯çš„ä¸–ç•Œ - æˆ‘çš„å­¦ä¹ å’Œå®è·µç¬”è®°ã€‚ä¸€èµ·å­¦ä¹ å¦‚ä½•è®¾è®¡ã€éƒ¨ç½²å¹¶ä¼˜åŒ–è™šæ‹ŸåŒ–ç¯å¢ƒã€‚</span></a></div></widget>

<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">æœ€è¿‘æ›´æ–°</span><a class="cap-action" id="rss" title="Subscribe" href="/atom.xml"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M5 21q-.825 0-1.412-.587T3 19q0-.825.588-1.412T5 17q.825 0 1.413.588T7 19q0 .825-.587 1.413T5 21m13.5 0q-.65 0-1.088-.475T16.9 19.4q-.275-2.425-1.312-4.537T12.9 11.1q-1.65-1.65-3.762-2.687T4.6 7.1q-.65-.075-1.125-.512T3 5.5q0-.65.45-1.062t1.075-.363q3.075.275 5.763 1.563t4.737 3.337q2.05 2.05 3.338 4.738t1.562 5.762q.05.625-.363 1.075T18.5 21m-6 0q-.625 0-1.075-.437T10.85 19.5q-.225-1.225-.787-2.262T8.65 15.35q-.85-.85-1.888-1.412T4.5 13.15q-.625-.125-1.062-.575T3 11.5q0-.65.45-1.075t1.075-.325q1.825.25 3.413 1.063t2.837 2.062q1.25 1.25 2.063 2.838t1.062 3.412q.1.625-.325 1.075T12.5 21"/></svg></a></div><div class="widget-body fs14"><a class="item title" href="/wiki/VirtDocs/%E4%B8%89.%20%E5%A4%A7%E5%9E%8B%E5%88%86%E5%B8%83%E5%BC%8Fk8s%E9%9B%86%E7%BE%A4%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A.html"><span class="title"><strong>VirtDocs</strong><span class="dot"></span>ä¸‰. å¤§å‹åˆ†å¸ƒå¼k8sé›†ç¾¤ä»å…¥é—¨åˆ°ç²¾é€š</span></a><a class="item title" href="/wiki/VulnerabilityInsightDocs/%E4%BA%94.%20XSS%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC.html"><span class="title"><strong>VulnerabilityInsightDocs</strong><span class="dot"></span>äº”. XSSè·¨ç«™è„šæœ¬</span></a><a class="item title" href="/wiki/VirtDocs/%E4%BA%8C.%20Docker%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A.html"><span class="title"><strong>VirtDocs</strong><span class="dot"></span>äºŒ. Dockerä»å…¥é—¨åˆ°ç²¾é€š</span></a><a class="item title" href="/wiki/VulnerabilityInsightDocs/%E4%BA%8C.%20%E5%9C%A8%E7%BA%BF%E5%AF%86%E7%A0%81%E7%A0%B4%E8%A7%A3.html"><span class="title"><strong>VulnerabilityInsightDocs</strong><span class="dot"></span>äºŒ. åœ¨çº¿å¯†ç ç ´è§£</span></a><a class="item title" href="/wiki/VulnerabilityInsightDocs/%E5%8D%81%E5%9B%9B.%20%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E.html"><span class="title"><strong>VulnerabilityInsightDocs</strong><span class="dot"></span>åå››. é€»è¾‘æ¼æ´</span></a></div></widget>
</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/JiangJiYue/" target="_blank" rel="external nofollow noopener noreferrer"><i class="fa-brands fa-github"></i></a><a class="social" href="javaScript:hud.toast('ä½ åœ¨å¬ğŸµå•¦å•¦å•¦~');" rel="noopener noreferrer"><i class="fa-solid fa-music"></i></a><a class="social" href="https://space.bilibili.com/238008115" target="_blank" rel="external nofollow noopener noreferrer"><i class="fa-brands fa-bilibili fa-bounce"></i></a><a class="social" href="/atom.xml" rel="noopener noreferrer"><i class="fa-solid fa-rss fa-shake"></i></a><a class="social" href="/comments/" rel="noopener noreferrer"><i class="fa-regular fa-comment-dots"></i></a><a class="social" href="javaScript:void(0);" rel="noopener noreferrer"><i class="fa-solid fa-circle-half-stroke fa-flip"></i></a></div></footer>
</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">ä¸»é¡µ</a>
<span class="sep"></span><a class="cap breadcrumb" id="menu" href="/wiki">æ–‡æ¡£</a><span class="sep"></span><a class="cap breadcrumb" id="proj" href="/wiki/MiddlewareDocs/%E4%B8%80.%20Nginx%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A(%E4%B8%8A).html">MiddlewareDocs</a></div>
<div class="flex-row" id="post-meta"><span class="text created">æ›´æ–°äºï¼š<time datetime="2024-02-09T08:13:36.000Z">2024-02-09</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>äºŒ. Nginx é…ç½®æ–‡ä»¶è¯¦è§£</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><div class="tag-plugin grid" bg="card" style="grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));"><div class="cell" style="">
    <p>æ€»å­—ç¬¦æ•°: 33.74K </p>
    </div>
    <div class="cell" style="">
    <p>ä»£ç : 21.74K, æ–‡æœ¬: 8.64K</p>
    </div>
    <div class="cell" style="">
    <p>é¢„è®¡é˜…è¯»æ—¶é—´: 2.20 å°æ—¶</p>
    </div>
    </div>

<h1 id="Nginx-é…ç½®"><a href="#Nginx-é…ç½®" class="headerlink" title="Nginx é…ç½®"></a>Nginx é…ç½®</h1><blockquote>
<p>Nginx çš„é»˜è®¤é…ç½®æ–‡ä»¶ä¸º <code>nginx.conf</code>.</p>
<ul>
<li><code>nginx -c xxx.conf</code> - ä»¥æŒ‡å®šçš„æ–‡ä»¶ä½œä¸ºé…ç½®æ–‡ä»¶,å¯åŠ¨ Nginx.</li>
</ul>
</blockquote>
<h2 id="é…ç½®æ–‡ä»¶å®ä¾‹"><a href="#é…ç½®æ–‡ä»¶å®ä¾‹" class="headerlink" title="é…ç½®æ–‡ä»¶å®ä¾‹"></a>é…ç½®æ–‡ä»¶å®ä¾‹</h2><p>ä»¥ä¸‹ä¸ºä¸€ä¸ª <code>nginx.conf</code> é…ç½®æ–‡ä»¶å®ä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å®šä¹‰ nginx è¿è¡Œçš„ç”¨æˆ·å’Œç”¨æˆ·ç»„</span></span><br><span class="line"><span class="attribute">user</span> www;</span><br><span class="line"></span><br><span class="line"><span class="comment">#nginx è¿›ç¨‹æ•°,å»ºè®®è®¾ç½®ä¸ºç­‰äº CPU æ€»æ ¸å¿ƒæ•°.</span></span><br><span class="line"><span class="attribute">worker_processes</span> <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#nginx é»˜è®¤æ²¡æœ‰å¼€å¯åˆ©ç”¨å¤šæ ¸ CPU, é€šè¿‡å¢åŠ  worker_cpu_affinity é…ç½®å‚æ•°æ¥å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU ä»¥ä¸‹æ˜¯ 8 æ ¸çš„é…ç½®å‚æ•°</span></span><br><span class="line"><span class="attribute">worker_cpu_affinity</span> <span class="number">00000001</span> <span class="number">00000010</span> <span class="number">00000100</span> <span class="number">00001000</span> <span class="number">00010000</span> <span class="number">00100000</span> <span class="number">01000000</span> <span class="number">10000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#å…¨å±€é”™è¯¯æ—¥å¿—å®šä¹‰ç±»å‹,[ debug | info | notice | warn | error | crit ]</span></span><br><span class="line"><span class="attribute">error_log</span> /var/log/nginx/<span class="literal">error</span>.log <span class="literal">info</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿›ç¨‹æ–‡ä»¶</span></span><br><span class="line"><span class="attribute">pid</span> /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸€ä¸ª nginx è¿›ç¨‹æ‰“å¼€çš„æœ€å¤šæ–‡ä»¶æè¿°ç¬¦æ•°ç›®,ç†è®ºå€¼åº”è¯¥æ˜¯æœ€å¤šæ‰“å¼€æ–‡ä»¶æ•°(ç³»ç»Ÿçš„å€¼ ulimit -n)ä¸ nginx è¿›ç¨‹æ•°ç›¸é™¤,ä½†æ˜¯ nginx åˆ†é…è¯·æ±‚å¹¶ä¸å‡åŒ€,æ‰€ä»¥å»ºè®®ä¸ ulimit -n çš„å€¼ä¿æŒä¸€è‡´.</span></span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">65535</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#å·¥ä½œæ¨¡å¼ä¸è¿æ¥æ•°ä¸Šé™</span></span><br><span class="line"><span class="section">events</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">#å‚è€ƒäº‹ä»¶æ¨¡å‹,use [ kqueue | rtsig | epoll | /dev/poll | select | poll ]; epoll æ¨¡å‹æ˜¯ Linux 2.6 ä»¥ä¸Šç‰ˆæœ¬å†…æ ¸ä¸­çš„é«˜æ€§èƒ½ç½‘ç»œ I/O æ¨¡å‹,å¦‚æœè·‘åœ¨ FreeBSD ä¸Šé¢,å°±ç”¨ kqueue æ¨¡å‹.</span></span><br><span class="line">    <span class="comment">#epoll æ˜¯å¤šè·¯å¤ç”¨ IO(I/O Multiplexing) ä¸­çš„ä¸€ç§æ–¹å¼,ä½†æ˜¯ä»…ç”¨äº linux2.6 ä»¥ä¸Šå†…æ ¸,å¯ä»¥å¤§å¤§æé«˜ nginx çš„æ€§èƒ½</span></span><br><span class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>; </span><br><span class="line">    <span class="comment">#å•ä¸ªåå° worker process è¿›ç¨‹çš„æœ€å¤§å¹¶å‘é“¾æ¥æ•°</span></span><br><span class="line">    <span class="comment">#äº‹ä»¶æ¨¡å—æŒ‡ä»¤,å®šä¹‰ nginx æ¯ä¸ªè¿›ç¨‹æœ€å¤§è¿æ¥æ•°,é»˜è®¤ 1024.æœ€å¤§å®¢æˆ·è¿æ¥æ•°ç”± worker_processes å’Œ worker_connections å†³å®š</span></span><br><span class="line">    <span class="comment">#å³ max_client=worker_processes*worker_connections, åœ¨ä½œä¸ºåå‘ä»£ç†æ—¶:max_client=worker_processes*worker_connections / 4</span></span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">65535</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#è®¾å®š http æœåŠ¡å™¨</span></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span> mime.types; <span class="comment">#æ–‡ä»¶æ‰©å±•åä¸æ–‡ä»¶ç±»å‹æ˜ å°„è¡¨</span></span><br><span class="line">    <span class="attribute">default_type</span> application/octet-stream; <span class="comment">#é»˜è®¤æ–‡ä»¶ç±»å‹</span></span><br><span class="line">    <span class="attribute">charset</span> utf-<span class="number">8</span>; <span class="comment">#é»˜è®¤ç¼–ç </span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_names_hash_bucket_size</span> <span class="number">128</span>; <span class="comment">#æœåŠ¡å™¨åå­—çš„ hash è¡¨å¤§å°</span></span><br><span class="line">    <span class="attribute">client_header_buffer_size</span> <span class="number">32k</span>; <span class="comment">#ä¸Šä¼ æ–‡ä»¶å¤§å°é™åˆ¶</span></span><br><span class="line">    <span class="attribute">large_client_header_buffers</span> <span class="number">4</span> <span class="number">64k</span>; <span class="comment">#è®¾å®šè¯·æ±‚ç¼“</span></span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">8m</span>; <span class="comment">#è®¾å®šè¯·æ±‚ç¼“</span></span><br><span class="line">    <span class="attribute">sendfile</span> <span class="literal">on</span>; <span class="comment">#å¼€å¯é«˜æ•ˆæ–‡ä»¶ä¼ è¾“æ¨¡å¼,sendfile æŒ‡ä»¤æŒ‡å®š nginx æ˜¯å¦è°ƒç”¨ sendfile å‡½æ•°æ¥è¾“å‡ºæ–‡ä»¶,å¯¹äºæ™®é€šåº”ç”¨è®¾ä¸º on,å¦‚æœç”¨æ¥è¿›è¡Œä¸‹è½½ç­‰åº”ç”¨ç£ç›˜ IO é‡è´Ÿè½½åº”ç”¨,å¯è®¾ç½®ä¸º off,ä»¥å¹³è¡¡ç£ç›˜ä¸ç½‘ç»œ I/O å¤„ç†é€Ÿåº¦,é™ä½ç³»ç»Ÿçš„è´Ÿè½½.æ³¨æ„:å¦‚æœå›¾ç‰‡æ˜¾ç¤ºä¸æ­£å¸¸æŠŠè¿™ä¸ªæ”¹æˆ off.</span></span><br><span class="line">    <span class="attribute">autoindex</span> <span class="literal">on</span>; <span class="comment">#å¼€å¯ç›®å½•åˆ—è¡¨è®¿é—®,åˆé€‚ä¸‹è½½æœåŠ¡å™¨,é»˜è®¤å…³é—­.</span></span><br><span class="line">    <span class="attribute">tcp_nopush</span> <span class="literal">on</span>; <span class="comment">#é˜²æ­¢ç½‘ç»œé˜»å¡</span></span><br><span class="line">    <span class="attribute">tcp_nodelay</span> <span class="literal">on</span>; <span class="comment">#é˜²æ­¢ç½‘ç»œé˜»å¡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">##è¿æ¥å®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´å„ç§å‚æ•°è®¾ç½®##</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">120</span>;          <span class="comment">#å•ä½æ˜¯ç§’,å®¢æˆ·ç«¯è¿æ¥æ—¶æ—¶é—´,è¶…æ—¶ä¹‹åæœåŠ¡å™¨ç«¯è‡ªåŠ¨å…³é—­è¯¥è¿æ¥ å¦‚æœ nginx å®ˆæŠ¤è¿›ç¨‹åœ¨è¿™ä¸ªç­‰å¾…çš„æ—¶é—´é‡Œ,ä¸€ç›´æ²¡æœ‰æ”¶åˆ°æµè§ˆå‘è¿‡æ¥ http è¯·æ±‚,åˆ™å…³é—­è¿™ä¸ª http è¿æ¥</span></span><br><span class="line">    <span class="attribute">client_header_timeout</span> <span class="number">10</span>;        <span class="comment">#å®¢æˆ·ç«¯è¯·æ±‚å¤´çš„è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="attribute">client_body_timeout</span> <span class="number">10</span>;          <span class="comment">#å®¢æˆ·ç«¯è¯·æ±‚ä¸»ä½“è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="attribute">reset_timedout_connection</span> <span class="literal">on</span>;    <span class="comment">#å‘Šè¯‰ nginx å…³é—­ä¸å“åº”çš„å®¢æˆ·ç«¯è¿æ¥.è¿™å°†ä¼šé‡Šæ”¾é‚£ä¸ªå®¢æˆ·ç«¯æ‰€å æœ‰çš„å†…å­˜ç©ºé—´</span></span><br><span class="line">    <span class="attribute">send_timeout</span> <span class="number">10</span>;                 <span class="comment">#å®¢æˆ·ç«¯å“åº”è¶…æ—¶æ—¶é—´,åœ¨ä¸¤æ¬¡å®¢æˆ·ç«¯è¯»å–æ“ä½œä¹‹é—´.å¦‚æœåœ¨è¿™æ®µæ—¶é—´å†…,å®¢æˆ·ç«¯æ²¡æœ‰è¯»å–ä»»ä½•æ•°æ®,nginx å°±ä¼šå…³é—­è¿æ¥</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#FastCGI ç›¸å…³å‚æ•°æ˜¯ä¸ºäº†æ”¹å–„ç½‘ç«™çš„æ€§èƒ½:å‡å°‘èµ„æºå ç”¨,æé«˜è®¿é—®é€Ÿåº¦.ä¸‹é¢å‚æ•°çœ‹å­—é¢æ„æ€éƒ½èƒ½ç†è§£.</span></span><br><span class="line">    <span class="attribute">fastcgi_connect_timeout</span> <span class="number">300</span>;</span><br><span class="line">    <span class="attribute">fastcgi_send_timeout</span> <span class="number">300</span>;</span><br><span class="line">    <span class="attribute">fastcgi_read_timeout</span> <span class="number">300</span>;</span><br><span class="line">    <span class="attribute">fastcgi_buffer_size</span> <span class="number">64k</span>;</span><br><span class="line">    <span class="attribute">fastcgi_buffers</span> <span class="number">4</span> <span class="number">64k</span>;</span><br><span class="line">    <span class="attribute">fastcgi_busy_buffers_size</span> <span class="number">128k</span>;</span><br><span class="line">    <span class="attribute">fastcgi_temp_file_write_size</span> <span class="number">128k</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">###ä½œä¸ºä»£ç†ç¼“å­˜æœåŠ¡å™¨è®¾ç½®#######</span></span><br><span class="line">    <span class="comment">###å…ˆå†™åˆ° temp å†ç§»åŠ¨åˆ° cache</span></span><br><span class="line">    <span class="comment">#proxy_cache_path /var/tmp/nginx/proxy_cache levels=1:2 keys_zone=cache_one:512m inactive=10m max_size=64m;</span></span><br><span class="line">    <span class="comment">###ä»¥ä¸Š proxy_temp å’Œ proxy_cache éœ€è¦åœ¨åŒä¸€ä¸ªåˆ†åŒºä¸­</span></span><br><span class="line">    <span class="comment">###levels=1:2 è¡¨ç¤ºç¼“å­˜çº§åˆ«,è¡¨ç¤ºç¼“å­˜ç›®å½•çš„ç¬¬ä¸€çº§ç›®å½•æ˜¯ 1 ä¸ªå­—ç¬¦,ç¬¬äºŒçº§ç›®å½•æ˜¯ 2 ä¸ªå­—ç¬¦ keys_zone=cache_one:128m ç¼“å­˜ç©ºé—´èµ·åä¸º cache_one å¤§å°ä¸º 512m</span></span><br><span class="line">    <span class="comment">###max_size=64m è¡¨ç¤ºå•ä¸ªæ–‡ä»¶è¶…è¿‡ 128m å°±ä¸ç¼“å­˜äº†  inactive=10m è¡¨ç¤ºç¼“å­˜çš„æ•°æ®,10 åˆ†é’Ÿå†…æ²¡æœ‰è¢«è®¿é—®è¿‡å°±åˆ é™¤</span></span><br><span class="line">    <span class="comment">#########end####################</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#####å¯¹ä¼ è¾“æ–‡ä»¶å‹ç¼©###########</span></span><br><span class="line">    <span class="comment">#gzip æ¨¡å—è®¾ç½®</span></span><br><span class="line">    <span class="attribute">gzip</span> <span class="literal">on</span>; <span class="comment">#å¼€å¯ gzip å‹ç¼©è¾“å‡º</span></span><br><span class="line">    <span class="attribute">gzip_min_length</span> <span class="number">1k</span>; <span class="comment">#æœ€å°å‹ç¼©æ–‡ä»¶å¤§å°</span></span><br><span class="line">    <span class="attribute">gzip_buffers</span> <span class="number">4</span> <span class="number">16k</span>; <span class="comment">#å‹ç¼©ç¼“å†²åŒº</span></span><br><span class="line">    <span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">0</span>; <span class="comment">#å‹ç¼©ç‰ˆæœ¬(é»˜è®¤ 1.1,å‰ç«¯å¦‚æœæ˜¯ squid2.5 è¯·ä½¿ç”¨ 1.0)</span></span><br><span class="line">    <span class="attribute">gzip_comp_level</span> <span class="number">2</span>; <span class="comment">#å‹ç¼©ç­‰çº§,gzip å‹ç¼©æ¯”,1 ä¸ºæœ€å°,å¤„ç†æœ€å¿«;9 ä¸ºå‹ç¼©æ¯”æœ€å¤§,å¤„ç†æœ€æ…¢,ä¼ è¾“é€Ÿåº¦æœ€å¿«,ä¹Ÿæœ€æ¶ˆè€— CPU;</span></span><br><span class="line">    <span class="attribute">gzip_types</span> text/plain application/x-javascript text/css application/xml;</span><br><span class="line">    <span class="comment">#å‹ç¼©ç±»å‹,é»˜è®¤å°±å·²ç»åŒ…å« text/html,æ‰€ä»¥ä¸‹é¢å°±ä¸ç”¨å†å†™äº†,å†™ä¸Šå»ä¹Ÿä¸ä¼šæœ‰é—®é¢˜,ä½†æ˜¯ä¼šæœ‰ä¸€ä¸ª warn.</span></span><br><span class="line">    <span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">##############################</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#limit_zone crawler $binary_remote_addr 10m; #å¼€å¯é™åˆ¶ IP è¿æ¥æ•°çš„æ—¶å€™éœ€è¦ä½¿ç”¨</span></span><br><span class="line"></span><br><span class="line">    <span class="section">upstream</span> blog.ha97.com &#123;</span><br><span class="line">        <span class="comment">#upstream çš„è´Ÿè½½å‡è¡¡,weight æ˜¯æƒé‡,å¯ä»¥æ ¹æ®æœºå™¨é…ç½®å®šä¹‰æƒé‡.weigth å‚æ•°è¡¨ç¤ºæƒå€¼,æƒå€¼è¶Šé«˜è¢«åˆ†é…åˆ°çš„å‡ ç‡è¶Šå¤§.</span></span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.80.121:80</span> weight=<span class="number">3</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.80.122:80</span> weight=<span class="number">2</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.80.123:80</span> weight=<span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#è™šæ‹Ÿä¸»æœºçš„é…ç½®</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="comment">#ç›‘å¬ç«¯å£</span></span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#############https##################</span></span><br><span class="line">        <span class="comment">#listen 443 ssl;</span></span><br><span class="line">        <span class="comment">#ssl_certificate /opt/https/xxxxxx.crt;</span></span><br><span class="line">        <span class="comment">#ssl_certificate_key /opt/https/xxxxxx.key;</span></span><br><span class="line">        <span class="comment">#ssl_protocols SSLv3 TLSv1;</span></span><br><span class="line">        <span class="comment">#ssl_ciphers HIGH:!ADH:!EXPORT57:RC4+RSA:+MEDIUM;</span></span><br><span class="line">        <span class="comment">#ssl_prefer_server_ciphers on;</span></span><br><span class="line">        <span class="comment">#ssl_session_cache shared:SSL:2m;</span></span><br><span class="line">        <span class="comment">#ssl_session_timeout 5m;</span></span><br><span class="line">        <span class="comment">####################################end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#åŸŸåå¯ä»¥æœ‰å¤šä¸ª,ç”¨ç©ºæ ¼éš”å¼€</span></span><br><span class="line">        <span class="attribute">server_name</span> www.ha97.com ha97.com;</span><br><span class="line">        <span class="attribute">index</span> index.html index.htm index.php;</span><br><span class="line">        <span class="attribute">root</span> /data/www/ha97;</span><br><span class="line">        <span class="section">location</span> <span class="regexp">~ .*.(php|php5)?$</span> &#123;</span><br><span class="line">            <span class="attribute">fastcgi_pass</span> <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">            <span class="attribute">fastcgi_index</span> index.php;</span><br><span class="line">            <span class="attribute">include</span> fastcgi.conf;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#å›¾ç‰‡ç¼“å­˜æ—¶é—´è®¾ç½®</span></span><br><span class="line">        <span class="section">location</span> <span class="regexp">~ .*.(gif|jpg|jpeg|png|bmp|swf)$</span> &#123;</span><br><span class="line">            <span class="attribute">expires</span> <span class="number">10d</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#JS å’Œ CSS ç¼“å­˜æ—¶é—´è®¾ç½®</span></span><br><span class="line">        <span class="section">location</span> <span class="regexp">~ .*.(js|css)?$</span> &#123;</span><br><span class="line">            <span class="attribute">expires</span> <span class="number">1h</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#æ—¥å¿—æ ¼å¼è®¾å®š</span></span><br><span class="line">        <span class="attribute">log_format</span> access <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &quot;<span class="variable">$request</span>&quot; &#x27;</span> <span class="string">&#x27;<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &quot;<span class="variable">$http_referer</span>&quot; &#x27;</span> <span class="string">&#x27;&quot;<span class="variable">$http_user_agent</span>&quot; <span class="variable">$http_x_forwarded_for</span>&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#å®šä¹‰æœ¬è™šæ‹Ÿä¸»æœºçš„è®¿é—®æ—¥å¿—</span></span><br><span class="line">        <span class="attribute">access_log</span> /var/log/nginx/ha97access.log access;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#å¯¹ &quot;/&quot; å¯ç”¨åå‘ä»£ç†</span></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://127.0.0.1:88;</span><br><span class="line">            <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="comment">#åç«¯çš„ Web æœåŠ¡å™¨å¯ä»¥é€šè¿‡ X-Forwarded-For è·å–ç”¨æˆ·çœŸå® IP</span></span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">            <span class="comment">#ä»¥ä¸‹æ˜¯ä¸€äº›åå‘ä»£ç†çš„é…ç½®,å¯é€‰.</span></span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">            <span class="attribute">client_max_body_size</span> <span class="number">10m</span>; <span class="comment">#å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°</span></span><br><span class="line">            <span class="attribute">client_body_buffer_size</span> <span class="number">128k</span>; <span class="comment">#ç¼“å†²åŒºä»£ç†ç¼“å†²ç”¨æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•°,</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">##ä»£ç†è®¾ç½® ä»¥ä¸‹è®¾ç½®æ˜¯ nginx å’Œåç«¯æœåŠ¡å™¨ä¹‹é—´é€šè®¯çš„è®¾ç½®##</span></span><br><span class="line">            <span class="attribute">proxy_connect_timeout</span> <span class="number">90</span>; <span class="comment">#nginx è·Ÿåç«¯æœåŠ¡å™¨è¿æ¥è¶…æ—¶æ—¶é—´(ä»£ç†è¿æ¥è¶…æ—¶)</span></span><br><span class="line">            <span class="attribute">proxy_send_timeout</span> <span class="number">90</span>; <span class="comment">#åç«¯æœåŠ¡å™¨æ•°æ®å›ä¼ æ—¶é—´(ä»£ç†å‘é€è¶…æ—¶)</span></span><br><span class="line">            <span class="attribute">proxy_read_timeout</span> <span class="number">90</span>; <span class="comment">#è¿æ¥æˆåŠŸå,åç«¯æœåŠ¡å™¨å“åº”æ—¶é—´(ä»£ç†æ¥æ”¶è¶…æ—¶)</span></span><br><span class="line">            <span class="attribute">proxy_buffering</span> <span class="literal">on</span>;    <span class="comment">#è¯¥æŒ‡ä»¤å¼€å¯ä»åç«¯è¢«ä»£ç†æœåŠ¡å™¨çš„å“åº”å†…å®¹ç¼“å†² æ­¤å‚æ•°å¼€å¯å proxy_buffers å’Œ proxy_busy_buffers_size å‚æ•°æ‰ä¼šèµ·ä½œç”¨</span></span><br><span class="line">            <span class="attribute">proxy_buffer_size</span> <span class="number">4k</span>;  <span class="comment">#è®¾ç½®ä»£ç†æœåŠ¡å™¨(nginx)ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å°</span></span><br><span class="line">            <span class="attribute">proxy_buffers</span> <span class="number">4</span> <span class="number">32k</span>;   <span class="comment">#proxy_buffers ç¼“å†²åŒº,ç½‘é¡µå¹³å‡åœ¨ 32k ä»¥ä¸‹çš„è®¾ç½®</span></span><br><span class="line">            <span class="attribute">proxy_busy_buffers_size</span> <span class="number">64k</span>; <span class="comment">#é«˜è´Ÿè·ä¸‹ç¼“å†²å¤§å°(proxy_buffers*2)</span></span><br><span class="line">            <span class="attribute">proxy_max_temp_file_size</span> <span class="number">2048m</span>; <span class="comment">#é»˜è®¤ 1024m, è¯¥æŒ‡ä»¤ç”¨äºè®¾ç½®å½“ç½‘é¡µå†…å®¹å¤§äº proxy_buffers æ—¶,ä¸´æ—¶æ–‡ä»¶å¤§å°çš„æœ€å¤§å€¼.å¦‚æœæ–‡ä»¶å¤§äºè¿™ä¸ªå€¼,å®ƒå°†ä» upstream æœåŠ¡å™¨åŒæ­¥åœ°ä¼ é€’è¯·æ±‚,è€Œä¸æ˜¯ç¼“å†²åˆ°ç£ç›˜</span></span><br><span class="line">            <span class="attribute">proxy_temp_file_write_size</span> <span class="number">512k</span>; è¿™æ˜¯å½“è¢«ä»£ç†æœåŠ¡å™¨çš„å“åº”è¿‡å¤§æ—¶ <span class="attribute">nginx</span> ä¸€æ¬¡æ€§å†™å…¥ä¸´æ—¶æ–‡ä»¶çš„æ•°æ®é‡.</span><br><span class="line">            proxy_temp_path  /var/tmp/nginx/proxy_temp;    <span class="comment">##å®šä¹‰ç¼“å†²å­˜å‚¨ç›®å½•,ä¹‹å‰å¿…é¡»è¦å…ˆæ‰‹åŠ¨åˆ›å»ºæ­¤ç›®å½•</span></span><br><span class="line">            <span class="attribute">proxy_headers_hash_max_size</span> <span class="number">51200</span>;</span><br><span class="line">            <span class="attribute">proxy_headers_hash_bucket_size</span> <span class="number">6400</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#è®¾å®šæŸ¥çœ‹ nginx çŠ¶æ€çš„åœ°å€</span></span><br><span class="line">        <span class="section">location</span> /nginxStatus &#123;</span><br><span class="line">            <span class="attribute">stub_status</span> <span class="literal">on</span>;</span><br><span class="line">            <span class="attribute">access_log</span> <span class="literal">on</span>;</span><br><span class="line">            <span class="attribute">auth_basic</span> <span class="string">&quot;nginxStatus&quot;</span>;</span><br><span class="line">            <span class="attribute">auth_basic_user_file</span> conf/htpasswd;</span><br><span class="line">            <span class="comment">#htpasswd æ–‡ä»¶çš„å†…å®¹å¯ä»¥ç”¨ apache æä¾›çš„ htpasswd å·¥å…·æ¥äº§ç”Ÿ.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#æœ¬åœ°åŠ¨é™åˆ†ç¦»åå‘ä»£ç†é…ç½®</span></span><br><span class="line">        <span class="comment">#æ‰€æœ‰ jsp çš„é¡µé¢å‡äº¤ç”± tomcat æˆ– resin å¤„ç†</span></span><br><span class="line">        <span class="section">location</span> <span class="regexp">~ .(jsp|jspx|do)?$</span> &#123;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://127.0.0.1:8080;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#æ‰€æœ‰é™æ€æ–‡ä»¶ç”± nginx ç›´æ¥è¯»å–ä¸ç»è¿‡ tomcat æˆ– resin</span></span><br><span class="line">        <span class="section">location</span> <span class="regexp">~ .*.(htm|html|gif|jpg|jpeg|png|bmp|swf|ioc|rar|zip|txt|flv|mid|doc|ppt|pdf|xls|mp3|wma)$</span></span><br><span class="line">        &#123; <span class="attribute">expires</span> <span class="number">15d</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> <span class="regexp">~ .*.(js|css)?$</span></span><br><span class="line">        &#123; <span class="attribute">expires</span> <span class="number">1h</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åŸºæœ¬è§„åˆ™"><a href="#åŸºæœ¬è§„åˆ™" class="headerlink" title="åŸºæœ¬è§„åˆ™"></a>åŸºæœ¬è§„åˆ™</h2><h3 id="ç®¡ç†-Nginx-é…ç½®"><a href="#ç®¡ç†-Nginx-é…ç½®" class="headerlink" title="ç®¡ç† Nginx é…ç½®"></a>ç®¡ç† Nginx é…ç½®</h3><blockquote>
<p>éšç€ Nginx é…ç½®çš„å¢é•¿,æ‚¨æœ‰å¿…è¦ç»„ç»‡ã€ç®¡ç†é…ç½®å†…å®¹.</p>
<p>å½“æ‚¨çš„ Nginx é…ç½®å¢åŠ æ—¶,ç»„ç»‡é…ç½®çš„éœ€æ±‚ä¹Ÿä¼šå¢åŠ . äº•äº•æœ‰æ¡çš„ä»£ç æ˜¯:</p>
<ul>
<li>æ˜“äºç†è§£</li>
<li>æ˜“äºç»´æŠ¤</li>
<li>æ˜“äºä½¿ç”¨</li>
</ul>
</blockquote>
<blockquote>
<p>ä½¿ç”¨ <code>include</code> æŒ‡ä»¤å¯å°†å¸¸ç”¨æœåŠ¡å™¨é…ç½®ç§»åŠ¨åˆ°å•ç‹¬çš„æ–‡ä»¶ä¸­,å¹¶å°†ç‰¹å®šä»£ç é™„åŠ åˆ°å…¨å±€é…ç½®,ä¸Šä¸‹æ–‡ç­‰ä¸­.</p>
</blockquote>
<blockquote>
<p>æˆ‘æ€»æ˜¯å°è¯•åœ¨é…ç½®æ ‘çš„æ ¹ç›®å½•ä¸­ä¿ç•™å¤šä¸ªç›®å½•. è¿™äº›ç›®å½•å­˜å‚¨æ‰€æœ‰é™„åŠ åˆ°ä¸»æ–‡ä»¶çš„é…ç½®æ–‡ä»¶. æˆ‘æ›´å–œæ¬¢ä»¥ä¸‹ç»“æ„:</p>
<ul>
<li><code>html</code> - ç”¨äºé»˜è®¤é™æ€æ–‡ä»¶,ä¾‹å¦‚ å…¨å±€ 5xx é”™è¯¯é¡µé¢</li>
<li><code>master</code> - ç”¨äºä¸»è¦é…ç½®,ä¾‹å¦‚ ACL,ä¾¦å¬æŒ‡ä»¤å’ŒåŸŸ<ul>
<li><code>_acls</code> - ç”¨äºè®¿é—®æ§åˆ¶åˆ—è¡¨,ä¾‹å¦‚ åœ°ç†æˆ–åœ°å›¾æ¨¡å—</li>
<li><code>_basic</code> - ç”¨äºé€Ÿç‡é™åˆ¶è§„åˆ™,é‡å®šå‘æ˜ å°„æˆ–ä»£ç†å‚æ•°</li>
<li><code>_listen</code> - ç”¨äºæ‰€æœ‰ä¾¦å¬æŒ‡ä»¤; è¿˜å­˜å‚¨ SSL é…ç½®</li>
<li><code>_server</code> - ç”¨äºåŸŸ(localhost)é…ç½®; è¿˜å­˜å‚¨æ‰€æœ‰åç«¯å®šä¹‰</li>
</ul>
</li>
<li><code>modules</code> - ç”¨äºåŠ¨æ€åŠ è½½åˆ° Nginx ä¸­çš„æ¨¡å—</li>
<li><code>snippets</code> - ç”¨äº Nginx åˆ«å,é…ç½®æ¨¡æ¿</li>
</ul>
<p>å¦‚æœæœ‰å¿…è¦,æˆ‘ä¼šå°†å…¶ä¸­ä¸€äº›é™„åŠ åˆ°å…·æœ‰ <code>server</code> æŒ‡ä»¤çš„æ–‡ä»¶ä¸­.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Store this configuration in https.conf for example:</span></span><br><span class="line"><span class="attribute">listen</span> <span class="number">10.240.20.2:443</span> ssl;</span><br><span class="line"><span class="attribute">ssl_certificate</span> /etc/nginx/master/_server/example.com/certs/nginx_example.com_bundle.crt;</span><br><span class="line"><span class="attribute">ssl_certificate_key</span> /etc/nginx/master/_server/example.com/certs/example.com.key;</span><br><span class="line"></span><br><span class="line"><span class="comment">## Include this file to the server section:</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">include</span> /etc/nginx/master/_listen/<span class="number">10.240.20.2</span>/https.conf;</span><br><span class="line">  <span class="comment">## And other:</span></span><br><span class="line">  <span class="attribute">include</span> /etc/nginx/master/_static/errors.conf;</span><br><span class="line">  <span class="attribute">include</span> /etc/nginx/master/_server/_helpers/global.conf;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attribute">server_name</span> domain.com www.domain.com;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<h3 id="é‡åŠ è½½-Nginx-é…ç½®"><a href="#é‡åŠ è½½-Nginx-é…ç½®" class="headerlink" title="é‡åŠ è½½ Nginx é…ç½®"></a>é‡åŠ è½½ Nginx é…ç½®</h3><p>ç¤ºä¾‹:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 1)</span></span><br><span class="line">systemctl reload nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">## 2)</span></span><br><span class="line">service nginx reload</span><br><span class="line"></span><br><span class="line"><span class="comment">## 3)</span></span><br><span class="line">/etc/init.d/nginx reload</span><br><span class="line"></span><br><span class="line"><span class="comment">## 4)</span></span><br><span class="line">/usr/sbin/nginx -s reload</span><br><span class="line"></span><br><span class="line"><span class="comment">## 5)</span></span><br><span class="line"><span class="built_in">kill</span> -HUP $(<span class="built_in">cat</span> /var/run/nginx.pid)</span><br><span class="line"><span class="comment">## or</span></span><br><span class="line"><span class="built_in">kill</span> -HUP $(pgrep -f <span class="string">&quot;nginx: master&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 6)</span></span><br><span class="line">/usr/sbin/nginx -g <span class="string">&#x27;daemon on; master_process on;&#x27;</span> -s reload</span><br></pre></td></tr></table></figure>

<h3 id="ç›‘å¬-80-å’Œ-443-ç«¯å£"><a href="#ç›‘å¬-80-å’Œ-443-ç«¯å£" class="headerlink" title="ç›‘å¬ 80 å’Œ 443 ç«¯å£"></a>ç›‘å¬ 80 å’Œ 443 ç«¯å£</h3><blockquote>
<p>å¦‚æœæ‚¨ä½¿ç”¨å®Œå…¨ç›¸åŒçš„é…ç½®ä¸º HTTP å’Œ HTTPS æä¾›æœåŠ¡(å•ä¸ªæœåŠ¡å™¨åŒæ—¶å¤„ç† HTTP å’Œ HTTPS è¯·æ±‚),Nginx è¶³å¤Ÿæ™ºèƒ½,å¯ä»¥å¿½ç•¥é€šè¿‡ç«¯å£ 80 åŠ è½½çš„ SSL æŒ‡ä»¤.</p>
<p>Nginx çš„æœ€ä½³å®è·µæ˜¯ä½¿ç”¨å•ç‹¬çš„æœåŠ¡å™¨è¿›è¡Œè¿™æ ·çš„é‡å®šå‘(ä¸ä¸æ‚¨çš„ä¸»è¦é…ç½®çš„æœåŠ¡å™¨å…±äº«),å¯¹æ‰€æœ‰å†…å®¹è¿›è¡Œç¡¬ç¼–ç ,å¹¶ä¸”å®Œå…¨ä¸ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼.</p>
<p>æˆ‘ä¸å–œæ¬¢å¤åˆ¶è§„åˆ™,ä½†æ˜¯å•ç‹¬çš„ç›‘å¬æŒ‡ä»¤æ— ç–‘å¯ä»¥å¸®åŠ©æ‚¨ç»´æŠ¤å’Œä¿®æ”¹é…ç½®.</p>
<p>å¦‚æœå°†å¤šä¸ªåŸŸå›ºå®šåˆ°ä¸€ä¸ª IP åœ°å€,åˆ™å¾ˆæœ‰ç”¨. è¿™ä½¿æ‚¨å¯ä»¥å°†ä¸€ä¸ªä¾¦å¬æŒ‡ä»¤(ä¾‹å¦‚,å¦‚æœå°†å…¶ä¿ç•™åœ¨é…ç½®æ–‡ä»¶ä¸­)é™„åŠ åˆ°å¤šä¸ªåŸŸé…ç½®.</p>
<p>å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ HTTPS,åˆ™å¯èƒ½è¿˜éœ€è¦å¯¹åŸŸè¿›è¡Œç¡¬ç¼–ç ,å› ä¸ºæ‚¨å¿…é¡»é¢„å…ˆçŸ¥é“è¦æä¾›çš„è¯ä¹¦.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## For HTTP:</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">10.240.20.2:80</span>;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## For HTTPS:</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">10.240.20.2:443</span> ssl;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ˜¾ç¤ºæŒ‡å®šç›‘å¬çš„åœ°å€å’Œç«¯å£"><a href="#æ˜¾ç¤ºæŒ‡å®šç›‘å¬çš„åœ°å€å’Œç«¯å£" class="headerlink" title="æ˜¾ç¤ºæŒ‡å®šç›‘å¬çš„åœ°å€å’Œç«¯å£"></a>æ˜¾ç¤ºæŒ‡å®šç›‘å¬çš„åœ°å€å’Œç«¯å£</h3><p>Nginx çš„ listen æŒ‡ä»¤ç”¨äºç›‘å¬æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£å·,é…ç½®å½¢å¼ä¸º:<code>listen &lt;address&gt;:&lt;port&gt;</code>.è‹¥ IP åœ°å€æˆ–ç«¯å£ç¼ºå¤±,Nginx ä¼šä»¥é»˜è®¤å€¼æ¥æ›¿æ¢.</p>
<p>è€Œä¸”,ä»…å½“éœ€è¦åŒºåˆ†ä¸ listen æŒ‡ä»¤ä¸­çš„åŒä¸€çº§åˆ«åŒ¹é…çš„æœåŠ¡å™¨å—æ—¶,æ‰ä¼šè¯„ä¼° server_name æŒ‡ä»¤.</p>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="comment">## This block will be processed:</span></span><br><span class="line">  <span class="attribute">listen</span> <span class="number">192.168.252.10</span>;  <span class="comment">## --&gt; 192.168.252.10:80</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;  <span class="comment">## --&gt; *:80 --&gt; 0.0.0.0:80</span></span><br><span class="line">  <span class="attribute">server_name</span> api.random.com;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é˜²æ­¢ä½¿ç”¨æœªå®šä¹‰çš„æœåŠ¡å™¨åç§°å¤„ç†è¯·æ±‚"><a href="#é˜²æ­¢ä½¿ç”¨æœªå®šä¹‰çš„æœåŠ¡å™¨åç§°å¤„ç†è¯·æ±‚" class="headerlink" title="é˜²æ­¢ä½¿ç”¨æœªå®šä¹‰çš„æœåŠ¡å™¨åç§°å¤„ç†è¯·æ±‚"></a>é˜²æ­¢ä½¿ç”¨æœªå®šä¹‰çš„æœåŠ¡å™¨åç§°å¤„ç†è¯·æ±‚</h3><blockquote>
<p>Nginx åº”è¯¥é˜»æ­¢ä½¿ç”¨æœªå®šä¹‰çš„æœåŠ¡å™¨åç§°(ä¹Ÿä½¿ç”¨ IP åœ°å€)å¤„ç†è¯·æ±‚.å®ƒå¯ä»¥é˜²æ­¢é…ç½®é”™è¯¯,ä¾‹å¦‚æµé‡è½¬å‘åˆ°ä¸æ­£ç¡®çš„åç«¯.é€šè¿‡åˆ›å»ºé»˜è®¤è™šæ‹Ÿè™šæ‹Ÿä¸»æœºå¯ä»¥è½»æ¾è§£å†³è¯¥é—®é¢˜,è¯¥è™šæ‹Ÿè™šæ‹Ÿä¸»æœºå¯ä»¥æ•è·å¸¦æœ‰æ— æ³•è¯†åˆ«çš„ä¸»æœºæ ‡å¤´çš„æ‰€æœ‰è¯·æ±‚.</p>
<p>å¦‚æœæ²¡æœ‰ä¸€ä¸ª listen æŒ‡ä»¤å…·æœ‰ default_server å‚æ•°,åˆ™å…·æœ‰ address:port å¯¹çš„ç¬¬ä¸€å°æœåŠ¡å™¨å°†æ˜¯è¯¥å¯¹çš„é»˜è®¤æœåŠ¡å™¨(è¿™æ„å‘³ç€ Nginx å§‹ç»ˆå…·æœ‰é»˜è®¤æœåŠ¡å™¨).</p>
<p>å¦‚æœæœ‰äººä½¿ç”¨ IP åœ°å€è€Œä¸æ˜¯æœåŠ¡å™¨åç§°å‘å‡ºè¯·æ±‚,åˆ™ä¸»æœºè¯·æ±‚æ ‡å¤´å­—æ®µå°†åŒ…å« IP åœ°å€,å¹¶ä¸”å¯ä»¥ä½¿ç”¨ IP åœ°å€ä½œä¸ºæœåŠ¡å™¨åç§°æ¥å¤„ç†è¯·æ±‚.</p>
<p>åœ¨ç°ä»£ç‰ˆæœ¬çš„ Nginx ä¸­,ä¸éœ€è¦æœåŠ¡å™¨åç§°_.å¦‚æœæ‰¾ä¸åˆ°å…·æœ‰åŒ¹é…çš„ listen å’Œ server_name çš„æœåŠ¡å™¨,Nginx å°†ä½¿ç”¨é»˜è®¤æœåŠ¡å™¨.å¦‚æœæ‚¨çš„é…ç½®åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶ä¸­,åˆ™è¯„ä¼°é¡ºåºå°†ä¸æ˜ç¡®,å› æ­¤æ‚¨éœ€è¦æ˜¾å¼æ ‡è®°é»˜è®¤æœåŠ¡å™¨.</p>
<p>Nginx ä½¿ç”¨ Host æ ‡å¤´è¿›è¡Œ server_name åŒ¹é….å®ƒä¸ä½¿ç”¨ TLS SNI.è¿™æ„å‘³ç€å¯¹äº SSL æœåŠ¡å™¨,Nginx å¿…é¡»èƒ½å¤Ÿæ¥å— SSL è¿æ¥,è¿™å½’ç»“ä¸ºå…·æœ‰è¯ä¹¦&#x2F;å¯†é’¥.è¯ä¹¦&#x2F;å¯†é’¥å¯ä»¥æ˜¯ä»»æ„å€¼,ä¾‹å¦‚è‡ªç­¾å.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†å…¶æ”¾ç½®åœ¨é…ç½®æ–‡ä»¶çš„å¼€å§‹ä½ç½®ä»¥é¿å…é”™è¯¯</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="comment"># å¯¹äºsslé€‰é¡¹,è¯·è®°å¾—å¡«å†™SSLå‚æ•°(ç§é’¥ã€è¯ä¹¦ã€åŠ å¯†å¥—ä»¶ç­‰)</span></span><br><span class="line">  <span class="comment"># åœ¨ä½ æƒ³è¦ä½œä¸ºé»˜è®¤æœåŠ¡å™¨çš„æœåŠ¡å™¨listenæŒ‡ä»¤ä¸­æ·»åŠ default_server</span></span><br><span class="line">  <span class="attribute">listen</span> <span class="number">10.240.20.2:443</span> default_server ssl;</span><br><span class="line">  <span class="comment"># æˆ‘ä»¬æ•è·:</span></span><br><span class="line">  <span class="comment">#   - æ— æ•ˆçš„åŸŸå</span></span><br><span class="line">  <span class="comment">#   - æ²¡æœ‰&quot;Host&quot;å¤´çš„è¯·æ±‚</span></span><br><span class="line">  <span class="comment">#   - ä»¥åŠæ‰€æœ‰å…¶ä»–çš„è¯·æ±‚(ä¹Ÿæ˜¯å› ä¸ºä¸Šé¢çš„è®¾ç½®)</span></span><br><span class="line">  <span class="comment">#   - server_nameæŒ‡ä»¤ä¸­ä¸è¦æ±‚ä½¿ç”¨default_server - æˆ‘æ·»åŠ è¿™ä¸ªæ˜¯ä¸ºäº†æ›´å¥½åœ°ç†è§£,æˆ‘è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªä¸æˆæ–‡çš„æ ‡å‡†</span></span><br><span class="line">  <span class="comment"># ...ä½†æ˜¯ä½ åº”è¯¥çŸ¥é“,è¿™å®é™…ä¸Šæ˜¯æ— å…³ç´§è¦çš„,ä½ å¯ä»¥åœ¨è¿™é‡Œæ”¾ä»»ä½•ä¸œè¥¿.</span></span><br><span class="line">  <span class="attribute">server_name</span> _ <span class="string">&quot;&quot;</span> default_server;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attribute">return</span> <span class="number">444</span>;</span><br><span class="line">  <span class="comment"># æˆ‘ä»¬ä¹Ÿå¯ä»¥æä¾›æœåŠ¡:</span></span><br><span class="line">  <span class="comment"># location / &#123;</span></span><br><span class="line">  <span class="comment">#   # é™æ€æ–‡ä»¶(é”™è¯¯é¡µé¢):</span></span><br><span class="line">  <span class="comment">#   #   root /etc/nginx/error-pages/404;</span></span><br><span class="line">  <span class="comment">#   # æˆ–é‡å®šå‘:</span></span><br><span class="line">  <span class="comment">#   #   return 301 https://badssl.com;</span></span><br><span class="line">  <span class="comment">#   # return 444;</span></span><br><span class="line">  <span class="comment"># &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">10.240.20.2:443</span> ssl;</span><br><span class="line">  <span class="attribute">server_name</span> domain.com;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">10.240.20.2:443</span> ssl;</span><br><span class="line">  <span class="attribute">server_name</span> domain.org;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ä¸è¦åœ¨-listen-æˆ–-upstream-ä¸­ä½¿ç”¨-hostname"><a href="#ä¸è¦åœ¨-listen-æˆ–-upstream-ä¸­ä½¿ç”¨-hostname" class="headerlink" title="ä¸è¦åœ¨ listen æˆ– upstream ä¸­ä½¿ç”¨ hostname"></a>ä¸è¦åœ¨ listen æˆ– upstream ä¸­ä½¿ç”¨ hostname</h3><blockquote>
<p>é€šå¸¸,åœ¨ listen æˆ–ä¸Šæ¸¸æŒ‡ä»¤ä¸­ä½¿ç”¨ä¸»æœºåæ˜¯ä¸€ç§ä¸å¥½çš„åšæ³•.</p>
<p>åœ¨æœ€åçš„æƒ…å†µä¸‹,Nginx å°†æ— æ³•ç»‘å®šåˆ°æ‰€éœ€çš„ TCP å¥—æ¥å­—,è¿™å°†å®Œå…¨é˜»æ­¢ Nginx å¯åŠ¨.</p>
<p>æœ€å¥½å’Œæ›´å®‰å…¨çš„æ–¹æ³•æ˜¯çŸ¥é“éœ€è¦ç»‘å®šçš„ IP åœ°å€,å¹¶ä½¿ç”¨è¯¥åœ°å€ä»£æ›¿ä¸»æœºå. è¿™ä¹Ÿå¯ä»¥é˜²æ­¢ Nginx æŸ¥æ‰¾åœ°å€å¹¶æ¶ˆé™¤å¯¹å¤–éƒ¨å’Œå†…éƒ¨è§£æå™¨çš„ä¾èµ–.</p>
<p>åœ¨ server_name æŒ‡ä»¤ä¸­ä½¿ç”¨$ hostname(è®¡ç®—æœºçš„ä¸»æœºå)å˜é‡ä¹Ÿæ˜¯ä¸å½“è¡Œä¸ºçš„ç¤ºä¾‹(ç±»ä¼¼äºä½¿ç”¨ä¸»æœºåæ ‡ç­¾).</p>
<p>æˆ‘è®¤ä¸ºä¹Ÿæœ‰å¿…è¦è®¾ç½® IP åœ°å€å’Œç«¯å£å·å¯¹,ä»¥é˜²æ­¢å¯èƒ½éš¾ä»¥è°ƒè¯•çš„è½¯é”™è¯¯.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<p>âŒ é”™è¯¯é…ç½®</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> &#123;</span><br><span class="line">  <span class="attribute">server</span> http://x-9s-web01-prod:8080;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> rev-proxy-prod:<span class="number">80</span>;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â­• æ­£ç¡®é…ç½®</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> &#123;</span><br><span class="line">  <span class="attribute">server</span> http://192.168.252.200:8080;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">10.10.100.20:80</span>;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æŒ‡ä»¤ä¸­åªé…ç½®ä¸€ä¸ª-SSL"><a href="#æŒ‡ä»¤ä¸­åªé…ç½®ä¸€ä¸ª-SSL" class="headerlink" title="æŒ‡ä»¤ä¸­åªé…ç½®ä¸€ä¸ª SSL"></a>æŒ‡ä»¤ä¸­åªé…ç½®ä¸€ä¸ª SSL</h3><blockquote>
<p>æ­¤è§„åˆ™ä½¿è°ƒè¯•å’Œç»´æŠ¤æ›´åŠ å®¹æ˜“.</p>
<p>è¯·è®°ä½,æ— è®º SSL å‚æ•°å¦‚ä½•,æ‚¨éƒ½å¯ä»¥åœ¨åŒä¸€ç›‘å¬æŒ‡ä»¤(IP åœ°å€)ä¸Šä½¿ç”¨å¤šä¸ª SSL è¯ä¹¦.</p>
<p>æˆ‘è®¤ä¸ºè¦åœ¨å¤šä¸ª HTTPS æœåŠ¡å™¨ä¹‹é—´å…±äº«ä¸€ä¸ª IP åœ°å€,æ‚¨åº”è¯¥ä½¿ç”¨ä¸€ä¸ª SSL é…ç½®(ä¾‹å¦‚åè®®,å¯†ç ,æ›²çº¿).è¿™æ˜¯ä¸ºäº†é˜²æ­¢é”™è¯¯å’Œé…ç½®ä¸åŒ¹é….</p>
<p>è¿˜è¯·è®°ä½æœ‰å…³é»˜è®¤æœåŠ¡å™¨çš„é…ç½®.è¿™å¾ˆé‡è¦,å› ä¸ºå¦‚æœæ‰€æœ‰ listen æŒ‡ä»¤éƒ½æ²¡æœ‰ default_server å‚æ•°,åˆ™é…ç½®ä¸­çš„ç¬¬ä¸€å°æœåŠ¡å™¨å°†æ˜¯é»˜è®¤æœåŠ¡å™¨.å› æ­¤,æ‚¨åº”è¯¥åªä½¿ç”¨ä¸€ä¸ª SSL è®¾ç½®,å¹¶ä¸”åœ¨åŒä¸€ IP åœ°å€ä¸Šä½¿ç”¨å¤šä¸ªåç§°.</p>
<p>ä» Nginx æ–‡æ¡£ä¸­:</p>
<p>è¿™æ˜¯ç”± SSL åè®®è¡Œä¸ºå¼•èµ·çš„.åœ¨æµè§ˆå™¨å‘é€ HTTP è¯·æ±‚ä¹‹å‰,å·²å»ºç«‹ SSL è¿æ¥,nginx ä¸çŸ¥é“æ‰€è¯·æ±‚æœåŠ¡å™¨çš„åç§°.å› æ­¤,å®ƒå¯èƒ½ä»…æä¾›é»˜è®¤æœåŠ¡å™¨çš„è¯ä¹¦.</p>
<p>è¿˜è¦çœ‹çœ‹è¿™ä¸ª:</p>
<p>TLS æœåŠ¡å™¨åç§°æŒ‡ç¤ºæ‰©å±•å(SNI,RFC 6066)æ˜¯åœ¨å•ä¸ª IP åœ°å€ä¸Šè¿è¡Œå¤šä¸ª HTTPS æœåŠ¡å™¨çš„æ›´é€šç”¨çš„è§£å†³æ–¹æ¡ˆ,å®ƒå…è®¸æµè§ˆå™¨åœ¨ SSL æ¡æ‰‹æœŸé—´ä¼ é€’è¯·æ±‚çš„æœåŠ¡å™¨åç§°,å› æ­¤,æœåŠ¡å™¨å°†çŸ¥é“å“ªä¸ªç”¨äºè¿æ¥çš„è¯ä¹¦.</p>
<p>å¦ä¸€ä¸ªå¥½ä¸»æ„æ˜¯å°†å¸¸ç”¨æœåŠ¡å™¨è®¾ç½®ç§»åˆ°å•ç‹¬çš„æ–‡ä»¶(å³ common &#x2F; example.com.conf)ä¸­,ç„¶åå°†å…¶åŒ…å«åœ¨å•ç‹¬çš„æœåŠ¡å™¨å—ä¸­.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†æ­¤é…ç½®å­˜å‚¨åœ¨ä¾‹å¦‚ https.conf ä¸­:</span></span><br><span class="line"><span class="attribute">listen</span> <span class="number">192.168.252.10:443</span> default_server ssl http2;</span><br><span class="line"><span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span>;</span><br><span class="line"><span class="attribute">ssl_ciphers</span> <span class="string">&quot;ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384&quot;</span>;</span><br><span class="line"><span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">ssl_ecdh_curve</span> secp521r1:secp384r1;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æ­¤æ–‡ä»¶åŒ…å«åˆ°serverä¸Šä¸‹æ–‡ä¸­(ä¸ºç‰¹å®šçš„ç›‘å¬æŒ‡ä»¤ç»‘å®š domain-a.com):</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">include</span>             /etc/nginx/https.conf;</span><br><span class="line">  <span class="attribute">server_name</span>         domain-a.com;</span><br><span class="line">  <span class="attribute">ssl_certificate</span>     domain-a.com.crt;</span><br><span class="line">  <span class="attribute">ssl_certificate_key</span> domain-a.com.key;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æ­¤æ–‡ä»¶åŒ…å«åˆ°serverä¸Šä¸‹æ–‡ä¸­(ä¸ºç‰¹å®šçš„ç›‘å¬æŒ‡ä»¤ç»‘å®š domain-b.com):</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">include</span>             /etc/nginx/https.conf;</span><br><span class="line">  <span class="attribute">server_name</span>         domain-b.com;</span><br><span class="line">  <span class="attribute">ssl_certificate</span>     domain-b.com.crt;</span><br><span class="line">  <span class="attribute">ssl_certificate_key</span> domain-b.com.key;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨-geo-map-æ¨¡å—æ›¿ä»£-allow-deny"><a href="#ä½¿ç”¨-geo-map-æ¨¡å—æ›¿ä»£-allow-deny" class="headerlink" title="ä½¿ç”¨ geo&#x2F;map æ¨¡å—æ›¿ä»£ allow&#x2F;deny"></a>ä½¿ç”¨ geo&#x2F;map æ¨¡å—æ›¿ä»£ allow&#x2F;deny</h3><blockquote>
<p>ä½¿ç”¨åœ°å›¾æˆ–åœ°ç†æ¨¡å—(å…¶ä¸­ä¹‹ä¸€)å¯ä»¥é˜²æ­¢ç”¨æˆ·æ»¥ç”¨æ‚¨çš„æœåŠ¡å™¨.è¿™æ ·å°±å¯ä»¥åˆ›å»ºå˜é‡,å…¶å€¼å–å†³äºå®¢æˆ·ç«¯ IP åœ°å€.</p>
<p>ç”±äºä»…åœ¨ä½¿ç”¨å˜é‡æ—¶æ‰å¯¹å…¶è¿›è¡Œæ±‚å€¼,å› æ­¤ç”šè‡³ä»…å­˜åœ¨å¤§é‡å·²å£°æ˜çš„å˜é‡.åœ°ç†ä½ç½®å˜é‡ä¸ä¼šä¸ºè¯·æ±‚å¤„ç†å¸¦æ¥ä»»ä½•é¢å¤–è´¹ç”¨.</p>
<p>è¿™äº›æŒ‡ä»¤æä¾›äº†é˜»æ­¢æ— æ•ˆè®¿é—®è€…çš„å®Œç¾æ–¹æ³•,ä¾‹å¦‚ä½¿ç”¨ ngx_http_geoip_module.ä¾‹å¦‚,geo æ¨¡å—éå¸¸é€‚åˆæœ‰æ¡ä»¶åœ°å…è®¸æˆ–æ‹’ç» IP.</p>
<p>geo æ¨¡å—(æ³¨æ„:ä¸è¦å°†æ­¤æ¨¡å—è¯¯è®¤ä¸ºæ˜¯ GeoIP)åœ¨åŠ è½½é…ç½®æ—¶ä¼šæ„å»ºå†…å­˜åŸºæ•°æ ‘.è¿™ä¸è·¯ç”±ä¸­ä½¿ç”¨çš„æ•°æ®ç»“æ„ç›¸åŒ,å¹¶ä¸”æŸ¥æ‰¾é€Ÿåº¦éå¸¸å¿«.å¦‚æœæ¯ä¸ªç½‘ç»œæœ‰è®¸å¤šå”¯ä¸€å€¼,é‚£ä¹ˆè¾ƒé•¿çš„åŠ è½½æ—¶é—´æ˜¯ç”±åœ¨æ•°ç»„ä¸­æœç´¢æ•°æ®é‡å¤é¡¹å¼•èµ·çš„.å¦åˆ™,å¯èƒ½æ˜¯ç”±äºæ’å…¥åŸºæ•°æ ‘å¼•èµ·çš„.</p>
<p>æˆ‘å°†ä¸¤ä¸ªæ¨¡å—éƒ½ç”¨äºå¤§å‹åˆ—è¡¨.æ‚¨åº”è¯¥è€ƒè™‘ä¸€ä¸‹,å› ä¸ºæ­¤è§„åˆ™è¦æ±‚ä½¿ç”¨å¤šä¸ª if æ¡ä»¶.æˆ‘è®¤ä¸º,å¯¹äºç®€å•çš„åˆ—è¡¨,æ¯•ç«Ÿå…è®¸&#x2F;æ‹’ç»æŒ‡ä»¤æ˜¯æ›´å¥½çš„è§£å†³æ–¹æ¡ˆ.çœ‹ä¸‹é¢çš„ä¾‹å­:</p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># allow/deny:</span></span><br><span class="line"><span class="section">location</span> /internal &#123;</span><br><span class="line">  <span class="attribute">include</span> acls/internal.conf;</span><br><span class="line">  <span class="attribute">allow</span>   <span class="number">192.168.240.0</span>/<span class="number">24</span>;</span><br><span class="line">  <span class="attribute">deny</span>    all;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹æ¯”åœ°ç†ä½ç½®/æ˜ å°„:</span></span><br><span class="line"><span class="section">location</span> /internal &#123;</span><br><span class="line">  <span class="attribute">if</span> (<span class="variable">$globals_internal_map_acl</span>) &#123;</span><br><span class="line">    <span class="attribute">set</span> <span class="variable">$pass</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="attribute">if</span> (<span class="variable">$pass</span> = <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://localhost:80;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="attribute">if</span> (<span class="variable">$pass</span> != <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Mapæ¨¡å—:</span></span><br><span class="line"><span class="attribute">map</span> <span class="variable">$remote_addr</span> <span class="variable">$globals_internal_map_acl</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># çŠ¶æ€ç :</span></span><br><span class="line">  <span class="comment">#  - 0 = å‡</span></span><br><span class="line">  <span class="comment">#  - 1 = çœŸ</span></span><br><span class="line">  <span class="attribute">default</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># å†…éƒ¨ç½‘ç»œ</span></span><br><span class="line">  10.255.10.0/24 1;</span><br><span class="line">  10.255.20.0/24 1;</span><br><span class="line">  10.255.30.0/24 1;</span><br><span class="line">  192.168.0.0/16 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Geoæ¨¡å—:</span></span><br><span class="line"><span class="attribute">geo</span> <span class="variable">$globals_internal_geo_acl</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># çŠ¶æ€ç :</span></span><br><span class="line">  <span class="comment">#  - 0 = å‡</span></span><br><span class="line">  <span class="comment">#  - 1 = çœŸ</span></span><br><span class="line">  <span class="attribute">default</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># å†…éƒ¨ç½‘ç»œ</span></span><br><span class="line">  10.255.10.0/24 1;</span><br><span class="line">  10.255.20.0/24 1;</span><br><span class="line">  10.255.30.0/24 1;</span><br><span class="line">  192.168.0.0/16 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Map-æ‰€æœ‰äº‹ç‰©"><a href="#Map-æ‰€æœ‰äº‹ç‰©" class="headerlink" title="Map æ‰€æœ‰äº‹ç‰©"></a>Map æ‰€æœ‰äº‹ç‰©</h3><blockquote>
<p>ä½¿ç”¨åœ°å›¾ç®¡ç†å¤§é‡é‡å®šå‘,å¹¶ä½¿ç”¨å®ƒä»¬æ¥è‡ªå®šä¹‰é”®&#x2F;å€¼å¯¹.</p>
<p>map æŒ‡ä»¤å¯æ˜ å°„å­—ç¬¦ä¸²,å› æ­¤å¯ä»¥è¡¨ç¤ºä¾‹å¦‚ 192.168.144.0&#x2F;24 ä½œä¸ºæ­£åˆ™è¡¨è¾¾å¼,å¹¶ç»§ç»­ä½¿ç”¨ map æŒ‡ä»¤.</p>
<p>Map æ¨¡å—æä¾›äº†ä¸€ç§æ›´ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆ,ç”¨äºæ¸…æ™°åœ°è§£æå¤§é‡æ­£åˆ™è¡¨è¾¾å¼,ä¾‹å¦‚ ç”¨æˆ·ä»£ç†,å¼•èæ¥æº.</p>
<p>æ‚¨è¿˜å¯ä»¥å¯¹åœ°å›¾ä½¿ç”¨ include æŒ‡ä»¤,è¿™æ ·é…ç½®æ–‡ä»¶çœ‹èµ·æ¥ä¼šå¾ˆæ¼‚äº®.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">map</span> <span class="variable">$http_user_agent</span> <span class="variable">$device_redirect</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># é»˜è®¤å€¼ä¸º&quot;desktop&quot;</span></span><br><span class="line">  <span class="attribute">default</span> <span class="string">&quot;desktop&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># æ ¹æ®ä¸åŒçš„ç”¨æˆ·ä»£ç†åˆ¤æ–­æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡</span></span><br><span class="line">  ~(?i)ip(hone|od) &quot;mobile&quot;; <span class="comment"># åŒ¹é…iPhoneæˆ–iPod</span></span><br><span class="line">  ~(?i)android.*(mobile|mini) &quot;mobile&quot;; <span class="comment"># åŒ¹é…Androidæ‰‹æœº</span></span><br><span class="line">  ~Mobile.+<span class="attribute">Firefox</span> <span class="string">&quot;mobile&quot;</span>; <span class="comment"># åŒ¹é…ç«ç‹æµè§ˆå™¨çš„ç§»åŠ¨ç‰ˆ</span></span><br><span class="line">  ~^<span class="attribute">HTC</span> <span class="string">&quot;mobile&quot;</span>; <span class="comment"># åŒ¹é…HTCæ‰‹æœº</span></span><br><span class="line">  ~<span class="attribute">Fennec</span> <span class="string">&quot;mobile&quot;</span>; <span class="comment"># åŒ¹é…ç§»åŠ¨ç‰ˆç«ç‹æµè§ˆå™¨Fennec</span></span><br><span class="line">  ~<span class="attribute">IEMobile</span> <span class="string">&quot;mobile&quot;</span>; <span class="comment"># åŒ¹é…IEçš„ç§»åŠ¨æµè§ˆå™¨</span></span><br><span class="line">  ~<span class="attribute">BB10</span> <span class="string">&quot;mobile&quot;</span>; <span class="comment"># åŒ¹é…é»‘è“10ç³»ç»Ÿæ‰‹æœº</span></span><br><span class="line">  ~SymbianOS.*<span class="attribute">AppleWebKit</span> <span class="string">&quot;mobile&quot;</span>; <span class="comment"># åŒ¹é…Symbianç³»ç»Ÿæ‰‹æœº</span></span><br><span class="line">  ~Opera\<span class="attribute">sMobi</span> <span class="string">&quot;mobile&quot;</span>; <span class="comment"># åŒ¹é…Opera Mobileæµè§ˆå™¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ç‰¹å®šä¸Šä¸‹æ–‡ä¸­å¯ç”¨(ä¾‹å¦‚,ä½ç½®)</span></span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$device_redirect</span> = <span class="string">&quot;mobile&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡,é‡å®šå‘åˆ°ç§»åŠ¨åŸŸå</span></span><br><span class="line">  <span class="attribute">return</span> <span class="number">301</span> https://m.domain.com<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ä¸ºæ‰€æœ‰æœªåŒ¹é…çš„è·¯å¾„è®¾ç½®æ ¹è·¯å¾„"><a href="#ä¸ºæ‰€æœ‰æœªåŒ¹é…çš„è·¯å¾„è®¾ç½®æ ¹è·¯å¾„" class="headerlink" title="ä¸ºæ‰€æœ‰æœªåŒ¹é…çš„è·¯å¾„è®¾ç½®æ ¹è·¯å¾„"></a>ä¸ºæ‰€æœ‰æœªåŒ¹é…çš„è·¯å¾„è®¾ç½®æ ¹è·¯å¾„</h3><blockquote>
<p>ä¸ºè¯·æ±‚è®¾ç½®æœåŠ¡å™¨æŒ‡ä»¤å†…éƒ¨çš„å…¨å±€æ ¹è·¯å¾„. å®ƒä¸ºæœªå®šä¹‰çš„ä½ç½®æŒ‡å®šæ ¹è·¯å¾„.</p>
<p>æ ¹æ®å®˜æ–¹æ–‡æ¡£:</p>
<p>å¦‚æœæ‚¨åœ¨æ¯ä¸ªä½ç½®å—ä¸­æ·»åŠ ä¸€ä¸ªæ ¹è·¯å¾„,åˆ™ä¸åŒ¹é…çš„ä½ç½®å—å°†æ²¡æœ‰æ ¹è·¯å¾„.å› æ­¤,é‡è¦çš„æ˜¯,æ ¹æŒ‡ä»¤å¿…é¡»åœ¨æ‚¨çš„ä½ç½®å—ä¹‹å‰å‘ç”Ÿ,ç„¶åæ ¹ç›®å½•æŒ‡ä»¤å¯ä»¥åœ¨éœ€è¦æ—¶è¦†ç›–è¯¥æŒ‡ä»¤.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="comment"># è®¾ç½®æœåŠ¡çš„åŸŸå</span></span><br><span class="line">  <span class="attribute">server_name</span> domain.com;</span><br><span class="line">  <span class="comment"># è®¾ç½®ç½‘ç«™çš„æ ¹ç›®å½•</span></span><br><span class="line">  <span class="attribute">root</span> /var/www/domain.com/public;</span><br><span class="line">  <span class="comment"># å®šä¹‰å¤„ç†ä¸»é¡µçš„é€»è¾‘</span></span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="comment"># é™„åŠ é…ç½®çœç•¥...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># å®šä¹‰å¤„ç†APIè¯·æ±‚çš„é€»è¾‘</span></span><br><span class="line">  <span class="section">location</span> /api &#123;</span><br><span class="line">    <span class="comment"># é™„åŠ é…ç½®çœç•¥...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># å®šä¹‰å¤„ç†é™æ€èµ„æºçš„é€»è¾‘</span></span><br><span class="line">  <span class="section">location</span> /static &#123;</span><br><span class="line">    <span class="comment"># è¦†ç›–æ ¹ç›®å½•è®¾ç½®,ç‰¹åˆ«ä¸ºé™æ€æ–‡ä»¶è®¾ç½®æ ¹ç›®å½•</span></span><br><span class="line">    <span class="attribute">root</span> /var/www/domain.com/static;</span><br><span class="line">    <span class="comment"># é™„åŠ é…ç½®çœç•¥...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨-return-æŒ‡ä»¤è¿›è¡Œ-URL-é‡å®šå‘-301ã€302"><a href="#ä½¿ç”¨-return-æŒ‡ä»¤è¿›è¡Œ-URL-é‡å®šå‘-301ã€302" class="headerlink" title="ä½¿ç”¨ return æŒ‡ä»¤è¿›è¡Œ URL é‡å®šå‘(301ã€302)"></a>ä½¿ç”¨ return æŒ‡ä»¤è¿›è¡Œ URL é‡å®šå‘(301ã€302)</h3><blockquote>
<p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„è§„åˆ™. æ‚¨åº”è¯¥ä½¿ç”¨æœåŠ¡å™¨å—å’Œ return è¯­å¥,å› ä¸ºå®ƒä»¬æ¯”è¯„ä¼° RegEx æ›´å¿«.</p>
<p>å› ä¸º Nginx åœæ­¢å¤„ç†è¯·æ±‚(è€Œä¸å¿…å¤„ç†æ­£åˆ™è¡¨è¾¾å¼),æ‰€ä»¥å®ƒæ›´åŠ ç®€å•å¿«æ·.</p>
</blockquote>
<p>ç¤ºä¾‹</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">server_name</span> www.example.com;</span><br><span class="line">  <span class="comment">## return    301 https://$host$request_uri;</span></span><br><span class="line">  <span class="attribute">return</span>      <span class="number">301</span> <span class="variable">$scheme</span>://www.example.com<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é…ç½®æ—¥å¿—è½®æ¢ç­–ç•¥"><a href="#é…ç½®æ—¥å¿—è½®æ¢ç­–ç•¥" class="headerlink" title="é…ç½®æ—¥å¿—è½®æ¢ç­–ç•¥"></a>é…ç½®æ—¥å¿—è½®æ¢ç­–ç•¥</h3><blockquote>
<p>æ—¥å¿—æ–‡ä»¶ä¸ºæ‚¨æä¾›æœ‰å…³æœåŠ¡å™¨æ´»åŠ¨å’Œæ€§èƒ½ä»¥åŠå¯èƒ½å‡ºç°çš„ä»»ä½•é—®é¢˜çš„åé¦ˆ. å®ƒä»¬è®°å½•äº†æœ‰å…³è¯·æ±‚å’Œ Nginx å†…éƒ¨çš„è¯¦ç»†ä¿¡æ¯. ä¸å¹¸çš„æ˜¯,æ—¥å¿—ä½¿ç”¨äº†æ›´å¤šçš„ç£ç›˜ç©ºé—´.</p>
<p>æ‚¨åº”è¯¥å®šä¹‰ä¸€ä¸ªè¿‡ç¨‹,è¯¥è¿‡ç¨‹å°†å®šæœŸå­˜æ¡£å½“å‰æ—¥å¿—æ–‡ä»¶å¹¶å¯åŠ¨ä¸€ä¸ªæ–°æ—¥å¿—æ–‡ä»¶,é‡å‘½åå¹¶æœ‰é€‰æ‹©åœ°å‹ç¼©å½“å‰æ—¥å¿—æ–‡ä»¶,åˆ é™¤æ—§æ—¥å¿—æ–‡ä»¶,å¹¶å¼ºåˆ¶æ—¥å¿—è®°å½•ç³»ç»Ÿå¼€å§‹ä½¿ç”¨æ–°æ—¥å¿—æ–‡ä»¶.</p>
<p>æˆ‘è®¤ä¸ºæœ€å¥½çš„å·¥å…·æ˜¯ logrotate. å¦‚æœæˆ‘æƒ³è‡ªåŠ¨ç®¡ç†æ—¥å¿—,ä¹Ÿæƒ³ç¡ä¸ªå¥½è§‰,é‚£ä¹ˆæˆ‘ä¼šåœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨å®ƒ. è¿™æ˜¯ä¸€ä¸ªæ—‹è½¬æ—¥å¿—çš„ç®€å•ç¨‹åº,ä½¿ç”¨ crontab å¯ä»¥å·¥ä½œ. å®ƒæ˜¯è®¡åˆ’çš„å·¥ä½œ,è€Œä¸æ˜¯å®ˆæŠ¤ç¨‹åº,å› æ­¤æ— éœ€é‡æ–°åŠ è½½å…¶é…ç½®.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<ul>
<li><p>æ‰‹åŠ¨æ—‹è½¬</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰‹åŠ¨æ£€æŸ¥(æ‰€æœ‰æ—¥å¿—æ–‡ä»¶):</span></span><br><span class="line">logrotate -dv /etc/logrotate.conf</span><br><span class="line"><span class="comment"># æ‰‹åŠ¨æ£€æŸ¥å¹¶å¼ºåˆ¶è½®è½¬(ç‰¹å®šçš„æ—¥å¿—æ–‡ä»¶):</span></span><br><span class="line">logrotate -dv --force /etc/logrotate.d/nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>è‡ªåŠ¨æ—‹è½¬</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/logrotate.d/nginx &lt;&lt; <span class="string">__EOF__</span></span><br><span class="line"><span class="string"># é…ç½®nginxæ—¥å¿—è½®è½¬</span></span><br><span class="line"><span class="string">/var/log/nginx/*.log &#123;</span></span><br><span class="line"><span class="string">  daily # æ¯å¤©æ‰§è¡Œæ—¥å¿—è½®è½¬</span></span><br><span class="line"><span class="string">  missingok # å¦‚æœæ—¥å¿—ä¸¢å¤±ä¹Ÿä¸æŠ¥é”™</span></span><br><span class="line"><span class="string">  rotate 14 # ä¿å­˜14ä»½æ—§æ—¥å¿—</span></span><br><span class="line"><span class="string">  compress # å¯¹æ—§æ—¥å¿—è¿›è¡Œå‹ç¼©</span></span><br><span class="line"><span class="string">  delaycompress # å»¶è¿Ÿå‹ç¼©</span></span><br><span class="line"><span class="string">  notifempty # å¦‚æœæ—¥å¿—ä¸ºç©º,åˆ™ä¸è½®è½¬</span></span><br><span class="line"><span class="string">  create 0640 nginx nginx # è½®è½¬ååˆ›å»ºæ–°æ—¥å¿—æ–‡ä»¶,æŒ‡å®šæƒé™å’Œæ‰€æœ‰è€…</span></span><br><span class="line"><span class="string">  sharedscripts # è„šæœ¬åœ¨æ‰€æœ‰æ—¥å¿—è½®è½¬åè¿è¡Œä¸€æ¬¡</span></span><br><span class="line"><span class="string">  prerotate # è½®è½¬å‰è„šæœ¬</span></span><br><span class="line"><span class="string">    if [ -d /etc/logrotate.d/httpd-prerotate ]; then \</span></span><br><span class="line"><span class="string">      run-parts /etc/logrotate.d/httpd-prerotate; \</span></span><br><span class="line"><span class="string">    fi \</span></span><br><span class="line"><span class="string">  endscript</span></span><br><span class="line"><span class="string">  postrotate # è½®è½¬åè„šæœ¬</span></span><br><span class="line"><span class="string">    # ä»¥ä¸‹ä¸ºæ³¨é‡Šçš„å‘½ä»¤,ç”¨äºå‘é€ä¿¡å·ç»™nginxä¸»è¿›ç¨‹,ä½†å®é™…ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥å¹³æ»‘é‡è½½nginx</span></span><br><span class="line"><span class="string">    # test ! -f /var/run/nginx.pid || kill -USR1 `cat /var/run/nginx.pid`</span></span><br><span class="line"><span class="string">    invoke-rc.d nginx reload &gt;/dev/null 2&gt;&amp;1 # é‡è½½nginxé…ç½®,è¾“å‡ºé‡å®šå‘åˆ°/dev/null</span></span><br><span class="line"><span class="string">  endscript</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># é’ˆå¯¹localhostçš„æ—¥å¿—æ–‡ä»¶åŒä¸Šé…ç½®</span></span><br><span class="line"><span class="string">/var/log/nginx/localhost/*.log &#123;</span></span><br><span class="line"><span class="string">  daily</span></span><br><span class="line"><span class="string">  missingok</span></span><br><span class="line"><span class="string">  rotate 14</span></span><br><span class="line"><span class="string">  compress</span></span><br><span class="line"><span class="string">  delaycompress</span></span><br><span class="line"><span class="string">  notifempty</span></span><br><span class="line"><span class="string">  create 0640 nginx nginx</span></span><br><span class="line"><span class="string">  sharedscripts</span></span><br><span class="line"><span class="string">  prerotate</span></span><br><span class="line"><span class="string">    if [ -d /etc/logrotate.d/httpd-prerotate ]; then \</span></span><br><span class="line"><span class="string">            run-parts /etc/logrotate.d/httpd-prerotate; \</span></span><br><span class="line"><span class="string">    fi \</span></span><br><span class="line"><span class="string">  endscript</span></span><br><span class="line"><span class="string">  postrotate</span></span><br><span class="line"><span class="string">    # è¿™æ˜¯æ³¨é‡Šæ‰çš„å‘½ä»¤,æ—¨åœ¨å‘nginxä¸»è¿›ç¨‹å‘é€ä¿¡å·,ä½†å®é™…ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œå¹³æ»‘é‡å¯</span></span><br><span class="line"><span class="string">    # test ! -f /var/run/nginx.pid || kill -USR1 `cat /var/run/nginx.pid`</span></span><br><span class="line"><span class="string">    invoke-rc.d nginx reload &gt;/dev/null 2&gt;&amp;1 # é‡è½½nginxé…ç½®,è¾“å‡ºé‡å®šå‘åˆ°/dev/null</span></span><br><span class="line"><span class="string">  endscript</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># é…ç½®é’ˆå¯¹ç‰¹å®šåŸŸåexample.comçš„æ—¥å¿—æ–‡ä»¶è½®è½¬è§„åˆ™,ä¸å‰é¢çš„é…ç½®åŸºæœ¬ä¸€è‡´</span></span><br><span class="line"><span class="string">/var/log/nginx/domains/example.com/*.log &#123;</span></span><br><span class="line"><span class="string">  daily</span></span><br><span class="line"><span class="string">  missingok</span></span><br><span class="line"><span class="string">  rotate 14</span></span><br><span class="line"><span class="string">  compress</span></span><br><span class="line"><span class="string">  delaycompress</span></span><br><span class="line"><span class="string">  notifempty</span></span><br><span class="line"><span class="string">  create 0640 nginx nginx</span></span><br><span class="line"><span class="string">  sharedscripts</span></span><br><span class="line"><span class="string">  prerotate</span></span><br><span class="line"><span class="string">    if [ -d /etc/logrotate.d/httpd-prerotate ]; then \</span></span><br><span class="line"><span class="string">      run-parts /etc/logrotate.d/httpd-prerotate; \</span></span><br><span class="line"><span class="string">    fi \</span></span><br><span class="line"><span class="string">  endscript</span></span><br><span class="line"><span class="string">  postrotate</span></span><br><span class="line"><span class="string">    # åŒä¸Š,æ³¨é‡Šæ‰çš„å‘½ä»¤å¯ä»¥å‘é€ä¿¡å·ç»™nginx,ä½†æ¨èä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤</span></span><br><span class="line"><span class="string">    # test ! -f /var/run/nginx.pid || kill -USR1 `cat /var/run/nginx.pid`</span></span><br><span class="line"><span class="string">    invoke-rc.d nginx reload &gt;/dev/null 2&gt;&amp;1 # é‡è½½nginxé…ç½®,è¾“å‡ºé‡å®šå‘åˆ°/dev/null</span></span><br><span class="line"><span class="string">  endscript</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">__EOF__</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="ä¸è¦é‡å¤ç´¢å¼•æŒ‡ä»¤-åªèƒ½åœ¨-http-å—ä¸­ä½¿ç”¨"><a href="#ä¸è¦é‡å¤ç´¢å¼•æŒ‡ä»¤-åªèƒ½åœ¨-http-å—ä¸­ä½¿ç”¨" class="headerlink" title="ä¸è¦é‡å¤ç´¢å¼•æŒ‡ä»¤,åªèƒ½åœ¨ http å—ä¸­ä½¿ç”¨"></a>ä¸è¦é‡å¤ç´¢å¼•æŒ‡ä»¤,åªèƒ½åœ¨ http å—ä¸­ä½¿ç”¨</h3><blockquote>
<p>ä¸€æ¬¡ä½¿ç”¨ index æŒ‡ä»¤. å®ƒåªéœ€è¦åœ¨æ‚¨çš„ http ä¸Šä¸‹æ–‡ä¸­å‘ç”Ÿ,å¹¶å°†åœ¨ä¸‹é¢ç»§æ‰¿.</p>
<p>æˆ‘è®¤ä¸ºæˆ‘ä»¬åœ¨å¤åˆ¶ç›¸åŒè§„åˆ™æ—¶åº”æ ¼å¤–å°å¿ƒ. ä½†æ˜¯,å½“ç„¶,è§„åˆ™çš„é‡å¤æœ‰æ—¶æ˜¯å¯ä»¥çš„,æˆ–è€…ä¸ä¸€å®šæ˜¯å¤§éº»çƒ¦.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<p>âŒ é”™è¯¯é…ç½®</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attribute">index</span> index.php index.htm index.html;</span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> www.example.com;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">      <span class="attribute">index</span> index.php index.html index.<span class="variable">$geo</span>.html;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> www.example.com;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">      <span class="attribute">index</span> index.php index.htm index.html;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">location</span> /data &#123;</span><br><span class="line">      <span class="attribute">index</span> index.php;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â­• æ­£ç¡®é…ç½®</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attribute">index</span> index.php index.htm index.html index.<span class="variable">$geo</span>.html;</span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> www.example.com;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> www.example.com;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">location</span> /data &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Debugging"><a href="#Debugging" class="headerlink" title="Debugging"></a>Debugging</h2><h3 id="ä½¿ç”¨è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼"><a href="#ä½¿ç”¨è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼" class="headerlink" title="ä½¿ç”¨è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼"></a>ä½¿ç”¨è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼</h3><blockquote>
<p>æ‚¨å¯ä»¥åœ¨ Nginx é…ç½®ä¸­ä½œä¸ºå˜é‡è®¿é—®çš„ä»»ä½•å†…å®¹éƒ½å¯ä»¥è®°å½•,åŒ…æ‹¬éæ ‡å‡†çš„ HTTP æ ‡å¤´ç­‰.å› æ­¤,è¿™æ˜¯ä¸€ç§é’ˆå¯¹ç‰¹å®šæƒ…å†µåˆ›å»ºè‡ªå·±çš„æ—¥å¿—æ ¼å¼çš„ç®€å•æ–¹æ³•.</p>
<p>è¿™å¯¹äºè°ƒè¯•ç‰¹å®šçš„ <code>location</code> æŒ‡ä»¤éå¸¸æœ‰å¸®åŠ©.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é»˜è®¤çš„ä¸»æ—¥å¿—æ ¼å¼æ¥è‡ªNginxå®˜æ–¹ä»“åº“:</span></span><br><span class="line"><span class="attribute">log_format</span> main</span><br><span class="line">                <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &quot;<span class="variable">$request</span>&quot; &#x27;</span></span><br><span class="line">                <span class="string">&#x27;<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &quot;<span class="variable">$http_referer</span>&quot; &#x27;</span></span><br><span class="line">                <span class="string">&#x27;&quot;<span class="variable">$http_user_agent</span>&quot; &quot;<span class="variable">$http_x_forwarded_for</span>&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰©å±•çš„ä¸»æ—¥å¿—æ ¼å¼:</span></span><br><span class="line"><span class="attribute">log_format</span> main-level-<span class="number">0</span></span><br><span class="line">                <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &#x27;</span></span><br><span class="line">                <span class="string">&#x27;&quot;<span class="variable">$request_method</span> <span class="variable">$scheme</span>://<span class="variable">$host</span><span class="variable">$request_uri</span> &#x27;</span></span><br><span class="line">                <span class="string">&#x27;<span class="variable">$server_protocol</span>&quot; <span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &#x27;</span></span><br><span class="line">                <span class="string">&#x27;&quot;<span class="variable">$http_referer</span>&quot; &quot;<span class="variable">$http_user_agent</span>&quot; &#x27;</span></span><br><span class="line">                <span class="string">&#x27;<span class="variable">$request_time</span>&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è°ƒè¯•æ—¥å¿—æ ¼å¼:</span></span><br><span class="line"><span class="attribute">log_format</span> <span class="literal">debug</span>-level-<span class="number">0</span></span><br><span class="line">                <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &#x27;</span></span><br><span class="line">                <span class="string">&#x27;&quot;<span class="variable">$request_method</span> <span class="variable">$scheme</span>://<span class="variable">$host</span><span class="variable">$request_uri</span> &#x27;</span></span><br><span class="line">                <span class="string">&#x27;<span class="variable">$server_protocol</span>&quot; <span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &#x27;</span></span><br><span class="line">                <span class="string">&#x27;<span class="variable">$request_id</span> <span class="variable">$pid</span> <span class="variable">$msec</span> <span class="variable">$request_time</span> &#x27;</span></span><br><span class="line">                <span class="string">&#x27;<span class="variable">$upstream_connect_time</span> <span class="variable">$upstream_header_time</span> &#x27;</span></span><br><span class="line">                <span class="string">&#x27;<span class="variable">$upstream_response_time</span> &quot;<span class="variable">$request_filename</span>&quot; &#x27;</span></span><br><span class="line">                <span class="string">&#x27;<span class="variable">$request_completion</span>&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨è°ƒè¯•æ¨¡å¼æ¥è·Ÿè¸ªæ„å¤–è¡Œä¸º"><a href="#ä½¿ç”¨è°ƒè¯•æ¨¡å¼æ¥è·Ÿè¸ªæ„å¤–è¡Œä¸º" class="headerlink" title="ä½¿ç”¨è°ƒè¯•æ¨¡å¼æ¥è·Ÿè¸ªæ„å¤–è¡Œä¸º"></a>ä½¿ç”¨è°ƒè¯•æ¨¡å¼æ¥è·Ÿè¸ªæ„å¤–è¡Œä¸º</h3><blockquote>
<p>é€šå¸¸,<code>error_log</code> æŒ‡ä»¤æ˜¯åœ¨ <code>main</code> ä¸­æŒ‡å®šçš„,ä½†æ˜¯ä¹Ÿå¯ä»¥åœ¨ <code>server</code> æˆ– <code>location</code> å—ä¸­æŒ‡å®š,å…¨å±€è®¾ç½®å°†è¢«è¦†ç›–,å¹¶ä¸”è¿™ä¸ª <code>error_log</code> æŒ‡ä»¤å°†è®¾ç½®å…¶è‡ªå·±çš„æ—¥å¿—æ–‡ä»¶è·¯å¾„å’Œæ—¥å¿—è®°å½•çº§åˆ«.</p>
<p>å¦‚æœè¦è®°å½• <code>ngx_http_rewrite_module</code> (at the notice level) ,åº”è¯¥åœ¨ <code>http</code>ã€<code>server</code> æˆ– <code>location</code> å—ä¸­å¼€å¯ <code>rewrite_log on;</code>.</p>
<p>æ³¨æ„:</p>
<ul>
<li>æ°¸è¿œä¸è¦å°†è°ƒè¯•æ—¥å¿—è®°å½•ç•™åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„æ–‡ä»¶ä¸Š</li>
<li>ä¸è¦å¿˜è®°åœ¨æµé‡éå¸¸é«˜çš„ç«™ç‚¹ä¸Šæ¢å¤ <code>error_log</code> çš„è°ƒè¯•çº§åˆ«</li>
<li>å¿…é¡»ä½¿ç”¨æ—¥å¿—å›æ»šæ”¿ç­–</li>
</ul>
</blockquote>
<p>ç¤ºä¾‹:</p>
<ul>
<li>å°† debug ä¿¡æ¯å†™å…¥æ–‡ä»¶</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨ç‰¹å®šä¸Šä¸‹æ–‡ä¸­å¼€å¯,ä¾‹å¦‚:</span></span><br><span class="line"><span class="comment">#   - global    - å¯¹å…¨å±€æ—¥å¿—è¿›è¡Œè®°å½•</span></span><br><span class="line"><span class="comment">#   - http      - å¯¹httpåŠå…¶æ‰€æœ‰ä½ç½®çš„æ—¥å¿—è¿›è¡Œè®°å½•</span></span><br><span class="line"><span class="comment">#   - location  - å¯¹ç‰¹å®šä½ç½®çš„æ—¥å¿—è¿›è¡Œè®°å½•</span></span><br><span class="line"><span class="attribute">error_log</span> /var/log/nginx/<span class="literal">error</span>-<span class="literal">debug</span>.log <span class="literal">debug</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>å°† debug ä¿¡æ¯å†™å…¥å†…å­˜</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">error_log</span> memory:<span class="number">32m</span> <span class="literal">debug</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>IP åœ°å€&#x2F;èŒƒå›´çš„è°ƒè¯•æ—¥å¿—:</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">  <span class="attribute">debug_connection</span>    <span class="number">192.168.252.15</span>/<span class="number">32</span>;</span><br><span class="line">  <span class="attribute">debug_connection</span>    <span class="number">10.10.10.0</span>/<span class="number">24</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¸ºä¸åŒæœåŠ¡å™¨è®¾ç½®ä¸åŒ Debug é…ç½®</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">error_log</span> /var/log/nginx/<span class="literal">debug</span>.log <span class="literal">debug</span>;</span><br><span class="line">...</span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="comment">## To enable debugging:</span></span><br><span class="line">    <span class="attribute">error_log</span> /var/log/nginx/domain.com/domain.com-<span class="literal">debug</span>.log <span class="literal">debug</span>;</span><br><span class="line">    <span class="comment">## To disable debugging:</span></span><br><span class="line">    <span class="attribute">error_log</span> /var/log/nginx/domain.com/domain.com-<span class="literal">debug</span>.log;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ ¸å¿ƒè½¬å‚¨"><a href="#æ ¸å¿ƒè½¬å‚¨" class="headerlink" title="æ ¸å¿ƒè½¬å‚¨"></a>æ ¸å¿ƒè½¬å‚¨</h3><blockquote>
<p>æ ¸å¿ƒè½¬å‚¨åŸºæœ¬ä¸Šæ˜¯ç¨‹åºå´©æºƒæ—¶å†…å­˜çš„å¿«ç…§.</p>
<p>Nginx æ˜¯ä¸€ä¸ªéå¸¸ç¨³å®šçš„å®ˆæŠ¤ç¨‹åº,ä½†æ˜¯æœ‰æ—¶å¯èƒ½ä¼šå‘ç”Ÿæ­£åœ¨è¿è¡Œçš„ Nginx è¿›ç¨‹ç‹¬ç‰¹ç»ˆæ­¢çš„æƒ…å†µ.</p>
<p>å¦‚æœè¦ä¿å­˜å†…å­˜è½¬å‚¨,å®ƒå¯ä»¥ç¡®ä¿åº”å¯ç”¨ä¸¤ä¸ªé‡è¦çš„æŒ‡ä»¤,ä½†æ˜¯,ä¸ºäº†æ­£ç¡®å¤„ç†å†…å­˜è½¬å‚¨,éœ€è¦åšä¸€äº›äº‹æƒ…. æœ‰å…³å®ƒçš„å®Œæ•´ä¿¡æ¯,è¯·å‚è§è½¬å‚¨è¿›ç¨‹çš„å†…å­˜(æ¥è‡ªæœ¬æ‰‹å†Œ).</p>
<p>å½“æ‚¨çš„ Nginx å®ä¾‹æ”¶åˆ°æ„å¤–é”™è¯¯æˆ–å´©æºƒæ—¶,åº”å§‹ç»ˆå¯ç”¨æ ¸å¿ƒè½¬å‚¨.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_rlimit_core</span>    <span class="number">500m</span>;</span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span>  <span class="number">65535</span>;</span><br><span class="line"><span class="attribute">working_directory</span>     /var/dump/nginx;</span><br></pre></td></tr></table></figure>

<h2 id="æ€§èƒ½"><a href="#æ€§èƒ½" class="headerlink" title="æ€§èƒ½"></a>æ€§èƒ½</h2><h3 id="å·¥ä½œè¿›ç¨‹æ•°"><a href="#å·¥ä½œè¿›ç¨‹æ•°" class="headerlink" title="å·¥ä½œè¿›ç¨‹æ•°"></a>å·¥ä½œè¿›ç¨‹æ•°</h3><blockquote>
<p><code>worker_processes</code> - ç”¨äºè®¾ç½® Nginx çš„å·¥ä½œè¿›ç¨‹æ•°.</p>
</blockquote>
<ul>
<li>worker_processes çš„é»˜è®¤å€¼ä¸º 1.</li>
<li>è®¾ç½® worker_processes çš„å®‰å…¨åšæ³•æ˜¯å°†å…¶è®¾ä¸º auto,åˆ™å¯åŠ¨ Nginx æ—¶ä¼šè‡ªåŠ¨åˆ†é…å·¥ä½œè¿›ç¨‹æ•°.å½“ç„¶,ä¹Ÿå¯ä»¥æ˜¾ç¤ºçš„è®¾ç½®ä¸€ä¸ªå·¥ä½œè¿›ç¨‹æ•°å€¼.</li>
<li>ä¸€èˆ¬ä¸€ä¸ªè¿›ç¨‹è¶³å¤Ÿäº†,ä½ å¯ä»¥æŠŠè¿æ¥æ•°è®¾å¾—å¾ˆå¤§.(worker_processes: 1,worker_connections: 10,000)å¦‚æœæœ‰ SSLã€gzip è¿™äº›æ¯”è¾ƒæ¶ˆè€— CPU çš„å·¥ä½œ,è€Œä¸”æ˜¯å¤šæ ¸ CPU çš„è¯,å¯ä»¥è®¾ä¸ºå’Œ CPU çš„æ•°é‡ä¸€æ ·.æˆ–è€…è¦å¤„ç†å¾ˆå¤šå¾ˆå¤šçš„å°æ–‡ä»¶,è€Œä¸”æ–‡ä»¶æ€»å¤§å°æ¯”å†…å­˜å¤§å¾ˆå¤šçš„æ—¶å€™,ä¹Ÿå¯ä»¥æŠŠè¿›ç¨‹æ•°å¢åŠ ,ä»¥å……åˆ†åˆ©ç”¨ IO å¸¦å®½(ä¸»è¦ä¼¼ä¹æ˜¯ IO æ“ä½œæœ‰ block)</li>
</ul>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## The safest way:</span></span><br><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"><span class="comment">## VCPU = 4 , expr $(nproc --all) - 1</span></span><br><span class="line"><span class="attribute">worker_processes</span> <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<h3 id="æœ€å¤§è¿æ¥æ•°"><a href="#æœ€å¤§è¿æ¥æ•°" class="headerlink" title="æœ€å¤§è¿æ¥æ•°"></a>æœ€å¤§è¿æ¥æ•°</h3><blockquote>
<p><code>worker_connections</code> - å•ä¸ª Nginx å·¥ä½œè¿›ç¨‹å…è®¸åŒæ—¶å»ºç«‹çš„å¤–éƒ¨è¿æ¥çš„æ•°é‡.æ•°å­—è¶Šå¤§,èƒ½åŒæ—¶å¤„ç†çš„è¿æ¥è¶Šå¤š.</p>
</blockquote>
<p><code>worker_connections</code> ä¸æ˜¯éšä¾¿è®¾ç½®çš„,è€Œæ˜¯ä¸ä¸¤ä¸ªæŒ‡æ ‡æœ‰é‡è¦å…³è”:</p>
<ul>
<li>å†…å­˜<ul>
<li>æ¯ä¸ªè¿æ¥æ•°åˆ†åˆ«å¯¹åº”ä¸€ä¸ª read_eventã€ä¸€ä¸ª write_event äº‹ä»¶,ä¸€ä¸ªè¿æ¥æ•°å¤§æ¦‚å ç”¨ 232 å­—èŠ‚,2 ä¸ªäº‹ä»¶æ€»å ç”¨ 96 å­—èŠ‚,é‚£ä¹ˆä¸€ä¸ªè¿æ¥æ€»å…±å ç”¨ 328 å­—èŠ‚,é€šè¿‡æ•°å­¦å…¬å¼å¯ä»¥ç®—å‡º 100000 ä¸ªè¿æ¥æ•°å¤§æ¦‚ä¼šå ç”¨ 31M &#x3D; 100000 * 328 &#x2F; 1024 &#x2F; 1024,å½“ç„¶è¿™åªæ˜¯ nginx å¯åŠ¨æ—¶,worker_connections è¿æ¥æ•°æ‰€å ç”¨çš„ nginx.</li>
</ul>
</li>
<li>æ“ä½œç³»ç»Ÿçº§åˆ«â€è¿›ç¨‹æœ€å¤§å¯æ‰“å¼€æ–‡ä»¶æ•°â€.<ul>
<li>è¿›ç¨‹æœ€å¤§å¯æ‰“å¼€æ–‡ä»¶æ•°å—é™äºæ“ä½œç³»ç»Ÿ,å¯é€šè¿‡ <code>ulimit -n</code> å‘½ä»¤æŸ¥è¯¢,ä»¥å‰æ˜¯ 1024,ç°åœ¨æ˜¯ 65535.</li>
<li>nginx æä¾›äº† worker_rlimit_nofile æŒ‡ä»¤,è¿™æ˜¯é™¤äº† ulimit çš„ä¸€ç§è®¾ç½®å¯ç”¨çš„æè¿°ç¬¦çš„æ–¹å¼. è¯¥æŒ‡ä»¤ä¸ä½¿ç”¨ ulimit å¯¹ç”¨æˆ·çš„è®¾ç½®æ˜¯åŒæ ·çš„æ•ˆæœ.æ­¤æŒ‡ä»¤çš„å€¼å°†è¦†ç›– ulimit çš„å€¼,å¦‚:worker_rlimit_nofile 20960; è®¾ç½® ulimits:ulimit -SHn 65535</li>
</ul>
</li>
</ul>
<h3 id="ä½¿ç”¨-HTTP-2"><a href="#ä½¿ç”¨-HTTP-2" class="headerlink" title="ä½¿ç”¨ HTTP&#x2F;2"></a>ä½¿ç”¨ HTTP&#x2F;2</h3><blockquote>
<p>HTTP &#x2F; 2 å°†ä½¿æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ›´å¿«,æ›´ç®€å•ä¸”æ›´å¯é . HTTP &#x2F; 2 çš„ä¸»è¦ç›®æ ‡æ˜¯é€šè¿‡å¯ç”¨å®Œæ•´çš„è¯·æ±‚å’Œå“åº”å¤šè·¯å¤ç”¨æ¥å‡å°‘å»¶è¿Ÿ,é€šè¿‡æœ‰æ•ˆå‹ç¼© HTTP æ ‡å¤´å­—æ®µæ¥æœ€å°åŒ–åè®®å¼€é”€,å¹¶å¢åŠ å¯¹è¯·æ±‚ä¼˜å…ˆçº§å’ŒæœåŠ¡å™¨æ¨é€çš„æ”¯æŒ.</p>
<p>HTTP &#x2F; 2 ä¸ HTTP &#x2F; 1.1 å‘åå…¼å®¹,å› æ­¤æœ‰å¯èƒ½å®Œå…¨å¿½ç•¥å®ƒ,å¹¶ä¸”ä¸€åˆ‡éƒ½ä¼šåƒä»¥å‰ä¸€æ ·ç»§ç»­å·¥ä½œ,å› ä¸ºå¦‚æœä¸æ”¯æŒ HTTP &#x2F; 2 çš„å®¢æˆ·ç«¯æ°¸è¿œä¸ä¼šå‘æœåŠ¡å™¨è¯·æ±‚ HTTP &#x2F; 2 é€šè®¯å‡çº§:å®ƒä»¬ä¹‹é—´çš„é€šè®¯å°†å®Œå…¨æ˜¯ HTTP1 &#x2F; 1.</p>
<p>è¯·æ³¨æ„,HTTP &#x2F; 2 åœ¨å•ä¸ª TCP è¿æ¥ä¸­å¤šè·¯å¤ç”¨è®¸å¤šè¯·æ±‚. é€šå¸¸,å½“ä½¿ç”¨ HTTP &#x2F; 2 æ—¶,å°†ä¸æœåŠ¡å™¨å»ºç«‹å•ä¸ª TCP è¿æ¥.</p>
<p>æ‚¨è¿˜åº”è¯¥åŒ…æ‹¬ ssl å‚æ•°,è¿™æ˜¯å¿…éœ€çš„,å› ä¸ºæµè§ˆå™¨ä¸æ”¯æŒæœªç»åŠ å¯†çš„ HTTP &#x2F; 2.</p>
<p>HTTP &#x2F; 2 å¯¹æ—§çš„å’Œä¸å®‰å…¨çš„å¯†ç æœ‰ä¸€ä¸ªéå¸¸å¤§çš„é»‘åå•,å› æ­¤æ‚¨åº”è¯¥é¿å…ä½¿ç”¨å®ƒä»¬.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">10.240.20.2:443</span> ssl http2;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<h3 id="ç»´æŠ¤-SSL-ä¼šè¯"><a href="#ç»´æŠ¤-SSL-ä¼šè¯" class="headerlink" title="ç»´æŠ¤ SSL ä¼šè¯"></a>ç»´æŠ¤ SSL ä¼šè¯</h3><blockquote>
<p>å®¢æˆ·ç«¯æ¯æ¬¡å‘å‡ºè¯·æ±‚æ—¶éƒ½è¿›è¡Œæ–°çš„ SSL æ¡æ‰‹çš„éœ€æ±‚.é»˜è®¤æƒ…å†µä¸‹,å†…ç½®ä¼šè¯ç¼“å­˜å¹¶ä¸æ˜¯æœ€ä½³é€‰æ‹©,å› ä¸ºå®ƒåªèƒ½ç”±ä¸€ä¸ªå·¥ä½œè¿›ç¨‹ä½¿ç”¨,å¹¶ä¸”å¯èƒ½å¯¼è‡´å†…å­˜ç¢ç‰‡,æœ€å¥½ä½¿ç”¨å…±äº«ç¼“å­˜.</p>
<p>ä½¿ç”¨ <code>ssl_session_cache</code> æ—¶,é€šè¿‡ SSL ä¿æŒè¿æ¥çš„æ€§èƒ½å¯èƒ½ä¼šå¤§å¤§æé«˜.10M çš„å€¼æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹(1MB å…±äº«ç¼“å­˜å¯ä»¥å®¹çº³å¤§çº¦ 4,000 ä¸ªä¼šè¯).é€šè¿‡å…±äº«,æ‰€æœ‰å·¥ä½œè¿›ç¨‹ä¹‹é—´å…±äº«ä¸€ä¸ªç¼“å­˜(å¯ä»¥åœ¨å¤šä¸ªè™šæ‹ŸæœåŠ¡å™¨ä¸­ä½¿ç”¨ç›¸åŒåç§°çš„ç¼“å­˜).</p>
<p>ä½†æ˜¯,å¤§å¤šæ•°æœåŠ¡å™¨ä¸æ¸…é™¤ä¼šè¯æˆ–ç¥¨è¯å¯†é’¥,å› æ­¤å¢åŠ äº†æœåŠ¡å™¨å—åˆ°æŸå®³å°†æ³„æ¼å…ˆå‰(å’Œå°†æ¥)è¿æ¥ä¸­çš„æ•°æ®çš„é£é™©.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ssl_session_cache</span>   shared:NGX_SSL_CACHE:<span class="number">10m</span>;</span><br><span class="line"><span class="attribute">ssl_session_timeout</span> <span class="number">12h</span>;</span><br><span class="line"><span class="attribute">ssl_session_tickets</span> <span class="literal">off</span>;</span><br><span class="line"><span class="attribute">ssl_buffer_size</span>     <span class="number">1400</span>;</span><br></pre></td></tr></table></figure>

<h4 id="å°½å¯èƒ½åœ¨-server-name-æŒ‡ä»¤ä¸­ä½¿ç”¨ç¡®åˆ‡åç§°"><a href="#å°½å¯èƒ½åœ¨-server-name-æŒ‡ä»¤ä¸­ä½¿ç”¨ç¡®åˆ‡åç§°" class="headerlink" title="å°½å¯èƒ½åœ¨ server_name æŒ‡ä»¤ä¸­ä½¿ç”¨ç¡®åˆ‡åç§°"></a>å°½å¯èƒ½åœ¨ server_name æŒ‡ä»¤ä¸­ä½¿ç”¨ç¡®åˆ‡åç§°</h4><blockquote>
<p>ç¡®åˆ‡åç§°,ä»¥æ˜Ÿå·å¼€å¤´çš„é€šé…ç¬¦åç§°å’Œä»¥æ˜Ÿå·ç»“å°¾çš„é€šé…ç¬¦åç§°å­˜å‚¨åœ¨ç»‘å®šåˆ°ä¾¦å¬ç«¯å£çš„ä¸‰ä¸ªå“ˆå¸Œè¡¨ä¸­.</p>
<p>é¦–å…ˆæœç´¢ç¡®åˆ‡åç§°å“ˆå¸Œè¡¨. å¦‚æœæœªæ‰¾åˆ°åç§°,åˆ™æœç´¢å…·æœ‰ä»¥æ˜Ÿå·å¼€å¤´çš„é€šé…ç¬¦åç§°çš„å“ˆå¸Œè¡¨. å¦‚æœæœªåœ¨æ­¤å¤„æ‰¾åˆ°åç§°,åˆ™æœç´¢å¸¦æœ‰é€šé…ç¬¦åç§°ä»¥æ˜Ÿå·ç»“å°¾çš„å“ˆå¸Œè¡¨. æœç´¢é€šé…ç¬¦åç§°å“ˆå¸Œè¡¨æ¯”æœç´¢ç²¾ç¡®åç§°å“ˆå¸Œè¡¨è¦æ…¢,å› ä¸ºåç§°æ˜¯æŒ‰åŸŸéƒ¨åˆ†æœç´¢çš„.</p>
<p>æ­£åˆ™è¡¨è¾¾å¼æ˜¯æŒ‰é¡ºåºæµ‹è¯•çš„,å› æ­¤æ˜¯æœ€æ…¢çš„æ–¹æ³•,å¹¶ä¸”ä¸å¯ç¼©æ”¾.ç”±äºè¿™äº›åŸå› ,æœ€å¥½åœ¨å¯èƒ½çš„åœ°æ–¹ä½¿ç”¨ç¡®åˆ‡çš„åç§°.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ˜¾å¼åœ°å®šä¹‰å®ƒä»¬æ›´ä¸ºé«˜æ•ˆ:</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">192.168.252.10:80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  example.org  www.example.org  <span class="regexp">*.example.org</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># ä¸ä½¿ç”¨ç®€åŒ–å½¢å¼ç›¸æ¯”:</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">192.168.252.10:80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  .example.org;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é¿å…ä½¿ç”¨-if-æ£€æŸ¥-server-name"><a href="#é¿å…ä½¿ç”¨-if-æ£€æŸ¥-server-name" class="headerlink" title="é¿å…ä½¿ç”¨ if æ£€æŸ¥ server_name"></a>é¿å…ä½¿ç”¨ <code>if</code> æ£€æŸ¥ <code>server_name</code></h3><blockquote>
<p>å½“ Nginx æ”¶åˆ°è¯·æ±‚æ—¶,æ— è®ºè¯·æ±‚çš„æ˜¯å“ªä¸ªå­åŸŸ,æ— è®ºæ˜¯ <a target="_blank" rel="noopener" href="http://www.example.com/">www.example.com</a> è¿˜æ˜¯æ™®é€šçš„ example.com,å¦‚æœå§‹ç»ˆå¯¹ if æŒ‡ä»¤è¿›è¡Œè¯„ä¼°. ç”±äºæ‚¨æ˜¯åœ¨è¯·æ±‚ Nginx æ£€æŸ¥æ¯ä¸ªè¯·æ±‚çš„ Host æ ‡å¤´. æ•ˆç‡æä½.</p>
<p>è€Œæ˜¯ä½¿ç”¨ä¸¤ä¸ªæœåŠ¡å™¨æŒ‡ä»¤,å¦‚ä¸‹é¢çš„ç¤ºä¾‹. è¿™ç§æ–¹æ³•é™ä½äº† Nginx çš„å¤„ç†è¦æ±‚.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<p>âŒ é”™è¯¯é…ç½®</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">server_name</span>   domain.com www.domain.com;</span><br><span class="line">  <span class="attribute">if</span> (<span class="variable">$host</span> = www.domain.com) &#123;</span><br><span class="line">    <span class="attribute">return</span>  <span class="number">301</span> https://domain.com<span class="variable">$request_uri</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="attribute">server_name</span>  domain.com;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â­• æ­£ç¡®é…ç½®</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="comment"># æœåŠ¡å™¨åŸŸå</span></span><br><span class="line">    <span class="attribute">server_name</span> www.domain.com;</span><br><span class="line">    <span class="comment"># é‡å®šå‘æ‰€æœ‰è¯·æ±‚åˆ°ä¸»åŸŸå</span></span><br><span class="line">    <span class="attribute">return</span>  <span class="number">301</span> <span class="variable">$scheme</span>://domain.com<span class="variable">$request_uri</span>;</span><br><span class="line">    <span class="comment">## å¦‚æœä½ å¼ºåˆ¶ä½ çš„ç½‘ç«™æµé‡ä½¿ç”¨HTTPS:</span></span><br><span class="line">    <span class="comment">## 301 https://domain.com$request_uri;   </span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="comment"># ç›‘å¬ç«¯å£å’ŒIP</span></span><br><span class="line">    <span class="attribute">listen</span>                    <span class="number">192.168.252.10:80</span>;</span><br><span class="line">    <span class="comment"># ä¸»æœåŠ¡å™¨åŸŸå</span></span><br><span class="line">    <span class="attribute">server_name</span>               domain.com;   </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨-request-uri-æ¥é¿å…ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼"><a href="#ä½¿ç”¨-request-uri-æ¥é¿å…ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼" class="headerlink" title="ä½¿ç”¨ $request_uri æ¥é¿å…ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼"></a>ä½¿ç”¨ <code>$request_uri</code> æ¥é¿å…ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼</h3><blockquote>
<p>ä½¿ç”¨å†…ç½®å˜é‡ <code>$request_uri</code>,æˆ‘ä»¬å¯ä»¥å®Œå…¨é¿å…è¿›è¡Œä»»ä½•æ•è·æˆ–åŒ¹é….é»˜è®¤æƒ…å†µä¸‹,æ­£åˆ™è¡¨è¾¾å¼çš„ä»£ä»·è¾ƒé«˜,å¹¶ä¸”ä¼šé™ä½æ€§èƒ½.</p>
<p>æ­¤è§„åˆ™ç”¨äºè§£å†³å°† URL ä¸å˜åœ°ä¼ é€’åˆ°æ–°ä¸»æœº,ç¡®ä¿ä»…é€šè¿‡ç°æœ‰ URI è¿›è¡Œè¿”å›çš„æ•ˆç‡æ›´é«˜.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<p>âŒ é”™è¯¯é…ç½®</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 1)</span></span><br><span class="line"><span class="attribute">rewrite</span><span class="regexp"> ^/(.*)$</span> https://example.com/<span class="variable">$1</span> <span class="literal">permanent</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 2)</span></span><br><span class="line"><span class="attribute">rewrite</span><span class="regexp"> ^</span> https://example.com<span class="variable">$request_uri</span>? <span class="literal">permanent</span>;</span><br></pre></td></tr></table></figure>

<p>â­• æ­£ç¡®é…ç½®</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">return</span> <span class="number">301</span> https://example.com<span class="variable">$request_uri</span>;</span><br></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨-try-files-æŒ‡ä»¤ç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨"><a href="#ä½¿ç”¨-try-files-æŒ‡ä»¤ç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨" class="headerlink" title="ä½¿ç”¨ try_files æŒ‡ä»¤ç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨"></a>ä½¿ç”¨ <code>try_files</code> æŒ‡ä»¤ç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨</h3><blockquote>
<p><code>try_files</code>ç»å¯¹æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æŒ‡ä»¤.ä½ å¯ä»¥ä½¿ç”¨<code>try_files</code>æŒ‡ä»¤æŒ‰ç…§æŒ‡å®šçš„é¡ºåºæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨.<br>ä½ åº”è¯¥ä½¿ç”¨<code>try_files</code>è€Œä¸æ˜¯<code>if</code>æŒ‡ä»¤.ä½¿ç”¨<code>try_files</code>å®Œæˆè¿™ä¸ªæ“ä½œç»å¯¹æ¯”ä½¿ç”¨<code>if</code>æ›´å¥½,å› ä¸º<code>if</code>æŒ‡ä»¤éå¸¸ä½æ•ˆ,å®ƒä¼šåœ¨æ¯ä¸ªè¯·æ±‚æ—¶éƒ½è¢«è¯„ä¼°.<br>ä½¿ç”¨<code>try_files</code>çš„ä¼˜åŠ¿åœ¨äº,åªéœ€ä¸€ä¸ªå‘½ä»¤è¡Œä¸ºå°±ä¼šç«‹å³åˆ‡æ¢.æˆ‘è®¤ä¸ºä»£ç çš„å¯è¯»æ€§ä¹Ÿæ›´å¼º.<br><code>try_files</code>å…è®¸ä½ :</p>
<ul>
<li>ä»é¢„å®šä¹‰åˆ—è¡¨ä¸­æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨</li>
<li>ä»æŒ‡å®šç›®å½•æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨</li>
<li>å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ–‡ä»¶,ä½¿ç”¨å†…éƒ¨é‡å®šå‘</li>
</ul>
</blockquote>
<p>ç¤ºä¾‹:</p>
<p>âŒ é”™è¯¯é…ç½®</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  ...</span><br><span class="line">  <span class="attribute">root</span> /var/www/example.com;</span><br><span class="line">  <span class="section">location</span> /images &#123;</span><br><span class="line">    <span class="attribute">if</span> (-f <span class="variable">$request_filename</span>) &#123;</span><br><span class="line">      <span class="attribute">expires</span> <span class="number">30d</span>;</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â­• æ­£ç¡®é…ç½®</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  ...</span><br><span class="line">  <span class="attribute">root</span> /var/www/example.com;</span><br><span class="line">  <span class="section">location</span> /images &#123;</span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> =<span class="number">404</span>;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨-return-ä»£æ›¿-rewrite-æ¥åšé‡å®šå‘"><a href="#ä½¿ç”¨-return-ä»£æ›¿-rewrite-æ¥åšé‡å®šå‘" class="headerlink" title="ä½¿ç”¨ return ä»£æ›¿ rewrite æ¥åšé‡å®šå‘"></a>ä½¿ç”¨ return ä»£æ›¿ rewrite æ¥åšé‡å®šå‘</h3><blockquote>
<p>æ‚¨åº”è¯¥ä½¿ç”¨æœåŠ¡å™¨å—å’Œ return è¯­å¥,å› ä¸ºå®ƒä»¬æ¯”é€šè¿‡ä½ç½®å—è¯„ä¼° RegEx æ›´ç®€å•,æ›´å¿«æ·. è¯¥æŒ‡ä»¤åœæ­¢å¤„ç†,å¹¶å°†æŒ‡å®šçš„ä»£ç è¿”å›ç»™å®¢æˆ·ç«¯.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<p>âŒ é”™è¯¯é…ç½®</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attribute">if</span> (<span class="variable">$host</span> = api.domain.com) &#123;</span><br><span class="line">    <span class="attribute">rewrite</span>    <span class="regexp"> ^/(.*)$</span> http://example.com/<span class="variable">$1</span> <span class="literal">permanent</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>â­• æ­£ç¡®é…ç½®</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment"># å¦‚æœè¯·æ±‚çš„ä¸»æœºåæ˜¯api.domain.com,åˆ™è¿”å›403ç¦æ­¢è®¿é—®</span></span><br><span class="line">  <span class="attribute">if</span> (<span class="variable">$host</span> = api.domain.com) &#123;</span><br><span class="line">    <span class="attribute">return</span>      <span class="number">403</span>;</span><br><span class="line">    <span class="comment"># æˆ–è€…å…¶ä»–ä¾‹å­:</span></span><br><span class="line">    <span class="comment">#   å¦‚æœè¯·æ±‚çš„ä¸»æœºåæ˜¯api.domain.com,åˆ™é‡å®šå‘åˆ°https://domain.com$request_uri</span></span><br><span class="line">    <span class="comment">#   return 301 https://domain.com$request_uri;</span></span><br><span class="line">    <span class="comment">#   æˆ–è€…ä½¿ç”¨å½“å‰çš„æ–¹æ¡ˆå’Œä¸»æœºåè¿›è¡Œé‡å®šå‘</span></span><br><span class="line">    <span class="comment">#   return   301 $scheme://$host$request_uri;</span></span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¼€å¯-PCRE-JIT-æ¥åŠ é€Ÿæ­£åˆ™è¡¨è¾¾å¼å¤„ç†"><a href="#å¼€å¯-PCRE-JIT-æ¥åŠ é€Ÿæ­£åˆ™è¡¨è¾¾å¼å¤„ç†" class="headerlink" title="å¼€å¯ PCRE JIT æ¥åŠ é€Ÿæ­£åˆ™è¡¨è¾¾å¼å¤„ç†"></a>å¼€å¯ PCRE JIT æ¥åŠ é€Ÿæ­£åˆ™è¡¨è¾¾å¼å¤„ç†</h3><blockquote>
<p>å…è®¸ä½¿ç”¨ JIT çš„æ­£åˆ™è¡¨è¾¾å¼æ¥åŠ é€Ÿä»–ä»¬çš„å¤„ç†.</p>
<p>é€šè¿‡ä¸ PCRE åº“ç¼–è¯‘ Nginx çš„,ä½ å¯ä»¥ç”¨ä½ çš„ location å—è¿›è¡Œå¤æ‚çš„æ“ä½œå’Œä½¿ç”¨åŠŸèƒ½å¼ºå¤§çš„ return å’Œ rewrite.</p>
<p>PCRE JIT å¯ä»¥æ˜¾è‘—åŠ å¿«æ­£åˆ™è¡¨è¾¾å¼çš„å¤„ç†. Nginx çš„ä¸ pcre_jit æ¯”æ²¡æœ‰æ›´å¿«çš„å¹…åº¦.</p>
<p>å¦‚æœä½ è¯•å›¾åœ¨ä½¿ç”¨ pcre_jit;æ²¡æœ‰å¯ç”¨çš„ JIT,æˆ–è€… Nginx çš„ä¸ç°æœ‰ JIT,ä½†å½“å‰åŠ è½½ PCRE åº“ç¼–è¯‘ä¸æ”¯æŒ JIT,å°†é…ç½®è§£ææ—¶å‘å‡ºè­¦å‘Š.</p>
<p>å½“æ‚¨ç¼–è¯‘ä½¿ç”¨ NGNIX é…ç½® PCRE åº“æ—¶,æ‰éœ€è¦â€“with-PCRE-JIT æ—¶(.&#x2F;configure â€“with-PCRE &#x3D;).å½“ä½¿ç”¨ç³»ç»Ÿ PCRE åº“ JIT æ˜¯å¦è¢«æ”¯æŒä¾èµ–äºåº“æ˜¯å¦‚ä½•è¢«ç¼–è¯‘.</p>
<p>ä» Nginx çš„æ–‡æ¡£:</p>
<p>JIT æ­£åœ¨ä»ä¸â€“enable-JIT é…ç½®å‚æ•°å†…ç½® 8.20 ç‰ˆæœ¬å¼€å§‹ PCRE åº“æä¾›.å½“ PCRE åº“ä¸ nginx çš„å†…ç½®(â€“with-PCRE &#x3D;)æ—¶,JIT æ”¯æŒç»ç”±â€“with-PCRE-JIT é…ç½®å‚æ•°ä½¿èƒ½.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## In global context:</span></span><br><span class="line"><span class="attribute">pcre_jit</span> <span class="literal">on</span>;</span><br></pre></td></tr></table></figure>

<h4 id="è¿›è¡Œç²¾ç¡®çš„ä½ç½®åŒ¹é…ä»¥åŠ å¿«é€‰æ‹©è¿‡ç¨‹"><a href="#è¿›è¡Œç²¾ç¡®çš„ä½ç½®åŒ¹é…ä»¥åŠ å¿«é€‰æ‹©è¿‡ç¨‹" class="headerlink" title="è¿›è¡Œç²¾ç¡®çš„ä½ç½®åŒ¹é…ä»¥åŠ å¿«é€‰æ‹©è¿‡ç¨‹"></a>è¿›è¡Œç²¾ç¡®çš„ä½ç½®åŒ¹é…ä»¥åŠ å¿«é€‰æ‹©è¿‡ç¨‹</h4><blockquote>
<p>ç²¾ç¡®çš„ä½ç½®åŒ¹é…é€šå¸¸ç”¨äºé€šè¿‡ç«‹å³ç»“æŸç®—æ³•çš„æ‰§è¡Œæ¥åŠ å¿«é€‰æ‹©è¿‡ç¨‹.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»…åŒ¹é…æŸ¥è¯¢ / å¹¶åœæ­¢æœç´¢:</span></span><br><span class="line"><span class="section">location</span> = / &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># ä»…åŒ¹é…æŸ¥è¯¢ /v9 å¹¶åœæ­¢æœç´¢:</span></span><br><span class="line"><span class="section">location</span> = /v9 &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="comment"># åŒ¹é…ä»»ä½•æŸ¥è¯¢,å› ä¸ºæ‰€æœ‰æŸ¥è¯¢éƒ½ä» / å¼€å§‹,</span></span><br><span class="line"><span class="comment"># ä½†æ˜¯æ­£åˆ™è¡¨è¾¾å¼å’Œä»»ä½•æ›´é•¿çš„å¸¸è§„å—å°†é¦–å…ˆè¢«åŒ¹é…:</span></span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ä½¿ç”¨-limit-conn-æ”¹å–„å¯¹ä¸‹è½½é€Ÿåº¦çš„é™åˆ¶"><a href="#ä½¿ç”¨-limit-conn-æ”¹å–„å¯¹ä¸‹è½½é€Ÿåº¦çš„é™åˆ¶" class="headerlink" title="ä½¿ç”¨ limit_conn æ”¹å–„å¯¹ä¸‹è½½é€Ÿåº¦çš„é™åˆ¶"></a>ä½¿ç”¨ <code>limit_conn</code> æ”¹å–„å¯¹ä¸‹è½½é€Ÿåº¦çš„é™åˆ¶</h4><blockquote>
<p>Nginx provides two directives to limiting download speed:</p>
<p>Nginx æä¾›äº†ä¸¤ä¸ªæŒ‡ä»¤æ¥é™åˆ¶ä¸‹è½½é€Ÿåº¦:</p>
<ul>
<li><code>limit_rate_after</code> - è®¾ç½® limit_rate æŒ‡ä»¤ç”Ÿæ•ˆä¹‹å‰ä¼ è¾“çš„æ•°æ®é‡</li>
<li><code>limit_rate</code> - å…è®¸æ‚¨é™åˆ¶å•ä¸ªå®¢æˆ·ç«¯è¿æ¥çš„ä¼ è¾“é€Ÿç‡</li>
</ul>
</blockquote>
<blockquote>
<p>æ­¤è§£å†³æ–¹æ¡ˆé™åˆ¶äº†æ¯ä¸ªè¿æ¥çš„ Nginx ä¸‹è½½é€Ÿåº¦,å› æ­¤,å¦‚æœä¸€ä¸ªç”¨æˆ·æ‰“å¼€å¤šä¸ª(ä¾‹å¦‚) è§†é¢‘æ–‡ä»¶,åˆ™å¯ä»¥ä¸‹è½½ <code>X * è¿æ¥åˆ°è§†é¢‘æ–‡ä»¶çš„æ¬¡æ•°</code> .</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºè¿æ¥æ•°é™åˆ¶åŒºåŸŸ:</span></span><br><span class="line"><span class="attribute">limit_conn_zone</span> <span class="variable">$binary_remote_addr</span> zone=conn_for_remote_addr:<span class="number">1m</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ è§„åˆ™ä»¥é™åˆ¶ä¸‹è½½é€Ÿåº¦:</span></span><br><span class="line"><span class="attribute">limit_rate_after</span> <span class="number">1m</span>;  <span class="comment"># å‰ 1 å…†å­—èŠ‚ä»¥æœ€å¤§é€Ÿåº¦è¿è¡Œ</span></span><br><span class="line"><span class="attribute">limit_rate</span> <span class="number">250k</span>;      <span class="comment"># ä¹‹åè®¾ç½®é€Ÿç‡é™åˆ¶ä¸ºæ¯ç§’ 250 åƒå­—èŠ‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨æ’é˜Ÿ:</span></span><br><span class="line"><span class="section">location</span> /videos &#123;</span><br><span class="line">  <span class="comment"># å•ä¸€å®¢æˆ·ç«¯çš„æœ€å¤§æ•°æ®é‡:10 å…†å­—èŠ‚(limit_rate_after * 10)</span></span><br><span class="line">  <span class="attribute">limit_conn</span> conn_for_remote_addr <span class="number">10</span>;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åå‘ä»£ç†"><a href="#åå‘ä»£ç†" class="headerlink" title="åå‘ä»£ç†"></a>åå‘ä»£ç†</h2><h3 id="ä½¿ç”¨ä¸åç«¯åè®®å…¼å®¹çš„-pass-æŒ‡ä»¤"><a href="#ä½¿ç”¨ä¸åç«¯åè®®å…¼å®¹çš„-pass-æŒ‡ä»¤" class="headerlink" title="ä½¿ç”¨ä¸åç«¯åè®®å…¼å®¹çš„ pass æŒ‡ä»¤"></a>ä½¿ç”¨ä¸åç«¯åè®®å…¼å®¹çš„ pass æŒ‡ä»¤</h3><blockquote>
<p>æ‰€æœ‰ <code>proxy_*</code> æŒ‡ä»¤éƒ½ä¸ä½¿ç”¨ç‰¹å®šåç«¯åè®®çš„åç«¯æœåŠ¡å™¨æœ‰å…³.<br>æ‚¨åº”è¯¥ä»…å¯¹åœ¨åç«¯å±‚å·¥ä½œçš„ HTTP æœåŠ¡å™¨ä½¿ç”¨ <code>proxy_pass</code>(åœ¨å¼•ç”¨ HTTP åç«¯å‰è®¾ç½® <code>http://</code> åè®®),<br>å¯¹äºé HTTP åç«¯æœåŠ¡å™¨(å¦‚ uWSGI æˆ– FastCGI)åˆ™ä½¿ç”¨å…¶ä»–çš„ <code>*_pass</code> æŒ‡ä»¤.<br><code>uwsgi_pass</code>ã€<code>fastcgi_pass</code> æˆ– <code>scgi_pass</code> ç­‰æŒ‡ä»¤ä¸“ä¸ºé HTTP åº”ç”¨ç¨‹åºè®¾è®¡,<br>æ‚¨åº”è¯¥ä½¿ç”¨å®ƒä»¬è€Œä¸æ˜¯ <code>proxy_pass</code>(é HTTP é€šä¿¡).<br>ä¾‹å¦‚:<code>uwsgi_pass</code> ä½¿ç”¨ uwsgi åè®®ä¸æœåŠ¡å™¨é€šä¿¡.<code>proxy_pass</code> ä½¿ç”¨æ™®é€š HTTP ä¸ uWSGI æœåŠ¡å™¨é€šä¿¡.<br>uWSGI æ–‡æ¡£å£°ç§° uwsgi åè®®æ›´å¥½ã€æ›´å¿«,å¹¶ä¸”å¯ä»¥åˆ©ç”¨ uWSGI çš„æ‰€æœ‰ç‰¹æ®ŠåŠŸèƒ½.<br>æ‚¨å¯ä»¥å‘é€ä¿¡æ¯åˆ° uWSGI,å‘ŠçŸ¥æ‚¨æ­£åœ¨å‘é€ä½•ç§ç±»å‹çš„æ•°æ®ä»¥åŠåº”è°ƒç”¨å“ªä¸ª uWSGI æ’ä»¶æ¥ç”Ÿæˆå“åº”.<br>ä½¿ç”¨ http(<code>proxy_pass</code>)å°±æ— æ³•åšåˆ°è¿™ä¸€ç‚¹.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<p>âŒ é”™è¯¯é…ç½®</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="section">location</span> /app/ &#123;</span><br><span class="line">    <span class="comment"># å¯¹äºè¿™ä¸ª,ä½ åº”è¯¥ä½¿ç”¨ uwsgi_pass æŒ‡ä»¤.</span></span><br><span class="line">    <span class="attribute">uwsgi_pass</span>      <span class="number">192.168.154.102:4000</span>;  <span class="comment"># åç«¯å±‚:uWSGI Python åº”ç”¨.</span></span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â­• æ­£ç¡®é…ç½®</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="section">location</span> /app/ &#123;</span><br><span class="line">    <span class="comment"># åç«¯å±‚:OpenResty ä½œä¸ºåº”ç”¨çš„å‰ç«¯.</span></span><br><span class="line">    <span class="attribute">proxy_pass</span> http://192.168.154.102:80;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="section">location</span> /app/v3 &#123;</span><br><span class="line">    <span class="comment"># åç«¯å±‚:uWSGI Python åº”ç”¨.</span></span><br><span class="line">    <span class="attribute">uwsgi_pass</span> <span class="number">192.168.154.102:8080</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="section">location</span> /app/v4 &#123;</span><br><span class="line">    <span class="comment"># åç«¯å±‚:php-fpm åº”ç”¨.</span></span><br><span class="line">    <span class="attribute">fastcgi_pass</span> <span class="number">192.168.154.102:8081</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å°å¿ƒ-proxy-pass-æŒ‡ä»¤ä¸­çš„æ–œæ "><a href="#å°å¿ƒ-proxy-pass-æŒ‡ä»¤ä¸­çš„æ–œæ " class="headerlink" title="å°å¿ƒ proxy_pass æŒ‡ä»¤ä¸­çš„æ–œæ "></a>å°å¿ƒ <code>proxy_pass</code> æŒ‡ä»¤ä¸­çš„æ–œæ </h3><blockquote>
<p>æ³¨æ„å°¾éšæ–œæ ,å› ä¸º Nginx ä¼šé€å­—æ›¿æ¢éƒ¨åˆ†,å¹¶ä¸”æ‚¨å¯èƒ½ä¼šå¾—åˆ°ä¸€äº›å¥‡æ€ªçš„ URL.</p>
<p>å¦‚æœ proxy_pass ä¸å¸¦ URI ä½¿ç”¨(å³ server:port ä¹‹åæ²¡æœ‰è·¯å¾„),Nginx ä¼šå°†åŸå§‹è¯·æ±‚ä¸­çš„ URI ä¸æ‰€æœ‰åŒæ–œæ  <code>../</code> å®Œå…¨ä¸€æ ·.</p>
<p><code>proxy_pass</code> ä¸­çš„ URI å°±åƒåˆ«åæŒ‡ä»¤ä¸€æ ·,æ„å‘³ç€ Nginx å°†ç”¨ <code>proxy_pass</code> æŒ‡ä»¤ä¸­çš„ URI æ›¿æ¢ä¸ä½ç½®å‰ç¼€åŒ¹é…çš„éƒ¨åˆ†(æˆ‘æ•…æ„å°†å…¶ä¸ä½ç½®å‰ç¼€ç›¸åŒ),å› æ­¤ URI å°†ä¸è¯·æ±‚çš„ç›¸åŒ,ä½†è¢«è§„èŒƒåŒ–(æ²¡æœ‰å°å†™æ–œæ å’Œå…¶ä»–æ‰€æœ‰å†…å®¹) å‘˜å·¥).</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> = /a &#123;</span><br><span class="line">  <span class="attribute">proxy_pass</span> http://127.0.0.1:8080/a;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span><span class="regexp"> ^~</span> /a/ &#123;</span><br><span class="line">  <span class="attribute">proxy_pass</span> http://127.0.0.1:8080/a/;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ä»…ä½¿ç”¨-host-å˜é‡è®¾ç½®å’Œä¼ é€’-Host-å¤´"><a href="#ä»…ä½¿ç”¨-host-å˜é‡è®¾ç½®å’Œä¼ é€’-Host-å¤´" class="headerlink" title="ä»…ä½¿ç”¨ $host å˜é‡è®¾ç½®å’Œä¼ é€’ Host å¤´"></a>ä»…ä½¿ç”¨ <code>$host</code> å˜é‡è®¾ç½®å’Œä¼ é€’ Host å¤´</h4><blockquote>
<p>å‡ ä¹åº”è¯¥å§‹ç»ˆå°† <code>$host</code> ç”¨ä½œä¼ å…¥çš„ä¸»æœºå˜é‡,å› ä¸ºæ— è®ºç”¨æˆ·ä»£ç†å¦‚ä½•è¡Œä¸º,å®ƒéƒ½æ˜¯ä¿è¯å…·æœ‰æŸç§æ„ä¹‰çš„å”¯ä¸€å˜é‡,é™¤éæ‚¨ç‰¹åˆ«éœ€è¦å…¶ä»–å˜é‡ä¹‹ä¸€çš„è¯­ä¹‰.</p>
<p>å˜é‡ <code>$host</code> æ˜¯è¯·æ±‚è¡Œæˆ–httpå¤´ä¸­çš„ä¸»æœºå. å˜é‡ <code>$server_name</code> æ˜¯æˆ‘ä»¬å½“å‰æ‰€åœ¨çš„æœåŠ¡å™¨å—çš„åç§°.</p>
</blockquote>
<blockquote>
<p>åŒºåˆ«:</p>
<ul>
<li><code>$host</code> åŒ…å«â€æŒ‰æ­¤ä¼˜å…ˆé¡ºåº:è¯·æ±‚è¡Œä¸­çš„ä¸»æœºå,æˆ–â€ä¸»æœºâ€è¯·æ±‚æ ‡å¤´å­—æ®µä¸­çš„ä¸»æœºå,æˆ–ä¸è¯·æ±‚åŒ¹é…çš„æœåŠ¡å™¨åâ€</li>
<li>å¦‚æœè¯·æ±‚ä¸­åŒ…å«HTTPä¸»æœºæ ‡å¤´å­—æ®µ,åˆ™ <code>$http_host</code> åŒ…å«è¯¥å†…å®¹(å§‹ç»ˆç­‰äºHTTP_HOSTè¯·æ±‚æ ‡å¤´)</li>
<li><code>$server_name</code> åŒ…å«äº†å¤„ç†è¯·æ±‚çš„è™šæ‹Ÿä¸»æœºçš„ <code>server_name</code>,æ­£å¦‚å®ƒåœ¨ Nginx é…ç½®ä¸­å®šä¹‰çš„é‚£æ ·.å¦‚æœä¸€ä¸ªæœåŠ¡å™¨æœ‰å¤šä¸ªæœåŠ¡å™¨å,è¿™ä¸ªå˜é‡ä¸­åªä¼šæœ‰ç¬¬ä¸€ä¸ª.</li>
</ul>
</blockquote>
<blockquote>
<p><code>$http_host</code> æ¯” <code>$host:$server_port</code> æ›´å¥½,å› ä¸ºå®ƒä½¿ç”¨çš„æ˜¯ URL ä¸­å‡ºç°çš„ç«¯å£å·,è€Œä¸æ˜¯ Nginx ç›‘å¬çš„ç«¯å£å·,åè€…æ˜¯ <code>$server_port</code> ä½¿ç”¨çš„ç«¯å£.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_set_header</span>    Host    <span class="variable">$host</span>;</span><br></pre></td></tr></table></figure>

<h3 id="æ­£ç¡®è®¾ç½®-X-Forwarded-For-å¤´çš„å€¼"><a href="#æ­£ç¡®è®¾ç½®-X-Forwarded-For-å¤´çš„å€¼" class="headerlink" title="æ­£ç¡®è®¾ç½® X-Forwarded-For å¤´çš„å€¼"></a>æ­£ç¡®è®¾ç½® <code>X-Forwarded-For</code> å¤´çš„å€¼</h3><h4 id="Rationale"><a href="#Rationale" class="headerlink" title="Rationale"></a>Rationale</h4><blockquote>
<p>â€‹	é‰´äºæœ€æ–°çš„httpoxyæ¼æ´,ç¡®å®éœ€è¦ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹æ¥æ­£ç¡®ä½¿ç”¨ <code>HTTP_X_FORWARDED_FOR</code>. </p>
<p>â€‹	ç®€è€Œè¨€ä¹‹,è´Ÿè½½å‡è¡¡å™¨è®¾ç½®å¤´ä¿¡æ¯ä¸­çš„â€™æœ€æ–°â€™éƒ¨åˆ†.æˆ‘è®¤ä¸º,å‡ºäºå®‰å…¨åŸå› ,ç®¡ç†å‘˜å¿…é¡»æ‰‹åŠ¨æŒ‡å®šä»£ç†æœåŠ¡å™¨.</p>
</blockquote>
<blockquote>
<p>â€‹	<code>X-Forwarded-For</code> æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„HTTPå¤´éƒ¨,å®ƒæºå¸¦äº†å®¢æˆ·ç«¯çš„åŸå§‹IPåœ°å€,è¿™æ ·ç«¯ç‚¹çš„åº”ç”¨ç¨‹åºå°±èƒ½çŸ¥é“è¿™ä¸ªåœ°å€æ˜¯ä»€ä¹ˆ.</p>
<p>â€‹	å¦åˆ™,å®ƒåªä¼šçœ‹åˆ°ä»£ç†çš„IPåœ°å€,è¿™å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›åº”ç”¨ç¨‹åºå‡ºç°é—®é¢˜</p>
</blockquote>
<blockquote>
<p>â€‹	<code>X-Forwarded-For</code> å–å†³äºä»£ç†æœåŠ¡å™¨,å®ƒåº”è¯¥ä¼ é€’è¿æ¥åˆ°å®ƒçš„å®¢æˆ·ç«¯çš„IPåœ°å€.</p>
<p>â€‹	å½“è¿æ¥é€šè¿‡ä¸€ç³»åˆ—ä»£ç†æœåŠ¡å™¨æ—¶,<code>X-Forwarded-For</code> å¯ä»¥æä¾›ä¸€ä¸ªä»¥é€—å·åˆ†éš”çš„IPåœ°å€åˆ—è¡¨,å…¶ä¸­ç¬¬ä¸€ä¸ªåœ°å€æ˜¯æœ€è¿œçš„ä¸‹æ¸¸(å³ç”¨æˆ·). </p>
<p>â€‹	æ­£å› ä¸ºå¦‚æ­¤,ä½äºä»£ç†æœåŠ¡å™¨åé¢çš„æœåŠ¡å™¨éœ€è¦çŸ¥é“å“ªäº›ä»£ç†æœåŠ¡å™¨æ˜¯å¯ä¿¡çš„.</p>
</blockquote>
<blockquote>
<p>â€‹	ä½¿ç”¨çš„ä»£ç†å¯ä»¥å°†æ­¤å¤´è®¾ç½®ä¸ºå…¶å¸Œæœ›çš„ä»»ä½•å€¼,å› æ­¤æ‚¨ä¸èƒ½ä¿¡ä»»å®ƒçš„å€¼.å°½ç®¡å¤§å¤šæ•°ä»£ç†ç¡®å®è®¾ç½®äº†æ­£ç¡®çš„å€¼.</p>
<p>â€‹	è¿™ä¸ªå¤´éƒ¨ä¸»è¦è¢«ç¼“å­˜ä»£ç†ä½¿ç”¨,åœ¨è¿™äº›æƒ…å†µä¸‹,æ‚¨æ§åˆ¶ç€ä»£ç†,å› æ­¤å¯ä»¥éªŒè¯å®ƒæä¾›ç»™æ‚¨çš„ä¿¡æ¯æ˜¯å¦æ­£ç¡®.</p>
<p>â€‹	åœ¨æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹,å®ƒçš„å€¼åº”è¢«è§†ä¸ºä¸å¯ä¿¡çš„.</p>
</blockquote>
<blockquote>
<p>â€‹	ä¸€äº›ç³»ç»Ÿä¹Ÿä½¿ç”¨ <code>X-Forwarded-For</code> æ¥æ‰§è¡Œè®¿é—®æ§åˆ¶.è®¸å¤šåº”ç”¨ç¨‹åºä¾èµ–äºçŸ¥é“å®¢æˆ·ç«¯çš„å®é™…IPåœ°å€æ¥å¸®åŠ©é˜²æ­¢æ¬ºè¯ˆå’Œå¯ç”¨è®¿é—®æƒé™.</p>
<p>â€‹	<code>X-Forwarded-For</code> å¤´éƒ¨å­—æ®µçš„å€¼å¯ä»¥åœ¨å®¢æˆ·ç«¯è®¾ç½® - è¿™ä¹Ÿå¯ä»¥è¢«ç§°ä¸º <code>X-Forwarded-For</code> ä¼ªé€ .ç„¶è€Œ,å½“é€šè¿‡ä»£ç†æœåŠ¡å™¨å‘å‡ºwebè¯·æ±‚æ—¶,ä»£ç†æœåŠ¡å™¨é€šè¿‡é™„åŠ å®¢æˆ·ç«¯(ç”¨æˆ·)çš„IPåœ°å€ä¿®æ”¹ <code>X-Forwarded-For</code> å­—æ®µ.è¿™å°†åœ¨ <code>X-Forwarded-For</code> å­—æ®µä¸­äº§ç”Ÿ2ä¸ªé€—å·åˆ†éš”çš„IPåœ°å€.</p>
<p>â€‹	åå‘ä»£ç†ä¸æ˜¯æºIPåœ°å€é€æ˜çš„.å½“ä½ éœ€è¦åç«¯æœåŠ¡å™¨çš„æ—¥å¿—ä¸­çš„å®¢æˆ·ç«¯æºIPåœ°å€æ˜¯æ­£ç¡®çš„æ—¶,è¿™æ˜¯ä¸€ä¸ªé—®é¢˜.æˆ‘è®¤ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜çš„æœ€ä½³æ–¹æ¡ˆæ˜¯é…ç½®è´Ÿè½½å‡è¡¡å™¨æ·»åŠ &#x2F;ä¿®æ”¹å¸¦æœ‰å®¢æˆ·ç«¯æºIPçš„ <code>X-Forwarded-For</code> å¤´,å¹¶ä»¥æ­£ç¡®çš„å½¢å¼è½¬å‘ç»™åç«¯.</p>
<p>â€‹	ä¸å¹¸çš„æ˜¯,åœ¨ä»£ç†ç«¯æˆ‘ä»¬æ— æ³•è§£å†³è¿™ä¸ªé—®é¢˜(æ‰€æœ‰è§£å†³æ–¹æ¡ˆéƒ½å¯èƒ½è¢«ä¼ªé€ ),é‡è¦çš„æ˜¯è¿™ä¸ªå¤´è¢«åº”ç”¨æœåŠ¡å™¨æ­£ç¡®è§£é‡Š.è¿™æ ·åšç¡®ä¿äº†åº”ç”¨ç¨‹åºæˆ–ä¸‹æ¸¸æœåŠ¡æ‹¥æœ‰å‡†ç¡®çš„ä¿¡æ¯æ¥è¿›è¡Œå†³ç­–,åŒ…æ‹¬é‚£äº›å…³äºè®¿é—®å’Œæˆæƒçš„å†³ç­–.</p>
</blockquote>
<p>ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µ,æˆ‘ä»¬å¿…é¡»é»˜è®¤ä¸ä¿¡ä»»é‚£ä¸ªå¤´éƒ¨,å¹¶ä»æˆ‘ä»¬çš„æœåŠ¡å™¨å‘åè¿½è¸ªIPåœ°å€:</p>
<blockquote>
<p>â€‹	é¦–å…ˆæˆ‘ä»¬éœ€è¦ç¡®ä¿ <code>REMOTE_ADDR</code> æ˜¯æˆ‘ä»¬ä¿¡ä»»çš„,æœ‰èƒ½åŠ›åœ¨ <code>X-Forwarded-For</code> çš„æœ«å°¾è¿½åŠ äº†ä¸€ä¸ªæ­£ç¡®çš„å€¼.å¦‚æœæ˜¯è¿™æ ·,é‚£ä¹ˆæˆ‘ä»¬éœ€è¦ç¡®ä¿æˆ‘ä»¬ä¿¡ä»» <code>X-Forwarded-For</code> ä¸­çš„IP,ä¿¡ä»»å®ƒåœ¨è‡ªå·±ä¹‹å‰è¿½åŠ äº†æ­£ç¡®çš„IP,ä¾æ­¤ç±»æ¨.ç›´åˆ°æœ€å,æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªæˆ‘ä»¬ä¸ä¿¡ä»»çš„IP,åœ¨é‚£ä¸€ç‚¹ä¸Šæˆ‘ä»¬å¿…é¡»å‡è®¾é‚£æ˜¯æˆ‘ä»¬ç”¨æˆ·çš„IP.- è¿™ä¸ªè§‚ç‚¹æ¥è‡ª<a target="_blank" rel="noopener" href="https://github.com/xyu">Xiao Yu</a>åœ¨<a target="_blank" rel="noopener" href="https://xyu.io/2013/07/04/proxies-ip-spoofing/">ä»£ç†å’ŒIPæ¬ºéª—</a>ä¸­çš„è§‚ç‚¹.</p>
</blockquote>
<h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®ƒå­˜åœ¨çš„æ•´ä¸ªç›®çš„æ˜¯ä¸ºäº†æ‰§è¡Œè¿½åŠ è¡Œä¸º:</span></span><br><span class="line"><span class="attribute">proxy_set_header</span>    X-Forwarded-For    <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"><span class="comment"># ä¸Šé¢çš„è®¾ç½®ç­‰åŒäºè¿™ä¸ª:</span></span><br><span class="line"><span class="attribute">proxy_set_header</span>    X-Forwarded-For    <span class="variable">$http_x_forwarded_for</span>,<span class="variable">$remote_addr</span>;</span><br><span class="line"><span class="comment"># ä¸‹é¢çš„è®¾ç½®ä¹Ÿå’Œä¸Šé¢çš„ç­‰åŒ,ä½†åœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬ä½¿ç”¨äº† http_realip_module:</span></span><br><span class="line"><span class="attribute">proxy_set_header</span>    X-Forwarded-For    <span class="string">&quot;<span class="variable">$http_x_forwarded_for</span>, <span class="variable">$realip_remote_addr</span>&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="ä¸è¦åœ¨åå‘ä»£ç†åé¢ä½¿ç”¨å¸¦æœ‰-scheme-çš„-X-Forwarded-Proto"><a href="#ä¸è¦åœ¨åå‘ä»£ç†åé¢ä½¿ç”¨å¸¦æœ‰-scheme-çš„-X-Forwarded-Proto" class="headerlink" title="ä¸è¦åœ¨åå‘ä»£ç†åé¢ä½¿ç”¨å¸¦æœ‰ $scheme çš„ X-Forwarded-Proto"></a>ä¸è¦åœ¨åå‘ä»£ç†åé¢ä½¿ç”¨å¸¦æœ‰ <code>$scheme</code> çš„ <code>X-Forwarded-Proto</code></h3><blockquote>
<p>åå‘ä»£ç†å¯ä»¥è®¾ç½® <code>X-Forwarded-Proto</code>,ä»¥å‘ŠçŸ¥åº”ç”¨ç¨‹åºå®ƒæ˜¯HTTPSè¿˜æ˜¯HTTPç”šè‡³æ˜¯æ— æ•ˆåç§°.schema å˜é‡ä»…åœ¨éœ€è¦çš„æ—¶å€™æ‰ä¼šè¢«è¯„ä¼°(ä»…ç”¨äºå½“å‰è¯·æ±‚).</p>
<p>å¦‚æœè®¾ç½®äº† $schema å˜é‡ä¸”æ²¿é€”é‡ä¸Šå¤šä¸ªä»£ç†,åˆ™ä¼šå¯¼è‡´å˜å½¢.ä¾‹å¦‚:å¦‚æœå®¢æˆ·ç«¯è½¬åˆ°<a target="_blank" rel="noopener" href="https://example.com,åˆ™ä»£ç†å°†æ–¹æ¡ˆå€¼å­˜å‚¨ä¸ºhttps/">https://example.com,åˆ™ä»£ç†å°†æ–¹æ¡ˆå€¼å­˜å‚¨ä¸ºHTTPS</a>. å¦‚æœä»£ç†ä¸ä¸‹ä¸€çº§ä»£ç†ä¹‹é—´çš„é€šä¿¡æ˜¯é€šè¿‡HTTPè¿›è¡Œçš„,åˆ™åç«¯ä¼šå°†æ–¹æ¡ˆè§†ä¸ºHTTP.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1) å®¢æˆ·ç«¯ &lt;-&gt; ä»£ç† &lt;-&gt; åç«¯</span></span><br><span class="line"><span class="attribute">proxy_set_header</span>    X-Forwarded-Proto  <span class="variable">$scheme</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) å®¢æˆ·ç«¯ &lt;-&gt; ä»£ç† &lt;-&gt; ä»£ç† &lt;-&gt; åç«¯</span></span><br><span class="line"><span class="comment"># åœ¨ç¬¬äºŒå±‚ä»£ç†ä¸­è®¾ç½®X-Forwarded-Protoå¤´ä¸ºhttpsæ—¶å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ³¨é‡Šæ‰çš„æŒ‡ä»¤</span></span><br><span class="line"><span class="comment"># proxy_set_header  X-Forwarded-Proto  https;</span></span><br><span class="line"><span class="comment"># ä½†æ˜¯,ä¸ºäº†ä¿æŒä¸ç¬¬ä¸€å±‚ä»£ç†æ¥æ”¶åˆ°çš„schemeä¸€è‡´,æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„æŒ‡ä»¤</span></span><br><span class="line"><span class="attribute">proxy_set_header</span>    X-Forwarded-Proto  <span class="variable">$proxy_x_forwarded_proto</span>;</span><br></pre></td></tr></table></figure>

<h4 id="å§‹ç»ˆå°†-Host-X-Real-IP-å’Œ-X-Forwarded-æ ‡å¤´ä¼ é€’ç»™åç«¯"><a href="#å§‹ç»ˆå°†-Host-X-Real-IP-å’Œ-X-Forwarded-æ ‡å¤´ä¼ é€’ç»™åç«¯" class="headerlink" title="å§‹ç»ˆå°† Host,X-Real-IP å’Œ X-Forwarded æ ‡å¤´ä¼ é€’ç»™åç«¯"></a>å§‹ç»ˆå°† Host,X-Real-IP å’Œ X-Forwarded æ ‡å¤´ä¼ é€’ç»™åç«¯</h4><h4 id="Rationale-1"><a href="#Rationale-1" class="headerlink" title="Rationale"></a>Rationale</h4><blockquote>
<p>â€‹	åœ¨ä½¿ç”¨Nginxä½œä¸ºåå‘ä»£ç†æ—¶,ä½ å¯èƒ½å¸Œæœ›å°†è¿œç¨‹å®¢æˆ·ç«¯çš„ä¸€äº›ä¿¡æ¯ä¼ é€’ç»™ä½ çš„åç«¯WebæœåŠ¡å™¨.æˆ‘è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå¥½åšæ³•,å› ä¸ºå®ƒèƒ½è®©ä½ æ›´å¥½åœ°æ§åˆ¶è½¬å‘çš„å¤´éƒ¨ä¿¡æ¯.</p>
<p>â€‹	è¿™å¯¹äºä½äºä»£ç†åé¢çš„æœåŠ¡å™¨æ¥è¯´éå¸¸é‡è¦,å› ä¸ºå®ƒå…è®¸æ­£ç¡®åœ°è§£é‡Šå®¢æˆ·ç«¯.ä»£ç†æ˜¯è¿™äº›æœåŠ¡å™¨çš„â€çœ¼ç›â€,å®ƒä»¬ä¸åº”å…è®¸å¯¹ç°å®çš„æ‰­æ›²æ„ŸçŸ¥.å¦‚æœå¹¶éæ‰€æœ‰è¯·æ±‚éƒ½é€šè¿‡ä»£ç†,é‚£ä¹ˆç›´æ¥ä»å®¢æˆ·ç«¯æ”¶åˆ°çš„è¯·æ±‚å¯èƒ½åŒ…å«ä¾‹å¦‚ä¸å‡†ç¡®çš„å¤´éƒ¨ä¸­çš„IPåœ°å€.</p>
<p>â€‹	<code>X-Forwarded</code>å¤´éƒ¨å¯¹äºç»Ÿè®¡æˆ–è¿‡æ»¤ä¹Ÿå¾ˆé‡è¦.å¦ä¸€ä¸ªä¾‹å­å¯èƒ½æ˜¯ä½ çš„åº”ç”¨ä¸­çš„è®¿é—®æ§åˆ¶è§„åˆ™,å› ä¸ºå¦‚æœæ²¡æœ‰è¿™äº›å¤´éƒ¨,è¿‡æ»¤æœºåˆ¶å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œ.</p>
<p>â€‹	å¦‚æœä½ ä½¿ç”¨åƒApacheè¿™æ ·çš„å‰ç«¯æœåŠ¡ä½œä¸ºä½ çš„APIçš„å‰ç«¯,ä½ å°†éœ€è¦è¿™äº›å¤´éƒ¨æ¥ç†è§£è¿æ¥APIæ—¶ä½¿ç”¨çš„IPæˆ–ä¸»æœºå.</p>
<p>â€‹	å¦‚æœä½ ä½¿ç”¨httpsåè®®(ç°åœ¨å·²ç»æˆä¸ºæ ‡å‡†),è½¬å‘è¿™äº›å¤´éƒ¨ä¹Ÿå¾ˆé‡è¦.</p>
<p>â€‹	ç„¶è€Œ,æˆ‘ä¸ä¼šå®Œå…¨ä¾èµ–äºæ‰€æœ‰<code>X-Forwarded</code>å¤´éƒ¨çš„å­˜åœ¨,æˆ–è€…ä»–ä»¬æ•°æ®çš„æœ‰æ•ˆæ€§.</p>
</blockquote>
<h4 id="Example-1"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">proxy_pass</span>          http://bk_upstream_01;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ä»¥ä¸‹å¤´éƒ¨ä¹Ÿåº”ä¼ é€’ç»™åç«¯:</span></span><br><span class="line">  <span class="comment">#   - Host - æ¥è‡ªè¯·æ±‚è¡Œçš„ä¸»æœºå,æˆ–æ¥è‡ªHostè¯·æ±‚å¤´å­—æ®µçš„ä¸»æœºå,æˆ–åŒ¹é…è¯·æ±‚çš„æœåŠ¡å™¨å</span></span><br><span class="line">  <span class="comment"># proxy_set_header  Host               $host:$server_port;</span></span><br><span class="line">  <span class="comment"># proxy_set_header  Host               $http_host;</span></span><br><span class="line">  <span class="attribute">proxy_set_header</span>    Host               <span class="variable">$host</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">#   - X-Real-IP - å°†è®¿é—®è€…çš„å®é™…è¿œç¨‹IPåœ°å€è½¬å‘ç»™è¢«ä»£ç†çš„æœåŠ¡å™¨</span></span><br><span class="line">  <span class="attribute">proxy_set_header</span>    X-Real-IP          <span class="variable">$remote_addr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># X-Forwardedå¤´éƒ¨å †æ ˆ:</span></span><br><span class="line">  <span class="comment">#   - X-Forwarded-For - æ ‡è®°é€šè¿‡ä»£ç†è¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯çš„åŸå§‹IP</span></span><br><span class="line">  <span class="comment"># proxy_set_header  X-Forwarded-For    $remote_addr;</span></span><br><span class="line">  <span class="comment"># proxy_set_header  X-Forwarded-For    $http_x_forwarded_for,$remote_addr;</span></span><br><span class="line">  <span class="comment"># proxy_set_header  X-Forwarded-For    &quot;$http_x_forwarded_for, $realip_remote_addr&quot;;</span></span><br><span class="line">  <span class="attribute">proxy_set_header</span>    X-Forwarded-For    <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">#   - X-Forwarded-Host - æ ‡è®°é€šè¿‡ä»£ç†è¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯çš„åŸå§‹ä¸»æœº</span></span><br><span class="line">  <span class="comment"># proxy_set_header  X-Forwarded-Host   $host:443;</span></span><br><span class="line">  <span class="attribute">proxy_set_header</span>    X-Forwarded-Host   <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">#   - X-Forwarded-Server - ä»£ç†æœåŠ¡å™¨çš„ä¸»æœºå</span></span><br><span class="line">  <span class="attribute">proxy_set_header</span>    X-Forwarded-Server <span class="variable">$host</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">#   - X-Forwarded-Port - å®šä¹‰å®¢æˆ·ç«¯è¯·æ±‚çš„åŸå§‹ç«¯å£</span></span><br><span class="line">  <span class="comment"># proxy_set_header  X-Forwarded-Port   443;</span></span><br><span class="line">  <span class="attribute">proxy_set_header</span>    X-Forwarded-Port   <span class="variable">$server_port</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">#   - X-Forwarded-Proto - æ ‡è®°é€šè¿‡ä»£ç†è¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯çš„åè®®</span></span><br><span class="line">  <span class="comment"># proxy_set_header  X-Forwarded-Proto  https;</span></span><br><span class="line">  <span class="comment"># proxy_set_header  X-Forwarded-Proto  $proxy_x_forwarded_proto;</span></span><br><span class="line">  <span class="attribute">proxy_set_header</span>    X-Forwarded-Proto  <span class="variable">$scheme</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="prefix-ä½¿ç”¨ä¸å¸¦-X-å‰ç¼€çš„è‡ªå®šä¹‰å¤´"><a href="#prefix-ä½¿ç”¨ä¸å¸¦-X-å‰ç¼€çš„è‡ªå®šä¹‰å¤´" class="headerlink" title="prefix ä½¿ç”¨ä¸å¸¦ X- å‰ç¼€çš„è‡ªå®šä¹‰å¤´"></a>prefix ä½¿ç”¨ä¸å¸¦ <code>X-</code> å‰ç¼€çš„è‡ªå®šä¹‰å¤´</h3><h4 id="Rationale-2"><a href="#Rationale-2" class="headerlink" title="Rationale"></a>Rationale</h4><blockquote>
<p>â€‹	äº’è”ç½‘å·¥ç¨‹ä»»åŠ¡ç»„(IETF)å‘å¸ƒäº†ä¸€ä¸ªæ–°çš„RFC(<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6648">RFC-6648</a>),å»ºè®®å¼ƒç”¨<code>X-</code>å‰ç¼€.</p>
<p>â€‹	<code>X-</code>å‰ç¼€åœ¨å¤´éƒ¨åç§°å‰é€šå¸¸è¡¨ç¤ºå®ƒæ˜¯å®éªŒæ€§çš„ã€éæ ‡å‡†çš„æˆ–ç‰¹å®šäºä¾›åº”å•†çš„.ä¸€æ—¦å®ƒæˆä¸ºHTTPçš„æ ‡å‡†éƒ¨åˆ†,å°±ä¼šå¤±å»è¿™ä¸ªå‰ç¼€.</p>
<p>â€‹	å¦‚æœæœ‰å¯èƒ½å°†æ–°çš„è‡ªå®šä¹‰å¤´éƒ¨æ ‡å‡†åŒ–,è¯·ä½¿ç”¨ä¸€ä¸ªæœªè¢«ä½¿ç”¨ä¸”æœ‰æ„ä¹‰çš„å¤´éƒ¨åç§°.</p>
<p>â€‹	ä½¿ç”¨å¸¦æœ‰<code>X-</code>å‰ç¼€çš„è‡ªå®šä¹‰å¤´éƒ¨å¹¶ä¸ç¦æ­¢,ä½†æ˜¯ä¸é¼“åŠ±.æ¢å¥è¯è¯´,ä½ å¯ä»¥ç»§ç»­ä½¿ç”¨å¸¦æœ‰<code>X-</code>å‰ç¼€çš„å¤´éƒ¨,ä½†ä¸æ¨èè¿™æ ·åš,å¹¶ä¸”ä½ ä¸åº”è¯¥å°†å®ƒä»¬è®°å½•ä¸ºå…¬å…±æ ‡å‡†.</p>
</blockquote>
<h4 id="Example-2"><a href="#Example-2" class="headerlink" title="Example"></a>Example</h4><p>ä¸æ¨èçš„é…ç½®:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">add_header</span> X-Backend-Server <span class="variable">$hostname</span>;</span><br></pre></td></tr></table></figure>

<p>æ¨èçš„é…ç½®:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">add_header</span> Backend-Server   <span class="variable">$hostname</span>;</span><br></pre></td></tr></table></figure>

<h2 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h2><p>è´Ÿè½½å¹³è¡¡æ˜¯ä¸€ç§æœ‰ç”¨çš„æœºåˆ¶,å¯å°†ä¼ å…¥çš„æµé‡åˆ†å¸ƒåœ¨å‡ ä¸ªæœ‰èƒ½åŠ›çš„æœåŠ¡å™¨ä¹‹é—´.</p>
<h3 id="å¥åº·æ£€æŸ¥"><a href="#å¥åº·æ£€æŸ¥" class="headerlink" title="å¥åº·æ£€æŸ¥"></a>å¥åº·æ£€æŸ¥</h3><blockquote>
<p>å¥åº·ç›‘æ§å¯¹äºæ‰€æœ‰ç±»å‹çš„è´Ÿè½½å¹³è¡¡éƒ½éå¸¸é‡è¦,ä¸»è¦æ˜¯ä¸ºäº†ä¸šåŠ¡è¿ç»­æ€§. è¢«åŠ¨æ£€æŸ¥ä¼šæŒ‰ç…§å®¢æˆ·ç«¯çš„è¯·æ±‚ç›‘è§†é€šè¿‡ Nginx çš„è¿æ¥å¤±è´¥æˆ–è¶…æ—¶.</p>
<p>é»˜è®¤æƒ…å†µä¸‹å¯ç”¨æ­¤åŠŸèƒ½,ä½†æ˜¯æ­¤å¤„æåˆ°çš„å‚æ•°å…è®¸æ‚¨è°ƒæ•´å…¶è¡Œä¸º. é»˜è®¤å€¼ä¸º:<code>max_fails = 1</code> å’Œ <code>fail_timeout = 10s</code>.</p>
</blockquote>
<p>ç¤ºä¾‹:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">  <span class="attribute">server</span> bk01_node:<span class="number">80</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">5s</span>;</span><br><span class="line">  <span class="attribute">server</span> bk02_node:<span class="number">80</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">5s</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="down-å‚æ•°"><a href="#down-å‚æ•°" class="headerlink" title="down å‚æ•°"></a>down å‚æ•°</h3><blockquote>
<p>æœ‰æ—¶æˆ‘ä»¬éœ€è¦å…³é—­åç«¯,ä¾‹å¦‚ åœ¨ç»´æŠ¤æ—¶. æˆ‘è®¤ä¸ºè‰¯å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ down å‚æ•°å°†æœåŠ¡å™¨æ ‡è®°ä¸ºæ°¸ä¹…ä¸å¯ç”¨,å³ä½¿åœæœºæ—¶é—´å¾ˆçŸ­ä¹Ÿæ˜¯å¦‚æ­¤.</p>
<p>å¦‚æœæ‚¨ä½¿ç”¨ IP å“ˆå¸Œè´Ÿè½½å¹³è¡¡æŠ€æœ¯,é‚£ä¹Ÿå¾ˆé‡è¦. å¦‚æœå…¶ä¸­ä¸€å°æœåŠ¡å™¨éœ€è¦ä¸´æ—¶åˆ é™¤,åˆ™åº”ä½¿ç”¨æ­¤å‚æ•°è¿›è¡Œæ ‡è®°,ä»¥ä¿ç•™å®¢æˆ·ç«¯ IP åœ°å€çš„å½“å‰å“ˆå¸Œå€¼.</p>
<p>æ³¨é‡Šå¯¹äºçœŸæ­£æ°¸ä¹…ç¦ç”¨æœåŠ¡å™¨æˆ–è¦å‡ºäºå†å²ç›®çš„è€Œä¿ç•™ä¿¡æ¯éå¸¸æœ‰ç”¨.</p>
<p>Nginx è¿˜æä¾›äº†ä¸€ä¸ªå¤‡ä»½å‚æ•°,å°†è¯¥æœåŠ¡å™¨æ ‡è®°ä¸ºå¤‡ä»½æœåŠ¡å™¨. å½“ä¸»æœåŠ¡å™¨ä¸å¯ç”¨æ—¶,å°†ä¼ é€’è¯·æ±‚. ä»…å½“æˆ‘ç¡®å®šåç«¯å°†åœ¨ç»´æŠ¤æ—¶æ­£å¸¸å·¥ä½œæ—¶,æˆ‘æ‰å¾ˆå°‘å°†æ­¤é€‰é¡¹ç”¨äºä¸Šè¿°ç›®çš„.</p>
</blockquote>
<h4 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">  <span class="attribute">server</span> bk01_node:<span class="number">80</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">5s</span> down;</span><br><span class="line">  <span class="attribute">server</span> bk02_node:<span class="number">80</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">5s</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å®‰å…¨"><a href="#å®‰å…¨" class="headerlink" title="å®‰å…¨"></a>å®‰å…¨</h2><h3 id="é˜²ç›—é“¾"><a href="#é˜²ç›—é“¾" class="headerlink" title="é˜²ç›—é“¾"></a>é˜²ç›—é“¾</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> <span class="regexp">~* \.(gif|jpg|png)$</span> &#123;</span><br><span class="line">    <span class="comment"># åªå…è®¸ 192.168.0.1 è¯·æ±‚èµ„æº</span></span><br><span class="line">    <span class="attribute">valid_referers</span> <span class="literal">none</span> <span class="literal">blocked</span> <span class="number">192.168.0.1</span>;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">       <span class="attribute">rewrite</span><span class="regexp"> ^/</span> http://<span class="variable">$host</span>/logo.png;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">å›é¡¾ä¸Šä¸€ç¯‡</div><a href="/wiki/MiddlewareDocs/%E4%B8%80.%20Nginx%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A(%E4%B8%8B).html">ä¸€. Nginxä»å…¥é—¨åˆ°ç²¾é€š(ä¸‹)</a></div><div class="item" id="next"><div class="note">æ¥ä¸‹æ¥é˜…è¯»</div><a href="/wiki/MiddlewareDocs/%E4%B8%89.%20Nginx-Examples%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E.html">ä¸‰. Nginx-Examplesä½¿ç”¨è¯´æ˜</a></div></section></div>


  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>å¿«æ¥å‚ä¸è®¨è®ºå§~</p>

    </section>
    <section class='body cmt-body waline'>
      

<div id="waline_container" class="waline_thread"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs15">åšå®¢</span><a href="/">è¿‘æœŸ</a><a href="/categories/">åˆ†ç±»</a><a href="/tags/">æ ‡ç­¾</a><a href="/archives/">å½’æ¡£</a><a href="/tools/">å·¥å…·</a></div><div class="sitemap-group"><span class="fs15">ç¬”è®°</span><a href="/wiki/tags/DevOps/index.html">DevOps</a><a href="/wiki/tags/Vulnerability/index.html">å¸¸è§æ¼æ´åˆ†æ</a><a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">ç¼–ç¨‹è¯­è¨€</a></div><div class="sitemap-group"><span class="fs15">ç¤¾äº¤</span><a href="/friends/">å‹é“¾</a><a href="/comments/">ç•™è¨€æ¿</a></div><div class="sitemap-group"><span class="fs15">æ›´å¤š</span><a href="/about/">å…³äºæœ¬ç«™</a><a target="_blank" rel="noopener" href="https://github.com/JiangJiYue">GitHub</a></div></div><div class="text"><center>
  <p>æœ¬ç ´ç«™ç”± <a href="/">@SafeKiller Zone</a> ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> ä¸»é¢˜åˆ›å»ºã€‚<br>æœ¬åšå®¢éƒ¨åˆ†ç´ ææ¥æºäºç½‘ç»œï¼Œå¦‚æœ‰ä¾µæƒè¯·è”ç³»<a href="mailto:jiangjiyue1@gmail.com">jiangjiyue1@gmail.com</a>åˆ é™¤<br>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
  <!--ä¸è’œå­è®¡æ•°å™¨-->
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span>æœ¬"é¡µé¢"è®¿é—® <span id="busuanzi_value_page_pv"></span> æ¬¡ | ğŸ‘€æ€»è®¿é—® <span id="busuanzi_value_site_pv"></span> æ¬¡ | æ€»è®¿å®¢ <span id="busuanzi_value_site_uv"></span> äºº</span>
  <br>
  <span id="runtime_span"></span>
  <script type="text/javascript">
    // JavaScript for showing runtime here
  </script>
</center>
<div style="display: flex;justify-content: center;align-items: center;margin: 10px;">
  <a target="_blank" rel="noopener" href="https://notbyai.fyi/"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/website/Written-By-Human-white.png" style="width:140px;height:50px;margin-right: 10px " id='notbyai'></a>
  <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/website/by-nc-sa.eu.png" style="width:140px;height:50px"></a>
</div>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">æœ¬æ–‡ç›®å½•</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%AE%9E%E4%BE%8B"><span class="toc-text">é…ç½®æ–‡ä»¶å®ä¾‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%A7%84%E5%88%99"><span class="toc-text">åŸºæœ¬è§„åˆ™</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E7%90%86-Nginx-%E9%85%8D%E7%BD%AE"><span class="toc-text">ç®¡ç† Nginx é…ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%8A%A0%E8%BD%BD-Nginx-%E9%85%8D%E7%BD%AE"><span class="toc-text">é‡åŠ è½½ Nginx é…ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E5%90%AC-80-%E5%92%8C-443-%E7%AB%AF%E5%8F%A3"><span class="toc-text">ç›‘å¬ 80 å’Œ 443 ç«¯å£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E6%8C%87%E5%AE%9A%E7%9B%91%E5%90%AC%E7%9A%84%E5%9C%B0%E5%9D%80%E5%92%8C%E7%AB%AF%E5%8F%A3"><span class="toc-text">æ˜¾ç¤ºæŒ‡å®šç›‘å¬çš„åœ°å€å’Œç«¯å£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E6%AD%A2%E4%BD%BF%E7%94%A8%E6%9C%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%8D%E7%A7%B0%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82"><span class="toc-text">é˜²æ­¢ä½¿ç”¨æœªå®šä¹‰çš„æœåŠ¡å™¨åç§°å¤„ç†è¯·æ±‚</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E8%A6%81%E5%9C%A8-listen-%E6%88%96-upstream-%E4%B8%AD%E4%BD%BF%E7%94%A8-hostname"><span class="toc-text">ä¸è¦åœ¨ listen æˆ– upstream ä¸­ä½¿ç”¨ hostname</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E4%BB%A4%E4%B8%AD%E5%8F%AA%E9%85%8D%E7%BD%AE%E4%B8%80%E4%B8%AA-SSL"><span class="toc-text">æŒ‡ä»¤ä¸­åªé…ç½®ä¸€ä¸ª SSL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-geo-map-%E6%A8%A1%E5%9D%97%E6%9B%BF%E4%BB%A3-allow-deny"><span class="toc-text">ä½¿ç”¨ geo&#x2F;map æ¨¡å—æ›¿ä»£ allow&#x2F;deny</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Map-%E6%89%80%E6%9C%89%E4%BA%8B%E7%89%A9"><span class="toc-text">Map æ‰€æœ‰äº‹ç‰©</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E6%89%80%E6%9C%89%E6%9C%AA%E5%8C%B9%E9%85%8D%E7%9A%84%E8%B7%AF%E5%BE%84%E8%AE%BE%E7%BD%AE%E6%A0%B9%E8%B7%AF%E5%BE%84"><span class="toc-text">ä¸ºæ‰€æœ‰æœªåŒ¹é…çš„è·¯å¾„è®¾ç½®æ ¹è·¯å¾„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-return-%E6%8C%87%E4%BB%A4%E8%BF%9B%E8%A1%8C-URL-%E9%87%8D%E5%AE%9A%E5%90%91-301%E3%80%81302"><span class="toc-text">ä½¿ç”¨ return æŒ‡ä»¤è¿›è¡Œ URL é‡å®šå‘(301ã€302)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%97%A5%E5%BF%97%E8%BD%AE%E6%8D%A2%E7%AD%96%E7%95%A5"><span class="toc-text">é…ç½®æ—¥å¿—è½®æ¢ç­–ç•¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E8%A6%81%E9%87%8D%E5%A4%8D%E7%B4%A2%E5%BC%95%E6%8C%87%E4%BB%A4-%E5%8F%AA%E8%83%BD%E5%9C%A8-http-%E5%9D%97%E4%B8%AD%E4%BD%BF%E7%94%A8"><span class="toc-text">ä¸è¦é‡å¤ç´¢å¼•æŒ‡ä»¤,åªèƒ½åœ¨ http å—ä¸­ä½¿ç”¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Debugging"><span class="toc-text">Debugging</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F"><span class="toc-text">ä½¿ç”¨è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%B0%83%E8%AF%95%E6%A8%A1%E5%BC%8F%E6%9D%A5%E8%B7%9F%E8%B8%AA%E6%84%8F%E5%A4%96%E8%A1%8C%E4%B8%BA"><span class="toc-text">ä½¿ç”¨è°ƒè¯•æ¨¡å¼æ¥è·Ÿè¸ªæ„å¤–è¡Œä¸º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E8%BD%AC%E5%82%A8"><span class="toc-text">æ ¸å¿ƒè½¬å‚¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD"><span class="toc-text">æ€§èƒ½</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E8%BF%9B%E7%A8%8B%E6%95%B0"><span class="toc-text">å·¥ä½œè¿›ç¨‹æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E5%A4%A7%E8%BF%9E%E6%8E%A5%E6%95%B0"><span class="toc-text">æœ€å¤§è¿æ¥æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-HTTP-2"><span class="toc-text">ä½¿ç”¨ HTTP&#x2F;2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%B4%E6%8A%A4-SSL-%E4%BC%9A%E8%AF%9D"><span class="toc-text">ç»´æŠ¤ SSL ä¼šè¯</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%BD%E5%8F%AF%E8%83%BD%E5%9C%A8-server-name-%E6%8C%87%E4%BB%A4%E4%B8%AD%E4%BD%BF%E7%94%A8%E7%A1%AE%E5%88%87%E5%90%8D%E7%A7%B0"><span class="toc-text">å°½å¯èƒ½åœ¨ server_name æŒ‡ä»¤ä¸­ä½¿ç”¨ç¡®åˆ‡åç§°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8-if-%E6%A3%80%E6%9F%A5-server-name"><span class="toc-text">é¿å…ä½¿ç”¨ if æ£€æŸ¥ server_name</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-request-uri-%E6%9D%A5%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-text">ä½¿ç”¨ $request_uri æ¥é¿å…ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-try-files-%E6%8C%87%E4%BB%A4%E7%A1%AE%E8%AE%A4%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-text">ä½¿ç”¨ try_files æŒ‡ä»¤ç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-return-%E4%BB%A3%E6%9B%BF-rewrite-%E6%9D%A5%E5%81%9A%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-text">ä½¿ç”¨ return ä»£æ›¿ rewrite æ¥åšé‡å®šå‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AF-PCRE-JIT-%E6%9D%A5%E5%8A%A0%E9%80%9F%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%A4%84%E7%90%86"><span class="toc-text">å¼€å¯ PCRE JIT æ¥åŠ é€Ÿæ­£åˆ™è¡¨è¾¾å¼å¤„ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E8%A1%8C%E7%B2%BE%E7%A1%AE%E7%9A%84%E4%BD%8D%E7%BD%AE%E5%8C%B9%E9%85%8D%E4%BB%A5%E5%8A%A0%E5%BF%AB%E9%80%89%E6%8B%A9%E8%BF%87%E7%A8%8B"><span class="toc-text">è¿›è¡Œç²¾ç¡®çš„ä½ç½®åŒ¹é…ä»¥åŠ å¿«é€‰æ‹©è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-limit-conn-%E6%94%B9%E5%96%84%E5%AF%B9%E4%B8%8B%E8%BD%BD%E9%80%9F%E5%BA%A6%E7%9A%84%E9%99%90%E5%88%B6"><span class="toc-text">ä½¿ç”¨ limit_conn æ”¹å–„å¯¹ä¸‹è½½é€Ÿåº¦çš„é™åˆ¶</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-text">åå‘ä»£ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%B8%8E%E5%90%8E%E7%AB%AF%E5%8D%8F%E8%AE%AE%E5%85%BC%E5%AE%B9%E7%9A%84-pass-%E6%8C%87%E4%BB%A4"><span class="toc-text">ä½¿ç”¨ä¸åç«¯åè®®å…¼å®¹çš„ pass æŒ‡ä»¤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E5%BF%83-proxy-pass-%E6%8C%87%E4%BB%A4%E4%B8%AD%E7%9A%84%E6%96%9C%E6%9D%A0"><span class="toc-text">å°å¿ƒ proxy_pass æŒ‡ä»¤ä¸­çš„æ–œæ </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%85%E4%BD%BF%E7%94%A8-host-%E5%8F%98%E9%87%8F%E8%AE%BE%E7%BD%AE%E5%92%8C%E4%BC%A0%E9%80%92-Host-%E5%A4%B4"><span class="toc-text">ä»…ä½¿ç”¨ $host å˜é‡è®¾ç½®å’Œä¼ é€’ Host å¤´</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E7%A1%AE%E8%AE%BE%E7%BD%AE-X-Forwarded-For-%E5%A4%B4%E7%9A%84%E5%80%BC"><span class="toc-text">æ­£ç¡®è®¾ç½® X-Forwarded-For å¤´çš„å€¼</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Rationale"><span class="toc-text">Rationale</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Example"><span class="toc-text">Example</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E8%A6%81%E5%9C%A8%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%90%8E%E9%9D%A2%E4%BD%BF%E7%94%A8%E5%B8%A6%E6%9C%89-scheme-%E7%9A%84-X-Forwarded-Proto"><span class="toc-text">ä¸è¦åœ¨åå‘ä»£ç†åé¢ä½¿ç”¨å¸¦æœ‰ $scheme çš„ X-Forwarded-Proto</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A7%8B%E7%BB%88%E5%B0%86-Host-X-Real-IP-%E5%92%8C-X-Forwarded-%E6%A0%87%E5%A4%B4%E4%BC%A0%E9%80%92%E7%BB%99%E5%90%8E%E7%AB%AF"><span class="toc-text">å§‹ç»ˆå°† Host,X-Real-IP å’Œ X-Forwarded æ ‡å¤´ä¼ é€’ç»™åç«¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Rationale-1"><span class="toc-text">Rationale</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Example-1"><span class="toc-text">Example</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prefix-%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%B8%A6-X-%E5%89%8D%E7%BC%80%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89%E5%A4%B4"><span class="toc-text">prefix ä½¿ç”¨ä¸å¸¦ X- å‰ç¼€çš„è‡ªå®šä¹‰å¤´</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Rationale-2"><span class="toc-text">Rationale</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Example-2"><span class="toc-text">Example</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">è´Ÿè½½å‡è¡¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-text">å¥åº·æ£€æŸ¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#down-%E5%8F%82%E6%95%B0"><span class="toc-text">down å‚æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-text">ç¤ºä¾‹</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8"><span class="toc-text">å®‰å…¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E7%9B%97%E9%93%BE"><span class="toc-text">é˜²ç›—é“¾</span></a></li></ol></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>å›åˆ°é¡¶éƒ¨</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `åˆšåˆš`,
      min: `åˆ†é’Ÿå‰`,
      hour: `å°æ—¶å‰`,
      day: `å¤©å‰`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"codeblock":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.9/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.9/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // æ‡’åŠ è½½ css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // é»˜è®¤å¼‚æ­¥ï¼Œå¦‚æœéœ€è¦åŒæ­¥ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ {} å³å¯
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 ç­‰å¾… 1 å®Œæˆ 2 è¶…æ—¶
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('è¯·æ±‚è¶…æ—¶');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>

<!-- required -->
<script src="/js/main.js?v=1.27.0" async></script>

<!-- optional -->

  <script type="module">
  import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js'

  function load_comment(){
    if(!document.getElementById("waline_container"))return;

    utils.css('https://unpkg.com/@waline/client@v3/dist/waline.css');
    utils.css('https://gcore.jsdelivr.net/npm/@waline/client@3.1.2/dist/waline-meta.css');

    const el = document.getElementById("waline_container");
    var path = el.getAttribute('comment_id');
    if (!path) {
      path = decodeURI(window.location.pathname);
    }

    const waline = init(Object.assign({"js":"https://unpkg.com/@waline/client@v3/dist/waline.js","css":"https://unpkg.com/@waline/client@v3/dist/waline.css","meta_css":"https://gcore.jsdelivr.net/npm/@waline/client@3.1.2/dist/waline-meta.css","serverURL":"https://www.regret.live","commentCount":true,"pageview":false,"locale":{"placeholder":"æœ‰ä»€ä¹ˆæƒ³è¯´çš„ï¼Ÿå¤§èƒ†è¯´å‡ºæ¥å§(*^_^*)","reactionTitle":"è¯·ç»™è¿™ç¯‡æ–‡ç« åšä¸ªè¯„ä»·å§","reaction0":"æ„Ÿå…´è¶£","reaction1":"ç»™å¿ƒå¿ƒ","reaction2":"ä»€ä¹ˆï¼Ÿ","reaction3":"å¿ƒç¢äº†","reaction4":"åˆ«è¿‡æ¥","reaction5":"çŸ®æ²¹~","reaction6":"ä¸å¿ç›´è§†","reaction7":"æˆ‘çœŸç”Ÿæ°”è¾£ï¼","reaction8":"æ‘‡æ™ƒ","level0":"æ½œæ°´","level1":"å†’æ³¡","level2":"åæ§½","level3":"æ´»è·ƒ","level4":"è¯ç—¨","level5":"ä¼ è¯´"},"reaction":["/emojis/ablobcatattentionreverse.png","/emojis/ablobcatheart.png","/emojis/ablobcatdoubt.png","/emojis/ablobcatheartbroken.png","/emojis/ablobcatterrified.png","/emojis/ablobcatshy.png","/emojis/ablobcatnoface.png","/emojis/ablobcatanger.gif","/emojis/ablobcatrainbow.png"],"emoji":["https://gcore.jsdelivr.net/gh/norevi/waline-blobcatemojis@1.0/blobs"]}, {
      el: '#waline_container',
      path: path,
      
    }));

  }
  window.addEventListener('DOMContentLoaded', (event) => {
    load_comment();
  });

</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.swiper-slide img, .gallery img ,#waline_container .vcontent img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || null
        }
      });
    })
  }
</script><script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          loop: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script><script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `å¤åˆ¶æˆåŠŸ`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->
<script type="text/javascript" src="/js/darkmode.js"></script>
</div></body></html>
